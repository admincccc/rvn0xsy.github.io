<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>一个暂时没有名字的项目 « 倾旋的博客</title>
  <meta name="description" content="一个暂时没有名字的项目">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/archivers/2017-10-23/1">
  <link rel="alternate" type="application/rss+xml" title="倾旋的博客" href="http://localhost:4000/feed.xml" />
  <link href="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/css/lightbox.min.css" rel="stylesheet">
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/">倾旋的博客</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/category/">Category</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">一个暂时没有名字的项目</h1>
    <p class="post-meta">Oct 23, 2017</p>
  </header>

  <article class="post-content">
    <p>一个暂时没有名字的项目
<!--more--></p>
<h2 id="0x00-简介">0x00 简介</h2>

<p>
<video src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/video/psql.mp4" controls="controls" width="500px">
哎呀~ 换个浏览器试试吧！
</video>
</p>

<h2 id="0x02-编译环境---linux-平台">0x02 编译环境 - Linux 平台</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/jtv/libpqxx.git <span class="c"># clone软件包</span>
apt-get install pkg-config
apt-get install make <span class="c"># 安装make</span>
apt-get install g++ <span class="c"># 安装g++编译器</span>
apt-get install libpq-dev
<span class="nb">cd </span>libpqxx
./configure
make
make install
</code></pre></div></div>

<p>libpqxx 是用来给其他C/C++程序提供连接、操作postgresql的库。</p>

<p>目录结构：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>├── CMakeLists.txt
├── Command.cpp
├── Command.h
├── Postgres.cpp
├── Postgres.h
├── cmake-build-debug
├── main.cpp
├── psql
└── psql.dSYM
</code></pre></div></div>

<h2 id="0x03-编译">0x03 编译</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>g++ main.cpp Postgres.cpp Command.cpp <span class="nt">-o</span> psql <span class="nt">-lpqxx</span> <span class="nt">-lpq</span> <span class="nt">-lpthread</span> <span class="nt">-std</span><span class="o">=</span>c++11 <span class="nt">-g</span>
</code></pre></div></div>

<h2 id="0x04-使用">0x04 使用</h2>

<p>使用方法已经在视频中了，后来我在慢慢完善数据库结构</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>liyingzhes-MBP:psql liyingzhe<span class="nv">$ </span>./psql
Connected Success <span class="o">!</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span>Console <span class="o">&gt;</span>list
<span class="o">[</span>-]Please input list <span class="o">[</span>&lt;Target&gt;&lt;Request&gt;&lt;Detection&gt;&lt;Techniques&gt;&lt;Injection&gt;&lt;Optimization&gt;&lt;Fingerprint&gt;&lt;Enumeration&gt;]
<span class="o">[</span><span class="k">*</span><span class="o">]</span>Console <span class="o">&gt;</span>list Target
opt_name    	           opt_value   	           explain     	           
direct      	                       	           Direct connection to the database.	           
logFile     	                       	           Parse targets from Burp or WebScarab logs	           
bulkFile    	                       	           Scan multiple targets enlisted <span class="k">in </span>a given textual file	           
requestFile 	                       	           Load HTTP request from a fil           
googleDork  	                       	           Rather than providing a target URL, <span class="nb">let </span>Google <span class="k">return </span>target	           
sitemapUrl  	                       	           Parse target<span class="o">(</span>s<span class="o">)</span> from remote sitemap<span class="o">(</span>.xml<span class="o">)</span> file.	           
url         	           http://127.0.0.1:8081/vulnerabilities/test.php?id<span class="o">=</span>2	           Target URL. 	           
<span class="nt">----------</span>
Rows : 7
<span class="o">[</span><span class="k">*</span><span class="o">]</span>Console <span class="o">&gt;</span>
</code></pre></div></div>

<p>list 中的每一个可选项对应一个数据表，用来保存我们设置的值。</p>

<p>该程序只要执行 exploit/run 即可进行攻击</p>

<h2 id="0x05-展望">0x05 展望</h2>

<p>由于Metasploit采用的数据库就是postgresql，笔者只研究了一段时间，然后用Python写了一个快速搜索msf模块的脚本，发现对于效率提升了很多，另外不需要开启msfconsole，它的加载速度太慢了。</p>

<p>程序中有很多东西都写死了，完全可以加到数据库的配置中，这样会更加灵活</p>

<p># 勿喷，要脸 —— 倾旋</p>

<p>只要花时间研究数据库结构，我想是可以集成更多的工具。 将它部署在Kali这种平台下，减少工作量，提高渗透效率。</p>

<p>附：数据库是个好东西</p>

<h2 id="0x06-忠告">0x06 忠告</h2>

<p>这个项目我只是突发奇想，锻炼自己的C++功底，创造自己所想的，程序中可能会出现SQL注入之类的问题，别跟我扯什么高大上的安全问题，我做我想做的，不会在意被人怎么看。</p>

<h2 id="0x07-源代码">0x07 源代码</h2>

<blockquote>
  <p>main.cpp</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;iostream&gt;
#include &lt;pqxx/pqxx&gt;
#include &lt;iomanip&gt;
#include "Postgres.h"
#include &lt;vector&gt;
#include "Command.h"
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">Postgres</span> <span class="n">postSqler</span><span class="p">;</span>
    <span class="n">CommandHelper</span> <span class="o">*</span> <span class="n">Command</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CommandHelper</span><span class="p">;</span>
    <span class="c1">// std::string listOpt[] = {"Target","Request"};
</span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">listOpt</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"Target"</span><span class="p">,</span><span class="s">"Request"</span><span class="p">,</span><span class="s">"Detection"</span><span class="p">,</span><span class="s">"Techniques"</span><span class="p">,</span><span class="s">"Injection"</span><span class="p">,</span><span class="s">"Optimization"</span><span class="p">,</span><span class="s">"Fingerprint"</span><span class="p">,</span><span class="s">"Enumeration"</span><span class="p">};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">sqlmap</span> <span class="o">=</span> <span class="s">"sqlmap -c "</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">filename</span> <span class="o">=</span> <span class="s">"/Users/liyingzhe/Downloads/a.txt"</span><span class="p">;</span>
    <span class="k">try</span><span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">globalCommand</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"sql"</span><span class="p">,</span><span class="s">"list"</span><span class="p">,</span><span class="s">"set"</span><span class="p">,</span><span class="s">"exploit"</span><span class="p">,</span><span class="s">"run"</span><span class="p">,</span><span class="s">"show"</span><span class="p">,</span><span class="s">"info"</span><span class="p">,</span><span class="s">"help"</span><span class="p">};</span>
        <span class="n">pqxx</span><span class="o">::</span><span class="n">connection</span> <span class="n">Link</span><span class="p">(</span><span class="s">"dbname=testdb user=liyingzhe password=kali1997 hostaddr=127.0.0.1 port=5432"</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">Link</span><span class="p">.</span><span class="n">is_open</span><span class="p">()){</span>
            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Connected Success !"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">char</span>  <span class="n">line</span><span class="p">[</span><span class="mi">300</span><span class="p">];</span>
        <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span>
            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[*]Console &gt;"</span><span class="p">;</span>
            <span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">.</span><span class="n">getline</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">299</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">//std::cout &lt;&lt; "length : "  &lt;&lt; strlen(line) &lt;&lt; std::endl;
</span>            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">Commandlines</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">getCommandStr</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
            <span class="c1">//std::cout &lt;&lt; "length : "  &lt;&lt; strlen(line) &lt;&lt; std::endl;
</span>            <span class="k">if</span><span class="p">(</span><span class="n">Commandlines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">"sql"</span><span class="p">){</span>
                <span class="k">if</span><span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">Sql</span><span class="p">(</span><span class="n">Commandlines</span><span class="p">,</span><span class="n">postSqler</span><span class="p">,</span><span class="n">Link</span><span class="p">)){</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[-]sql &lt;SQL Query&gt;"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">Commandlines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">"list"</span><span class="p">){</span>
                <span class="k">if</span><span class="p">(</span><span class="n">Commandlines</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="o">!</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">findVectorSet</span><span class="p">(</span><span class="n">listOpt</span><span class="p">,</span><span class="n">Commandlines</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">listOpt</span><span class="p">))){</span>
                    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[-]Please input list ["</span><span class="p">;</span>
                    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">p</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">listOpt</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">));</span><span class="n">p</span><span class="o">++</span><span class="p">){</span>
                        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"&lt;"</span> <span class="o">&lt;&lt;</span> <span class="n">listOpt</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">"&gt;"</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"]"</span> <span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"SELECT opt_name,opt_value,explain FROM "</span> <span class="o">+</span> <span class="n">Commandlines</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Exec</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">postSqler</span><span class="p">,</span><span class="n">Link</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">Commandlines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">"exit"</span><span class="p">){</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">Commandlines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">"set"</span><span class="p">){</span>
                <span class="n">Command</span><span class="o">-&gt;</span><span class="n">SetVal</span><span class="p">(</span><span class="n">Commandlines</span><span class="p">,</span><span class="n">postSqler</span><span class="p">,</span><span class="n">Link</span><span class="p">);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">Commandlines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">"info"</span><span class="p">){</span>
                <span class="k">if</span><span class="p">(</span><span class="n">Commandlines</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="o">!</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">findVectorSet</span><span class="p">(</span><span class="n">listOpt</span><span class="p">,</span><span class="n">Commandlines</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">listOpt</span><span class="p">))){</span>
                    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[-]Please input info ["</span><span class="p">;</span>
                    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">p</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">listOpt</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">));</span><span class="n">p</span><span class="o">++</span><span class="p">){</span>
                        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"&lt;"</span> <span class="o">&lt;&lt;</span> <span class="n">listOpt</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">"&gt;"</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"] &lt;opt_name&gt;"</span> <span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"SELECT * FROM "</span> <span class="o">+</span> <span class="n">Commandlines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">" WHERE opt_name = '"</span> <span class="o">+</span> <span class="n">Commandlines</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s">"'"</span><span class="p">;</span>
                <span class="c1">// std::cout &lt;&lt; sql &lt;&lt;std::endl;
</span>                <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Exec</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">postSqler</span><span class="p">,</span><span class="n">Link</span><span class="p">);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">Commandlines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">"save"</span><span class="p">){</span>

                <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Save</span><span class="p">(</span><span class="n">listOpt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">listOpt</span><span class="p">)</span><span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">),</span><span class="n">postSqler</span><span class="p">,</span><span class="n">Link</span><span class="p">,</span><span class="n">filename</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">Commandlines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">"unset"</span><span class="p">){</span>
                <span class="n">Command</span><span class="o">-&gt;</span><span class="n">UnSetVal</span><span class="p">(</span><span class="n">Commandlines</span><span class="p">,</span><span class="n">postSqler</span><span class="p">,</span><span class="n">Link</span><span class="p">);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">Commandlines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">"exploit"</span> <span class="o">||</span> <span class="n">Commandlines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">"run"</span><span class="p">){</span>
                <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Save</span><span class="p">(</span><span class="n">listOpt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">listOpt</span><span class="p">)</span><span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">),</span><span class="n">postSqler</span><span class="p">,</span><span class="n">Link</span><span class="p">,</span><span class="n">filename</span><span class="p">);</span>
                <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Exploit</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">sqlmap</span><span class="p">);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">Commandlines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">"help"</span><span class="p">){</span>
                <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Usage :"</span>
                          <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span>
                          <span class="o">&lt;&lt;</span><span class="s">"list &lt;table name&gt;"</span><span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span>
                          <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\t</span><span class="s"> 查看局部配置项"</span>
                          <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span>
                          <span class="o">&lt;&lt;</span><span class="s">"set  &lt;table name&gt; &lt;opt_name&gt; &lt;opt_value&gt;"</span>
                          <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\t</span><span class="s"> 设置配置项"</span>
                          <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span>
                          <span class="o">&lt;&lt;</span> <span class="s">"info &lt;table name&gt; &lt;opt_name&gt;"</span>
                          <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\t</span><span class="s"> 查看单独配置项"</span>
                          <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span>
                          <span class="o">&lt;&lt;</span> <span class="s">"exploit"</span>
                          <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\t</span><span class="s"> 运行"</span>
                          <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">){</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">delete</span> <span class="n">Command</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>Command.h</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">//
// Created by liyingzhe on 20/10/17.
//
</span><span class="cp">#include &lt;vector&gt;
#include &lt;iostream&gt;
#include &lt;string&gt;
#ifndef PSQL_COMMAND_H
#include "Postgres.h"
#define PSQL_COMMAND_H
#include &lt;pqxx/pqxx&gt;
</span><span class="k">class</span> <span class="nc">CommandHelper</span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="c1">//CommandHelper();
</span>    <span class="c1">//~CommandHelper();
</span>    <span class="cm">/**
     * 获取命令
     * @param line   命令行
     * @param cutStr 分割字符
     * @return
     */</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">getCommandStr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">line</span><span class="p">);</span>
    <span class="cm">/**
     * 判断元素是否存在vector
     * @param VecArray
     * @param strArr
     * @return
     */</span>
    <span class="kt">bool</span> <span class="n">findVectorSet</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">strArr</span><span class="p">[],</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">Str</span><span class="p">,</span><span class="kt">int</span> <span class="n">strArrSize</span><span class="p">);</span>

    <span class="cm">/**
     * SQL命令：执行SQL语句
     * @param CommandArray
     * @param postSqler
     * @param Link
     * @return
     */</span>
    <span class="kt">bool</span> <span class="n">Sql</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">CommandArray</span><span class="p">,</span><span class="n">Postgres</span> <span class="n">postSqler</span><span class="p">,</span><span class="n">pqxx</span><span class="o">::</span><span class="n">connection</span> <span class="o">&amp;</span><span class="n">Link</span><span class="p">);</span>

    <span class="cm">/**
     * 执行SQL 且输出结果
     * @param sql
     * @param postSqler
     * @param Link
     * @return
     */</span>
    <span class="kt">bool</span> <span class="n">Exec</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">sql</span><span class="p">,</span><span class="n">Postgres</span> <span class="n">postSqler</span><span class="p">,</span><span class="n">pqxx</span><span class="o">::</span><span class="n">connection</span> <span class="o">&amp;</span><span class="n">Link</span><span class="p">);</span>

    <span class="cm">/**
     * 更改属性值
     * @param Commandline
     * @param postgres
     * @param Link
     * @return
     */</span>
    <span class="kt">bool</span> <span class="n">SetVal</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">Commandline</span><span class="p">,</span><span class="n">Postgres</span> <span class="n">postgres</span><span class="p">,</span><span class="n">pqxx</span><span class="o">::</span><span class="n">connection</span> <span class="o">&amp;</span><span class="n">Link</span><span class="p">);</span>

    <span class="cm">/**
     * 保存配置
     * @param tableList
     * @param tableLength
     * @param postgres
     * @param Link
     * @param filename
     * @return
     */</span>
    <span class="kt">bool</span> <span class="n">Save</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">tableList</span><span class="p">[],</span><span class="kt">int</span> <span class="n">tableLength</span><span class="p">,</span><span class="n">Postgres</span> <span class="n">postgres</span><span class="p">,</span><span class="n">pqxx</span><span class="o">::</span><span class="n">connection</span> <span class="o">&amp;</span><span class="n">Link</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">filename</span><span class="p">);</span>
    <span class="cm">/**
     * 清空属性
     * @param Commandline
     * @param postgres
     * @param Link
     * @return
     */</span>
    <span class="kt">bool</span> <span class="n">UnSetVal</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">Commandline</span><span class="p">,</span><span class="n">Postgres</span> <span class="n">postgres</span><span class="p">,</span><span class="n">pqxx</span><span class="o">::</span><span class="n">connection</span> <span class="o">&amp;</span><span class="n">Link</span><span class="p">);</span>

    <span class="cm">/**
     * 执行
     * @param filename
     * @param command
     * @return
     */</span>
    <span class="kt">bool</span> <span class="n">Exploit</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">filename</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">command</span><span class="p">);</span>
<span class="p">};</span>
<span class="cp">#endif //PSQL_COMMAND_H
</span>
</code></pre></div></div>

<blockquote>
  <p>Command.cpp</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//
// Created by liyingzhe on 20/10/17.
//
</span>
<span class="cp">#include "Command.h"
#include &lt;pqxx/pqxx&gt;
#include "Postgres.h"
#include &lt;fstream&gt;
#include &lt;stdio.h&gt;
</span><span class="kt">bool</span> <span class="n">CommandHelper</span><span class="o">::</span><span class="n">findVectorSet</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">strArr</span><span class="p">[],</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">Str</span><span class="p">,</span><span class="kt">int</span> <span class="n">strArrSize</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">strArrSize</span> <span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="n">strArr</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="n">Str</span><span class="p">){</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">CommandHelper</span><span class="o">::</span><span class="n">getCommandStr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">CommandResult</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">token</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="s">" "</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span><span class="n">token</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">x</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
        <span class="n">CommandResult</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="s">" "</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">CommandResult</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">bool</span> <span class="n">CommandHelper</span><span class="o">::</span><span class="n">Sql</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">CommandArray</span><span class="p">,</span> <span class="n">Postgres</span> <span class="n">postSqler</span><span class="p">,</span> <span class="n">pqxx</span><span class="o">::</span><span class="n">connection</span> <span class="o">&amp;</span><span class="n">Link</span><span class="p">){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">sqlQuery</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">x</span><span class="o">&lt;</span><span class="n">CommandArray</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">x</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span> <span class="k">continue</span><span class="p">;}</span>
        <span class="n">sqlQuery</span> <span class="o">+=</span> <span class="n">CommandArray</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s">" "</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">CommandHelper</span><span class="o">::</span><span class="n">Exec</span><span class="p">(</span><span class="n">sqlQuery</span><span class="p">,</span><span class="n">postSqler</span><span class="p">,</span><span class="n">Link</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">CommandHelper</span><span class="o">::</span><span class="n">Exec</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">sql</span><span class="p">,</span> <span class="n">Postgres</span> <span class="n">postSqler</span><span class="p">,</span> <span class="n">pqxx</span><span class="o">::</span><span class="n">connection</span> <span class="o">&amp;</span><span class="n">Link</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span><span class="p">{</span>
        <span class="n">pqxx</span><span class="o">::</span><span class="n">result</span> <span class="n">res</span> <span class="o">=</span> <span class="n">postSqler</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">sql</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="n">Link</span><span class="p">);</span>
        <span class="n">postSqler</span><span class="p">.</span><span class="n">Print</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
    <span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">CommandHelper</span><span class="o">::</span><span class="n">SetVal</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">Commandlines</span><span class="p">,</span> <span class="n">Postgres</span> <span class="n">postgres</span><span class="p">,</span> <span class="n">pqxx</span><span class="o">::</span><span class="n">connection</span> <span class="o">&amp;</span><span class="n">Link</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">Commandlines</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">){</span>
        <span class="c1">// set target url value
</span>        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[-]set &lt;table name&gt; &lt;opt_name&gt; &lt;opt_value&gt;"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"UPDATE "</span> <span class="o">+</span> <span class="n">Commandlines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">" SET opt_value = '"</span> <span class="o">+</span> <span class="n">Commandlines</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s">"' where opt_name = '"</span> <span class="o">+</span> <span class="n">Commandlines</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span><span class="s">"'"</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">CommandHelper</span><span class="o">::</span><span class="n">Exec</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">postgres</span><span class="p">,</span><span class="n">Link</span><span class="p">)){</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">CommandHelper</span><span class="o">::</span><span class="n">Save</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">tableList</span><span class="p">[],</span><span class="kt">int</span> <span class="n">tableLength</span><span class="p">,</span><span class="n">Postgres</span> <span class="n">postgres</span><span class="p">,</span><span class="n">pqxx</span><span class="o">::</span><span class="n">connection</span> <span class="o">&amp;</span><span class="n">Link</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">filename</span><span class="p">){</span>
    <span class="k">try</span><span class="p">{</span>
        <span class="c1">// std::ofstream
</span>        <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span> <span class="n">Out</span><span class="p">(</span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">Out</span><span class="p">.</span><span class="n">is_open</span><span class="p">()){</span>
            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[-]Error Opened file ..."</span> <span class="o">&lt;&lt;</span> <span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">tableLength</span> <span class="o">&amp;&amp;</span> <span class="n">Out</span><span class="p">.</span><span class="n">is_open</span><span class="p">();</span> <span class="n">y</span><span class="o">++</span><span class="p">){</span>
            <span class="n">Out</span> <span class="o">&lt;&lt;</span> <span class="s">"["</span> <span class="o">+</span> <span class="n">tableList</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span><span class="s">"]"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
            <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"SELECT opt_name,opt_value FROM "</span> <span class="o">+</span> <span class="n">tableList</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span><span class="s">" WHERE State = true"</span><span class="p">;</span>
            <span class="n">pqxx</span><span class="o">::</span><span class="n">result</span> <span class="n">res</span> <span class="o">=</span> <span class="n">postgres</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">sql</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="n">Link</span><span class="p">);</span>
            <span class="k">for</span><span class="p">(</span><span class="n">pqxx</span><span class="o">::</span><span class="n">result</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">c</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">res</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Out</span> <span class="o">&lt;&lt;</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">c_str</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">" = "</span> <span class="o">&lt;&lt;</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">c_str</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">Out</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">){</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kt">bool</span> <span class="n">CommandHelper</span><span class="o">::</span><span class="n">UnSetVal</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">Commandlines</span><span class="p">,</span> <span class="n">Postgres</span> <span class="n">postgres</span><span class="p">,</span> <span class="n">pqxx</span><span class="o">::</span><span class="n">connection</span> <span class="o">&amp;</span><span class="n">Link</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">Commandlines</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">){</span>
        <span class="c1">// set target url value
</span>        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"[-]unset &lt;table name&gt; &lt;opt_name&gt;"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"UPDATE "</span> <span class="o">+</span> <span class="n">Commandlines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">" SET opt_value = '' where opt_name = '"</span> <span class="o">+</span> <span class="n">Commandlines</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span><span class="s">"'"</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">CommandHelper</span><span class="o">::</span><span class="n">Exec</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">postgres</span><span class="p">,</span><span class="n">Link</span><span class="p">)){</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">bool</span> <span class="n">CommandHelper</span><span class="o">::</span><span class="n">Exploit</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">filename</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">command</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">command</span> <span class="o">+=</span>  <span class="n">filename</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
    <span class="kt">FILE</span> <span class="o">*</span> <span class="n">FP</span> <span class="o">=</span> <span class="n">popen</span><span class="p">(</span><span class="n">command</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="s">"r"</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="n">FP</span><span class="p">)){</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">line</span> <span class="p">;</span>
    <span class="p">}</span>
    <span class="n">pclose</span><span class="p">(</span><span class="n">FP</span><span class="p">);</span>
    <span class="k">return</span>  <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<blockquote>
  <p>Postgres.h</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;pqxx/pqxx&gt;
#include &lt;iostream&gt;
#include &lt;iomanip&gt;
#include &lt;pqxx/result&gt;
#ifndef PSQL_POSTGRES_H
#define PSQL_POSTGRES_H
</span><span class="k">class</span> <span class="nc">Postgres</span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="c1">// 初始化方法
</span>    <span class="c1">//void Connect(const char * connection_string,pqxx::connection &amp;C);
</span>    <span class="cm">/**
     * 查询并返回结果
     * @param sql 
     * @param C 
     * @return 
     */</span>
    <span class="n">pqxx</span><span class="o">::</span><span class="n">result</span> <span class="n">Select</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">sql</span><span class="p">,</span><span class="n">pqxx</span><span class="o">::</span><span class="n">connection</span> <span class="o">&amp;</span><span class="n">C</span><span class="p">);</span>
    <span class="cm">/**
     * 执行插入操作
     * @param sql 
     * @param C 
     * @return 
     */</span>
    <span class="n">pqxx</span><span class="o">::</span><span class="n">result</span> <span class="n">Insert</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">sql</span><span class="p">,</span><span class="n">pqxx</span><span class="o">::</span><span class="n">connection</span> <span class="o">&amp;</span><span class="n">C</span><span class="p">);</span>
    <span class="cm">/**
     * 打印查询结果
     * @param res 
     */</span>
    <span class="kt">void</span> <span class="n">Print</span><span class="p">(</span><span class="n">pqxx</span><span class="o">::</span><span class="n">result</span> <span class="n">res</span><span class="p">);</span>
    <span class="c1">//~Postgres(pqxx::connection C);
</span><span class="p">};</span>
<span class="cp">#endif //PSQL_POSTGRES_H
</span></code></pre></div></div>

<blockquote>
  <p>Postgres.cpp</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;pqxx/pqxx&gt;
#include &lt;iostream&gt;
#include "Postgres.h"
#include &lt;iomanip&gt;
#include &lt;pqxx/result&gt;
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">pqxx</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="c1">//    void Postgres::Connect(const char *connection_string,pqxx::connection &amp;C){
//      try{
//
//          C.(connection_string);
//          if(C.is_open()) {
//              std::cout &lt;&lt;"[*]Connection success "&lt;&lt; std::endl;
//          }
//      }catch (std::exception &amp;e){
//          std::cerr &lt;&lt; e.what() &lt;&lt; endl;
//          exit(-1);
//      }
//  }
</span><span class="n">pqxx</span><span class="o">::</span><span class="n">result</span> <span class="n">Postgres</span><span class="o">::</span><span class="n">Insert</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">sql</span><span class="p">,</span><span class="n">pqxx</span><span class="o">::</span><span class="n">connection</span> <span class="o">&amp;</span><span class="n">C</span><span class="p">){</span>
    <span class="n">pqxx</span><span class="o">::</span><span class="n">work</span> <span class="n">W</span><span class="p">(</span><span class="n">C</span><span class="p">);</span>
    <span class="n">pqxx</span><span class="o">::</span><span class="n">result</span> <span class="n">res</span> <span class="o">=</span> <span class="n">W</span><span class="p">.</span><span class="n">exec</span><span class="p">(</span><span class="n">sql</span><span class="p">);</span>
    <span class="n">W</span><span class="p">.</span><span class="n">commit</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>



    <span class="n">pqxx</span><span class="o">::</span><span class="n">result</span> <span class="n">Postgres</span><span class="o">::</span><span class="n">Select</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">sql</span><span class="p">,</span><span class="n">pqxx</span><span class="o">::</span><span class="n">connection</span> <span class="o">&amp;</span><span class="n">C</span><span class="p">){</span>
        <span class="n">pqxx</span><span class="o">::</span><span class="n">work</span> <span class="n">W</span><span class="p">(</span><span class="n">C</span><span class="p">);</span>
        <span class="n">pqxx</span><span class="o">::</span><span class="n">result</span> <span class="n">res</span> <span class="o">=</span> <span class="n">W</span><span class="p">.</span><span class="n">exec</span><span class="p">(</span><span class="n">sql</span><span class="p">);</span>
        <span class="n">W</span><span class="p">.</span><span class="n">commit</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">Postgres</span><span class="o">::</span><span class="n">Print</span><span class="p">(</span><span class="n">pqxx</span><span class="o">::</span><span class="n">result</span> <span class="n">res</span><span class="p">){</span>
        <span class="c1">// std::cout &lt;&lt; "columns number :" &lt;&lt; res.columns() &lt;&lt; std::endl; // 字段数目
</span>        <span class="c1">// res.column_name() 字段名称
</span>        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">a</span><span class="o">&lt;</span><span class="n">res</span><span class="p">.</span><span class="n">columns</span><span class="p">();</span><span class="n">a</span><span class="o">++</span><span class="p">){</span>
            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">left</span><span class="p">;</span>
            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">setw</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
                      <span class="o">&lt;&lt;</span> <span class="n">res</span><span class="p">.</span><span class="n">column_name</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                      <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">setw</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\t</span><span class="s">"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="c1">//std::cout &lt;&lt; "ROW :"&lt;&lt;res.affected_rows() &lt;&lt; std::endl;
</span>        <span class="c1">//std::cout &lt;&lt; "id column_table :"&lt;&lt;res.column_table("id") &lt;&lt; std::endl;
</span>        <span class="c1">//std::cout &lt;&lt; "table_column :"&lt;&lt;res.table_column(1) &lt;&lt; std::endl;
</span>        <span class="k">for</span><span class="p">(</span><span class="n">pqxx</span><span class="o">::</span><span class="n">result</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">c</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">res</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//std::cout &lt;&lt; left;
</span>            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">res</span><span class="p">.</span><span class="n">columns</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
                 <span class="n">std</span><span class="o">::</span><span class="n">cout</span>
                 <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">left</span>
                 <span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">setw</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
                 <span class="o">&lt;&lt;</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">c_str</span><span class="p">()</span>
                <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">setw</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\t</span><span class="s">"</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

        <span class="p">}</span>
        <span class="n">string</span> <span class="n">s</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="sc">'-'</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span> <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Rows : "</span>  <span class="o">&lt;&lt;</span> <span class="n">res</span><span class="p">.</span><span class="n">affected_rows</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>数据库结构就先不共享了，看得懂的都应该知道、</p>


  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/images/head.jpeg" alt="倾旋">
  <div class="col-box-title name">倾旋</div>
  <p>安全从业者，爱好安全产品开发，渗透测试，Web漏洞研究</p>
  <p class="contact">
    
    <a href="https://github.com/rvn0xsy">GitHub</a>
    
    
    <a href="javascript:document.write('payloads'+'@'+'aliyun.com');">Email</a>
    
    <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_evernotecn" data-cmd="evernotecn" title="分享到印象笔记"></a><a href="#" class="bds_youdao" data-cmd="youdao" title="分享到有道云笔记"></a><a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a><a href="#" class="bds_copy" data-cmd="copy" title="分享到复制网址"></a><a href="#" class="bds_print" data-cmd="print" title="分享到打印"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","qzone","tsina","bdysc","weixin","sqq","youdao","mail","fbook","twi","linkedin","h163","evernotecn","copy","print"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">Newest Posts</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/archivers/2018-04-20/1">新生活 - 上海，我来了</a></li>
    
      <li><a class="post-link" href="/archivers/2018-04-18/1">服务器启用了不安全的HTTP方法</a></li>
    
      <li><a class="post-link" href="/archivers/2018-04-16/3">点击劫持：X-Frame-Options头丢失</a></li>
    
      <li><a class="post-link" href="/archivers/2018-04-16/2">Slow HTTP DOS</a></li>
    
      <li><a class="post-link" href="/archivers/2018-03-27/1">使用CrackMapExec 进行 NTLM Hash传递攻击</a></li>
    
      <li><a class="post-link" href="/archivers/2018-04-18/2">中间件版本信息泄露</a></li>
    
      <li><a class="post-link" href="/archivers/2018-03-22/1">远程代码执行</a></li>
    
      <li><a class="post-link" href="/archivers/2018-03-21/1">Web安全测试学习手册</a></li>
    
      <li><a class="post-link" href="/archivers/2018-03-20/1">浅谈使用C语言开发服务端漏洞扫描设计</a></li>
    
      <li><a class="post-link" href="/archivers/2018-03-18/1">渗透测试中使用Ubuntu的一些小技巧</a></li>
    
      <li><a class="post-link" href="/archivers/2018-03-16/4">Redis未授权访问简介</a></li>
    
      <li><a class="post-link" href="/archivers/2018-03-16/1">信安从业人员的编程之路</a></li>
    
      <li><a class="post-link" href="/archivers/2018-03-16/2">msfconsole常用命令</a></li>
    
      <li><a class="post-link" href="/archivers/2018-03-16/3">Python命令行:getopt模块详解</a></li>
    
      <li><a class="post-link" href="/archivers/2018-03-11/1">重放Flash上传数据包</a></li>
    
      <li><a class="post-link" href="/archivers/2018-03-05/1">C/C++ 子域名A记录枚举(多线程)</a></li>
    
      <li><a class="post-link" href="/archivers/2018-03-04/1">使用C语言发送伪造源IP的UDP请求及DRDOS拒绝服务攻击原理剖析</a></li>
    
      <li><a class="post-link" href="/archivers/2018-02-28/1">C++/C实现DNS查询</a></li>
    
      <li><a class="post-link" href="/archivers/2018-02-11/1">无聊写个C语言创建Jekyll文章的程序</a></li>
    
      <li><a class="post-link" href="/archivers/2018-02-10/1">DNS协议编程</a></li>
    
      <li><a class="post-link" href="/archivers/2018-02-07/1">关于CVE-2018-6580其他Tips分析</a></li>
    
      <li><a class="post-link" href="/archivers/2018-02-05/1">Fuzzing With FuzzDB to Web Attack</a></li>
    
      <li><a class="post-link" href="/archivers/2018-02-02/1">内网渗透常见端口转发方式</a></li>
    
      <li><a class="post-link" href="/archivers/2018-02-01/1">Metasploit - MS17010通用模块</a></li>
    
      <li><a class="post-link" href="/archivers/2018-01-25/1">从网络扼杀Metasploit木马</a></li>
    
      <li><a class="post-link" href="/archivers/2018-01-23/1">封装好的CURL class 尽情享用</a></li>
    
      <li><a class="post-link" href="/archivers/2018-01-30/1">针对某跨国企业的一次渗透测试-持续</a></li>
    
      <li><a class="post-link" href="/archivers/2018-01-22/1">我的丽江之旅</a></li>
    
      <li><a class="post-link" href="/archivers/2018-01-05/1">Sqlmap tamper 总结</a></li>
    
      <li><a class="post-link" href="/archivers/2017-12-28/1">针对国内一大厂的后渗透 - 持续</a></li>
    
      <li><a class="post-link" href="/archivers/2017-12-06/1">TP-LINK Shell调试后门浅析</a></li>
    
      <li><a class="post-link" href="/archivers/2017-11-22/1">CVE-2017-11882钓鱼攻击</a></li>
    
      <li><a class="post-link" href="/archivers/2017-11-21/1">CVE-2017-11882漏洞复现</a></li>
    
      <li><a class="post-link" href="/archivers/2017-11-19/1">C++ libghttp库</a></li>
    
      <li><a class="post-link" href="/archivers/2017-11-16/1">搭建Mattermost并开启Https</a></li>
    
      <li><a class="post-link" href="/archivers/2017-11-15/1">小型Web安全加固方案</a></li>
    
      <li><a class="post-link" href="/archivers/2017-11-14/1">CTF - 美眉的手机号</a></li>
    
      <li><a class="post-link" href="/archivers/2017-11-13/1">高效-搭建一个Github静态博客</a></li>
    
      <li><a class="post-link" href="/tools/socat">socat 使用手册</a></li>
    
      <li><a class="post-link" href="/archivers/2017-11-09/1">DNS信息搜集工具小结</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">TOC</div>
</div>

        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2018 倾旋
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/js/easybook.js"></script>

<script type="text/javascript" src="http://rvn0xsy.oss-cn-shanghai.aliyuncs.com/js/lightbox-plus-jquery.min.js"></script>
<script type="text/javascript" src="/js/global.js"></script>
</body>
</html>
